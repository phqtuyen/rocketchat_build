{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:file-upload/globalFileRestrictions.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUploadBase.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/proxy.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/requests.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/_configUploadStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/AmazonS3.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/FileSystem.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GoogleStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GridFS.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/Slingshot_DEPRECATED.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/sendFileMessage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/getS3FileUrl.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/AmazonS3/server.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/GoogleStorage/server.js"],"names":["filesize","module","watch","require","default","v","slingShotConfig","authorize","file","userId","Meteor","Error","RocketChat","fileUploadIsValidContentType","type","TAPi18n","__","maxFileSize","settings","get","size","maxSize","allowedFileTypes","Slingshot","fileRestrictions","FileUpload","validateFileUpload","Match","test","rid","String","user","room","models","Rooms","findOneById","directMessageAllow","fileUploadAllowed","authz","canAccessRoom","reason","language","t","key","value","parseInt","e","Settings","packageValue","_","UploadFS","config","defaultStorePermissions","StorePermissions","insert","doc","message_id","indexOf","store","split","pop","update","hasPermission","remove","FileUploadBase","constructor","meta","id","Random","getProgress","getFileName","name","start","callback","handler","Uploader","data","onError","err","onComplete","fileData","pick","url","replace","absoluteUrl","options","onProgress","progress","stop","export","FileUploadClass","fs","stream","mime","Future","sharp","Cookies","cookie","Object","assign","handlers","configureUploadsStore","stores","getStores","defaultUploads","collection","Uploads","model","filter","Filter","onCheck","getPath","_id","onValidate","uploadsOnValidate","onRead","fileId","req","res","requestCanAccessFiles","writeHead","setHeader","encodeURIComponent","defaultAvatars","Avatars","avatarsOnValidate","onFinishUpload","avatarsOnFinishUpload","defaultUserDataFiles","UserDataFiles","tempFilePath","getTempFilePath","height","future","s","rotate","metadata","bindEnvironment","toFormat","format","jpeg","resize","Math","min","width","pipe","background","embed","toBuffer","then","outputBuffer","writeFile","console","error","lstatSync","getCollection","direct","$set","return","wait","resizeImagePreview","addExtensionTo","image","getStore","_store","getReadStream","transformer","max","blur","result","out","toString","tmpFile","fut","identify","orientation","toFile","unlink","rename","catch","Users","oldAvatar","findOneByName","username","deleteFile","updateFileNameById","headers","query","rc_uid","rc_token","findOneByIdAndLoginToken","lookup","ext","extension","RegExp","modelName","storageType","handlerName","getStoreByName","next","end","copy","targetFile","createWriteStream","getModelFromName","delete","deleteById","deleteByName","fileName","streamOrBuffer","cb","getFilter","check","create","token","createToken","Buffer","writeFileSync","call","http","URL","logger","Logger","WebApp","connectHandlers","stack","unshift","route","handle","storesPath","debug","method","parsedUrl","parse","path","pathname","substr","length","regExp","match","exec","findOne","undefined","instanceId","InstanceStatus","instance","extraInformation","host","process","env","INSTANCE_IP","isDocker","port","hostname","originalUrl","proxy","request","proxy_res","use","public","sandstorm","configStore","debounce","log","https","fileUrl","getRedirectURL","storeType","fileRes","removeHeader","AmazonS3Uploads","AmazonS3Avatars","AmazonS3UserDataFiles","configure","Bucket","Acl","AWSAccessKeyId","AWSSecretAccessKey","URLExpiryTimeSpan","Region","SignatureVersion","ForcePathStyle","BucketURL","connection","accessKeyId","secretAccessKey","signatureVersion","s3ForcePathStyle","params","ACL","region","endpoint","FileSystemUploads","filePath","getFilePath","stat","wrapAsync","isFile","uploadedAt","toUTCString","FileSystemAvatars","FileSystemUserDataFiles","createFileSystemStore","GoogleCloudStorageUploads","GoogleCloudStorageAvatars","GoogleCloudStorageUserDataFiles","bucket","accessId","secret","credentials","client_email","private_key","zlib","util","ExtractRange","bytes_read","Transform","inherits","prototype","_transform","chunk","enc","newchunk","slice","push","getByteRange","header","matches","readFromGridFS","storeName","rs","ws","PassThrough","forEach","on","onReadError","emit","accept","transformRead","range","out_of_range","createGzip","createDeflate","copyFromGridFS","collectionName","configureSlingshot","acl","accessKey","secretKey","cdn","bucketUrl","_directives","isEmpty","metaContext","upload","AmazonS3","insertFileInit","createDirective","S3Storage","message","createGoogleStorageDirective","GoogleAccessId","GoogleSecretKey","GoogleStorage","GoogleCloud","methods","roomId","msgData","avatar","Optional","emoji","alias","groupable","Boolean","msg","updateFileComplete","omit","encodeURI","attachment","title","description","title_link","title_link_download","image_url","image_type","image_size","image_dimensions","image_preview","audio_url","audio_type","audio_size","video_url","video_type","video_size","ts","Date","attachments","defer","callbacks","run","protectedFiles","getS3FileUrl","addGroup","add","i18nDescription","values","i18nLabel","section","enableQuery","private","multiline","AmazonS3Store","S3","Store","extend","httpOptions","timeout","agent","classOptions","s3","Key","Expires","getSignedUrl","deleteObject","Range","getObject","createReadStream","getWriteStream","writeStream","event","listener","nextTick","removeListener","putObject","Body","ContentType","ContentDisposition","GoogleStorageStore","gcStorage","gcs","googleCloudStorage","action","responseDisposition","expires","now","gzip","contentType","contentDisposition"],"mappings":"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","file":"/packages/rocketchat_file-upload.js","sourcesContent":["/* globals Slingshot */\n\nimport filesize from 'filesize';\n\nconst slingShotConfig = {\n\tauthorize(file/*, metaContext*/) {\n\t\t//Deny uploads if user is not logged in.\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('login-required', 'Please login before posting files');\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('error-invalid-file-type'));\n\t\t}\n\n\t\tconst maxFileSize = RocketChat.settings.get('FileUpload_MaxFileSize');\n\n\t\tif (maxFileSize >= -1 && maxFileSize < file.size) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('File_exceeds_allowed_size_of_bytes', { size: filesize(maxFileSize) }));\n\t\t}\n\n\t\treturn true;\n\t},\n\tmaxSize: 0,\n\tallowedFileTypes: null\n};\n\nSlingshot.fileRestrictions('rocketchat-uploads', slingShotConfig);\nSlingshot.fileRestrictions('rocketchat-uploads-gs', slingShotConfig);\n","/* globals FileUpload:true */\n/* exported FileUpload */\n\nimport filesize from 'filesize';\n\nlet maxFileSize = 0;\n\nFileUpload = {\n\tvalidateFileUpload(file) {\n\t\tif (!Match.test(file.rid, String)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tconst room = RocketChat.models.Rooms.findOneById(file.rid);\n\t\tconst directMessageAllow = RocketChat.settings.get('FileUpload_Enabled_Direct');\n\t\tconst fileUploadAllowed = RocketChat.settings.get('FileUpload_Enabled');\n\n\t\tif (RocketChat.authz.canAccessRoom(room, user) !== true) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!fileUploadAllowed) {\n\t\t\tconst reason = TAPi18n.__('FileUpload_Disabled', user.language);\n\t\t\tthrow new Meteor.Error('error-file-upload-disabled', reason);\n\t\t}\n\n\t\tif (!directMessageAllow && room.t === 'd') {\n\t\t\tconst reason = TAPi18n.__('File_not_allowed_direct_messages', user.language);\n\t\t\tthrow new Meteor.Error('error-direct-message-file-upload-not-allowed', reason);\n\t\t}\n\n\t\t// -1 maxFileSize means there is no limit\n\t\tif (maxFileSize >= -1 && file.size > maxFileSize) {\n\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t}, user.language);\n\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t}\n\n\t\tif (maxFileSize > 0) {\n\t\t\tif (file.size > maxFileSize) {\n\t\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t\t}, user.language);\n\t\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t\t}\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tconst reason = TAPi18n.__('File_type_is_not_accepted', user.language);\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', reason);\n\t\t}\n\n\t\treturn true;\n\t}\n};\n\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\ttry {\n\t\tmaxFileSize = parseInt(value);\n\t} catch (e) {\n\t\tmaxFileSize = RocketChat.models.Settings.findOneById('FileUpload_MaxFileSize').packageValue;\n\t}\n});\n","/* globals FileUploadBase:true, UploadFS */\n/* exported FileUploadBase */\nimport _ from 'underscore';\n\nUploadFS.config.defaultStorePermissions = new UploadFS.StorePermissions({\n\tinsert(userId, doc) {\n\t\tif (userId) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// allow inserts from slackbridge (message_id = slack-timestamp-milli)\n\t\tif (doc && doc.message_id && doc.message_id.indexOf('slack-') === 0) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// allow inserts to the UserDataFiles store\n\t\tif (doc && doc.store && doc.store.split(':').pop() === 'UserDataFiles') {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\tupdate(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t},\n\tremove(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t}\n});\n\n\nFileUploadBase = class FileUploadBase {\n\tconstructor(store, meta, file) {\n\t\tthis.id = Random.id();\n\t\tthis.meta = meta;\n\t\tthis.file = file;\n\t\tthis.store = store;\n\t}\n\n\tgetProgress() {\n\n\t}\n\n\tgetFileName() {\n\t\treturn this.meta.name;\n\t}\n\n\tstart(callback) {\n\t\tthis.handler = new UploadFS.Uploader({\n\t\t\tstore: this.store,\n\t\t\tdata: this.file,\n\t\t\tfile: this.meta,\n\t\t\tonError: (err) => {\n\t\t\t\treturn callback(err);\n\t\t\t},\n\t\t\tonComplete: (fileData) => {\n\t\t\t\tconst file = _.pick(fileData, '_id', 'type', 'size', 'name', 'identify', 'description');\n\n\t\t\t\tfile.url = fileData.url.replace(Meteor.absoluteUrl(), '/');\n\t\t\t\treturn callback(null, file, this.store.options.name);\n\t\t\t}\n\t\t});\n\n\t\tthis.handler.onProgress = (file, progress) => {\n\t\t\tthis.onProgress(progress);\n\t\t};\n\n\t\treturn this.handler.start();\n\t}\n\n\tonProgress() {}\n\n\tstop() {\n\t\treturn this.handler.stop();\n\t}\n};\n","/* globals UploadFS */\n\nimport fs from 'fs';\nimport stream from 'stream';\nimport mime from 'mime-type/with-db';\nimport Future from 'fibers/future';\nimport sharp from 'sharp';\nimport { Cookies } from 'meteor/ostrio:cookies';\n\nconst cookie = new Cookies();\n\nObject.assign(FileUpload, {\n\thandlers: {},\n\n\tconfigureUploadsStore(store, name, options) {\n\t\tconst type = name.split(':').pop();\n\t\tconst stores = UploadFS.getStores();\n\t\tdelete stores[name];\n\n\t\treturn new UploadFS.store[store](Object.assign({\n\t\t\tname\n\t\t}, options, FileUpload[`default${ type }`]()));\n\t},\n\n\tdefaultUploads() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Uploads.model,\n\t\t\tfilter: new UploadFS.Filter({\n\t\t\t\tonCheck: FileUpload.validateFileUpload\n\t\t\t}),\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/uploads/${ file.rid }/${ file.userId }/${ file._id }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.uploadsOnValidate,\n\t\t\tonRead(fileId, file, req, res) {\n\t\t\t\tif (!FileUpload.requestCanAccessFiles(req)) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tres.setHeader('content-disposition', `attachment; filename=\"${ encodeURIComponent(file.name) }\"`);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\t},\n\n\tdefaultAvatars() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Avatars.model,\n\t\t\t// filter: new UploadFS.Filter({\n\t\t\t// \tonCheck: FileUpload.validateFileUpload\n\t\t\t// }),\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/avatars/${ file.userId }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.avatarsOnValidate,\n\t\t\tonFinishUpload: FileUpload.avatarsOnFinishUpload\n\t\t};\n\t},\n\n\tdefaultUserDataFiles() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.UserDataFiles.model,\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/uploads/userData/${ file.userId }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.uploadsOnValidate,\n\t\t\tonRead(fileId, file, req, res) {\n\t\t\t\tif (!FileUpload.requestCanAccessFiles(req)) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tres.setHeader('content-disposition', `attachment; filename=\"${ encodeURIComponent(file.name) }\"`);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t};\n\t},\n\n\tavatarsOnValidate(file) {\n\t\tif (RocketChat.settings.get('Accounts_AvatarResize') !== true) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tempFilePath = UploadFS.getTempFilePath(file._id);\n\n\t\tconst height = RocketChat.settings.get('Accounts_AvatarSize');\n\t\tconst future = new Future();\n\n\t\tconst s = sharp(tempFilePath);\n\t\ts.rotate();\n\t\t// Get metadata to resize the image the first time to keep \"inside\" the dimensions\n\t\t// then resize again to create the canvas around\n\t\ts.metadata(Meteor.bindEnvironment((err, metadata) => {\n\t\t\ts.toFormat(sharp.format.jpeg)\n\t\t\t\t.resize(Math.min(height, metadata.width), Math.min(height, metadata.height))\n\t\t\t\t.pipe(sharp()\n\t\t\t\t\t.resize(height, height)\n\t\t\t\t\t.background('#FFFFFF')\n\t\t\t\t\t.embed()\n\t\t\t\t)\n\t\t\t\t// Use buffer to get the result in memory then replace the existing file\n\t\t\t\t// There is no option to override a file using this library\n\t\t\t\t.toBuffer()\n\t\t\t\t.then(Meteor.bindEnvironment(outputBuffer => {\n\t\t\t\t\tfs.writeFile(tempFilePath, outputBuffer, Meteor.bindEnvironment(err => {\n\t\t\t\t\t\tif (err != null) {\n\t\t\t\t\t\t\tconsole.error(err);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst size = fs.lstatSync(tempFilePath).size;\n\t\t\t\t\t\tthis.getCollection().direct.update({_id: file._id}, {$set: {size}});\n\t\t\t\t\t\tfuture.return();\n\t\t\t\t\t}));\n\t\t\t\t}));\n\t\t}));\n\n\t\treturn future.wait();\n\t},\n\n\tresizeImagePreview(file) {\n\t\tfile = RocketChat.models.Uploads.findOneById(file._id);\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tconst image = FileUpload.getStore('Uploads')._store.getReadStream(file._id, file);\n\n\t\tconst transformer = sharp()\n\t\t\t.resize(32, 32)\n\t\t\t.max()\n\t\t\t.jpeg()\n\t\t\t.blur();\n\t\tconst result = transformer.toBuffer().then((out) => out.toString('base64'));\n\t\timage.pipe(transformer);\n\t\treturn result;\n\t},\n\n\tuploadsOnValidate(file) {\n\t\tif (!/^image\\/((x-windows-)?bmp|p?jpeg|png)$/.test(file.type)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tmpFile = UploadFS.getTempFilePath(file._id);\n\n\t\tconst fut = new Future();\n\n\t\tconst s = sharp(tmpFile);\n\t\ts.metadata(Meteor.bindEnvironment((err, metadata) => {\n\t\t\tif (err != null) {\n\t\t\t\tconsole.error(err);\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\tconst identify = {\n\t\t\t\tformat: metadata.format,\n\t\t\t\tsize: {\n\t\t\t\t\twidth: metadata.width,\n\t\t\t\t\theight: metadata.height\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tif (metadata.orientation == null) {\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\ts.rotate()\n\t\t\t\t.toFile(`${ tmpFile }.tmp`)\n\t\t\t\t.then(Meteor.bindEnvironment(() => {\n\t\t\t\t\tfs.unlink(tmpFile, Meteor.bindEnvironment(() => {\n\t\t\t\t\t\tfs.rename(`${ tmpFile }.tmp`, tmpFile, Meteor.bindEnvironment(() => {\n\t\t\t\t\t\t\tconst size = fs.lstatSync(tmpFile).size;\n\t\t\t\t\t\t\tthis.getCollection().direct.update({_id: file._id}, {\n\t\t\t\t\t\t\t\t$set: {\n\t\t\t\t\t\t\t\t\tsize,\n\t\t\t\t\t\t\t\t\tidentify\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tfut.return();\n\t\t\t\t\t\t}));\n\t\t\t\t\t}));\n\t\t\t\t})).catch((err) => {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tfut.return();\n\t\t\t\t});\n\t\t}));\n\n\t\treturn fut.wait();\n\t},\n\n\tavatarsOnFinishUpload(file) {\n\t\t// update file record to match user's username\n\t\tconst user = RocketChat.models.Users.findOneById(file.userId);\n\t\tconst oldAvatar = RocketChat.models.Avatars.findOneByName(user.username);\n\t\tif (oldAvatar) {\n\t\t\tRocketChat.models.Avatars.deleteFile(oldAvatar._id);\n\t\t}\n\t\tRocketChat.models.Avatars.updateFileNameById(file._id, user.username);\n\t\t// console.log('upload finished ->', file);\n\t},\n\n\trequestCanAccessFiles({ headers = {}, query = {} }) {\n\t\tif (!RocketChat.settings.get('FileUpload_ProtectFiles')) {\n\t\t\treturn true;\n\t\t}\n\n\t\tlet { rc_uid, rc_token } = query;\n\n\t\tif (!rc_uid && headers.cookie) {\n\t\t\trc_uid = cookie.get('rc_uid', headers.cookie) ;\n\t\t\trc_token = cookie.get('rc_token', headers.cookie);\n\t\t}\n\n\t\tif (!rc_uid || !rc_token || !RocketChat.models.Users.findOneByIdAndLoginToken(rc_uid, rc_token)) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t},\n\n\taddExtensionTo(file) {\n\t\tif (mime.lookup(file.name) === file.type) {\n\t\t\treturn file;\n\t\t}\n\n\t\tconst ext = mime.extension(file.type);\n\t\tif (ext && false === new RegExp(`\\.${ ext }$`, 'i').test(file.name)) {\n\t\t\tfile.name = `${ file.name }.${ ext }`;\n\t\t}\n\n\t\treturn file;\n\t},\n\n\tgetStore(modelName) {\n\t\tconst storageType = RocketChat.settings.get('FileUpload_Storage_Type');\n\t\tconst handlerName = `${ storageType }:${ modelName }`;\n\n\t\treturn this.getStoreByName(handlerName);\n\t},\n\n\tgetStoreByName(handlerName) {\n\t\tif (this.handlers[handlerName] == null) {\n\t\t\tconsole.error(`Upload handler \"${ handlerName }\" does not exists`);\n\t\t}\n\t\treturn this.handlers[handlerName];\n\t},\n\n\tget(file, req, res, next) {\n\t\tconst store = this.getStoreByName(file.store);\n\t\tif (store && store.get) {\n\t\t\treturn store.get(file, req, res, next);\n\t\t}\n\t\tres.writeHead(404);\n\t\tres.end();\n\t},\n\n\tcopy(file, targetFile) {\n\t\tconst store = this.getStoreByName(file.store);\n\t\tconst out = fs.createWriteStream(targetFile);\n\n\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\tif (store.copy) {\n\t\t\tstore.copy(file, out);\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n});\n\nexport class FileUploadClass {\n\tconstructor({ name, model, store, get, insert, getStore, copy }) {\n\t\tthis.name = name;\n\t\tthis.model = model || this.getModelFromName();\n\t\tthis._store = store || UploadFS.getStore(name);\n\t\tthis.get = get;\n\t\tthis.copy = copy;\n\n\t\tif (insert) {\n\t\t\tthis.insert = insert;\n\t\t}\n\n\t\tif (getStore) {\n\t\t\tthis.getStore = getStore;\n\t\t}\n\n\t\tFileUpload.handlers[name] = this;\n\t}\n\n\tgetStore() {\n\t\treturn this._store;\n\t}\n\n\tget store() {\n\t\treturn this.getStore();\n\t}\n\n\tset store(store) {\n\t\tthis._store = store;\n\t}\n\n\tgetModelFromName() {\n\t\treturn RocketChat.models[this.name.split(':')[1]];\n\t}\n\n\tdelete(fileId) {\n\t\tif (this.store && this.store.delete) {\n\t\t\tthis.store.delete(fileId);\n\t\t}\n\n\t\treturn this.model.deleteFile(fileId);\n\t}\n\n\tdeleteById(fileId) {\n\t\tconst file = this.model.findOneById(fileId);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tdeleteByName(fileName) {\n\t\tconst file = this.model.findOneByName(fileName);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tinsert(fileData, streamOrBuffer, cb) {\n\t\tfileData.size = parseInt(fileData.size) || 0;\n\n\t\t// Check if the fileData matches store filter\n\t\tconst filter = this.store.getFilter();\n\t\tif (filter && filter.check) {\n\t\t\tfilter.check(fileData);\n\t\t}\n\n\t\tconst fileId = this.store.create(fileData);\n\t\tconst token = this.store.createToken(fileId);\n\t\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\n\t\ttry {\n\t\t\tif (streamOrBuffer instanceof stream) {\n\t\t\t\tstreamOrBuffer.pipe(fs.createWriteStream(tmpFile));\n\t\t\t} else if (streamOrBuffer instanceof Buffer) {\n\t\t\t\tfs.writeFileSync(tmpFile, streamOrBuffer);\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid file type');\n\t\t\t}\n\n\t\t\tconst file = Meteor.call('ufsComplete', fileId, this.name, token);\n\n\t\t\tif (cb) {\n\t\t\t\tcb(null, file);\n\t\t\t}\n\n\t\t\treturn file;\n\t\t} catch (e) {\n\t\t\tif (cb) {\n\t\t\t\tcb(e);\n\t\t\t} else {\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\t}\n}\n","/* globals UploadFS, InstanceStatus */\n\nimport http from 'http';\nimport URL from 'url';\n\nconst logger = new Logger('UploadProxy');\n\nWebApp.connectHandlers.stack.unshift({\n\troute: '',\n\thandle: Meteor.bindEnvironment(function(req, res, next) {\n\t\t// Quick check to see if request should be catch\n\t\tif (req.url.indexOf(UploadFS.config.storesPath) === -1) {\n\t\t\treturn next();\n\t\t}\n\n\t\tlogger.debug('Upload URL:', req.url);\n\n\t\tif (req.method !== 'POST') {\n\t\t\treturn next();\n\t\t}\n\n\t\t// Remove store path\n\t\tconst parsedUrl = URL.parse(req.url);\n\t\tconst path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\n\n\t\t// Get store\n\t\tconst regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Request is not valid\n\t\tif (match === null) {\n\t\t\tres.writeHead(400);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst store = UploadFS.getStore(match[1]);\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get file\n\t\tconst fileId = match[2];\n\t\tconst file = store.getCollection().findOne({_id: fileId});\n\t\tif (file === undefined) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (file.instanceId === InstanceStatus.id()) {\n\t\t\tlogger.debug('Correct instance');\n\t\t\treturn next();\n\t\t}\n\n\t\t// Proxy to other instance\n\t\tconst instance = InstanceStatus.getCollection().findOne({_id: file.instanceId});\n\n\t\tif (instance == null) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (instance.extraInformation.host === process.env.INSTANCE_IP && RocketChat.isDocker() === false) {\n\t\t\tinstance.extraInformation.host = 'localhost';\n\t\t}\n\n\t\tlogger.debug('Wrong instance, proxing to:', `${ instance.extraInformation.host }:${ instance.extraInformation.port }`);\n\n\t\tconst options = {\n\t\t\thostname: instance.extraInformation.host,\n\t\t\tport: instance.extraInformation.port,\n\t\t\tpath: req.originalUrl,\n\t\t\tmethod: 'POST'\n\t\t};\n\n\t\tconst proxy = http.request(options, function(proxy_res) {\n\t\t\tproxy_res.pipe(res, {\n\t\t\t\tend: true\n\t\t\t});\n\t\t});\n\n\t\treq.pipe(proxy, {\n\t\t\tend: true\n\t\t});\n\t})\n});\n","/* globals FileUpload, WebApp */\n\nWebApp.connectHandlers.use('/file-upload/',\tfunction(req, res, next) {\n\n\tconst match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tconst file = RocketChat.models.Uploads.findOneById(match[1]);\n\n\t\tif (file) {\n\t\t\tif (!Meteor.settings.public.sandstorm && !FileUpload.requestCanAccessFiles(req)) {\n\t\t\t\tres.writeHead(403);\n\t\t\t\treturn res.end();\n\t\t\t}\n\n\t\t\tres.setHeader('Content-Security-Policy', 'default-src \\'none\\'');\n\t\t\treturn FileUpload.get(file, req, res, next);\n\t\t}\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n});\n","/* globals UploadFS */\n\nimport _ from 'underscore';\nimport './AmazonS3.js';\nimport './FileSystem.js';\nimport './GoogleStorage.js';\nimport './GridFS.js';\nimport './Slingshot_DEPRECATED.js';\n\nconst configStore = _.debounce(() => {\n\tconst store = RocketChat.settings.get('FileUpload_Storage_Type');\n\n\tif (store) {\n\t\tconsole.log('Setting default file store to', store);\n\t\tUploadFS.getStores().Avatars = UploadFS.getStore(`${ store }:Avatars`);\n\t\tUploadFS.getStores().Uploads = UploadFS.getStore(`${ store }:Uploads`);\n\t\tUploadFS.getStores().UserDataFiles = UploadFS.getStore(`${ store }:UserDataFiles`);\n\t}\n}, 1000);\n\nRocketChat.settings.get(/^FileUpload_/, configStore);\n","/* globals FileUpload */\n\nimport _ from 'underscore';\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/AmazonS3/server.js';\nimport http from 'http';\nimport https from 'https';\n\nconst get = function(file, req, res) {\n\tconst fileUrl = this.store.getRedirectURL(file);\n\n\tif (fileUrl) {\n\t\tconst storeType = file.store.split(':').pop();\n\t\tif (RocketChat.settings.get(`FileUpload_S3_Proxy_${ storeType }`)) {\n\t\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\t\trequest.get(fileUrl, fileRes => fileRes.pipe(res));\n\t\t} else {\n\t\t\tres.removeHeader('Content-Length');\n\t\t\tres.setHeader('Location', fileUrl);\n\t\t\tres.writeHead(302);\n\t\t\tres.end();\n\t\t}\n\t} else {\n\t\tres.end();\n\t}\n};\n\nconst copy = function(file, out) {\n\tconst fileUrl = this.store.getRedirectURL(file);\n\n\tif (fileUrl) {\n\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\trequest.get(fileUrl, fileRes => fileRes.pipe(out));\n\t} else {\n\t\tout.end();\n\t}\n};\n\nconst AmazonS3Uploads = new FileUploadClass({\n\tname: 'AmazonS3:Uploads',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst AmazonS3Avatars = new FileUploadClass({\n\tname: 'AmazonS3:Avatars',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst AmazonS3UserDataFiles = new FileUploadClass({\n\tname: 'AmazonS3:UserDataFiles',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst Bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst Acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst AWSAccessKeyId = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst AWSSecretAccessKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\tconst Region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst SignatureVersion = RocketChat.settings.get('FileUpload_S3_SignatureVersion');\n\tconst ForcePathStyle = RocketChat.settings.get('FileUpload_S3_ForcePathStyle');\n\t// const CDN = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst BucketURL = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tif (!Bucket || !AWSAccessKeyId || !AWSSecretAccessKey) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\taccessKeyId: AWSAccessKeyId,\n\t\t\tsecretAccessKey: AWSSecretAccessKey,\n\t\t\tsignatureVersion: SignatureVersion,\n\t\t\ts3ForcePathStyle: ForcePathStyle,\n\t\t\tparams: {\n\t\t\t\tBucket,\n\t\t\t\tACL: Acl\n\t\t\t},\n\t\t\tregion: Region\n\t\t},\n\t\tURLExpiryTimeSpan\n\t};\n\n\tif (BucketURL) {\n\t\tconfig.connection.endpoint = BucketURL;\n\t}\n\n\tAmazonS3Uploads.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Uploads.name, config);\n\tAmazonS3Avatars.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Avatars.name, config);\n\tAmazonS3UserDataFiles.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3UserDataFiles.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_S3_/, configure);\n","/* globals FileUpload, UploadFS */\n\nimport _ from 'underscore';\nimport fs from 'fs';\nimport { FileUploadClass } from '../lib/FileUpload';\n\nconst FileSystemUploads = new FileUploadClass({\n\tname: 'FileSystem:Uploads',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t},\n\n\tcopy(file, out) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(out);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tout.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\nconst FileSystemAvatars = new FileUploadClass({\n\tname: 'FileSystem:Avatars',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\nconst FileSystemUserDataFiles = new FileUploadClass({\n\tname: 'FileSystem:UserDataFiles',\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\nconst createFileSystemStore = _.debounce(function() {\n\tconst options = {\n\t\tpath: RocketChat.settings.get('FileUpload_FileSystemPath') //'/tmp/uploads/photos',\n\t};\n\n\tFileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n\tFileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n\tFileSystemUserDataFiles.store = FileUpload.configureUploadsStore('Local', FileSystemUserDataFiles.name, options);\n\n\t// DEPRECATED backwards compatibililty (remove)\n\tUploadFS.getStores()['fileSystem'] = UploadFS.getStores()[FileSystemUploads.name];\n}, 500);\n\nRocketChat.settings.get('FileUpload_FileSystemPath', createFileSystemStore);\n","/* globals FileUpload */\n\nimport _ from 'underscore';\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/GoogleStorage/server.js';\nimport http from 'http';\nimport https from 'https';\n\nconst get = function(file, req, res) {\n\tthis.store.getRedirectURL(file, (err, fileUrl) => {\n\t\tif (err) {\n\t\t\tconsole.error(err);\n\t\t}\n\n\t\tif (fileUrl) {\n\t\t\tconst storeType = file.store.split(':').pop();\n\t\t\tif (RocketChat.settings.get(`FileUpload_GoogleStorage_Proxy_${ storeType }`)) {\n\t\t\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\t\t\trequest.get(fileUrl, fileRes => fileRes.pipe(res));\n\t\t\t} else {\n\t\t\t\tres.removeHeader('Content-Length');\n\t\t\t\tres.setHeader('Location', fileUrl);\n\t\t\t\tres.writeHead(302);\n\t\t\t\tres.end();\n\t\t\t}\n\t\t} else {\n\t\t\tres.end();\n\t\t}\n\t});\n};\n\nconst copy = function(file, out) {\n\tthis.store.getRedirectURL(file, (err, fileUrl) => {\n\t\tif (err) {\n\t\t\tconsole.error(err);\n\t\t}\n\n\t\tif (fileUrl) {\n\t\t\tconst request = /^https:/.test(fileUrl) ? https : http;\n\t\t\trequest.get(fileUrl, fileRes => fileRes.pipe(out));\n\t\t} else {\n\t\t\tout.end();\n\t\t}\n\t});\n};\n\nconst GoogleCloudStorageUploads = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Uploads',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageAvatars = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Avatars',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageUserDataFiles = new FileUploadClass({\n\tname: 'GoogleCloudStorage:UserDataFiles',\n\tget,\n\tcopy\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\n\tif (!bucket || !accessId || !secret) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tcredentials: {\n\t\t\t\tclient_email: accessId,\n\t\t\t\tprivate_key: secret\n\t\t\t}\n\t\t},\n\t\tbucket,\n\t\tURLExpiryTimeSpan\n\t};\n\n\tGoogleCloudStorageUploads.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUploads.name, config);\n\tGoogleCloudStorageAvatars.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageAvatars.name, config);\n\tGoogleCloudStorageUserDataFiles.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUserDataFiles.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, configure);\n","/* globals FileUpload, UploadFS */\nimport stream from 'stream';\nimport zlib from 'zlib';\nimport util from 'util';\n\nimport { FileUploadClass } from '../lib/FileUpload';\n\nconst logger = new Logger('FileUpload');\n\nfunction ExtractRange(options) {\n\tif (!(this instanceof ExtractRange)) {\n\t\treturn new ExtractRange(options);\n\t}\n\n\tthis.start = options.start;\n\tthis.stop = options.stop;\n\tthis.bytes_read = 0;\n\n\tstream.Transform.call(this, options);\n}\nutil.inherits(ExtractRange, stream.Transform);\n\n\nExtractRange.prototype._transform = function(chunk, enc, cb) {\n\tif (this.bytes_read > this.stop) {\n\t\t// done reading\n\t\tthis.end();\n\t} else if (this.bytes_read + chunk.length < this.start) {\n\t\t// this chunk is still before the start byte\n\t} else {\n\t\tlet start;\n\t\tlet stop;\n\n\t\tif (this.start <= this.bytes_read) {\n\t\t\tstart = 0;\n\t\t} else {\n\t\t\tstart = this.start - this.bytes_read;\n\t\t}\n\t\tif ((this.stop - this.bytes_read + 1) < chunk.length) {\n\t\t\tstop = this.stop - this.bytes_read + 1;\n\t\t} else {\n\t\t\tstop = chunk.length;\n\t\t}\n\t\tconst newchunk = chunk.slice(start, stop);\n\t\tthis.push(newchunk);\n\t}\n\tthis.bytes_read += chunk.length;\n\tcb();\n};\n\n\nconst getByteRange = function(header) {\n\tif (header) {\n\t\tconst matches = header.match(/(\\d+)-(\\d+)/);\n\t\tif (matches) {\n\t\t\treturn {\n\t\t\t\tstart: parseInt(matches[1], 10),\n\t\t\t\tstop: parseInt(matches[2], 10)\n\t\t\t};\n\t\t}\n\t}\n\treturn null;\n};\n\n// code from: https://github.com/jalik/jalik-ufs/blob/master/ufs-server.js#L310\nconst readFromGridFS = function(storeName, fileId, file, req, res) {\n\tconst store = UploadFS.getStore(storeName);\n\tconst rs = store.getReadStream(fileId, file);\n\tconst ws = new stream.PassThrough();\n\n\t[rs, ws].forEach(stream => stream.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t}));\n\n\tws.on('close', function() {\n\t\t// Close output stream at the end\n\t\tws.emit('end');\n\t});\n\n\tconst accept = req.headers['accept-encoding'] || '';\n\n\t// Transform stream\n\tstore.transformRead(rs, ws, fileId, file, req);\n\tconst range = getByteRange(req.headers.range);\n\tlet out_of_range = false;\n\tif (range) {\n\t\tout_of_range = (range.start > file.size) || (range.stop <= range.start) || (range.stop > file.size);\n\t}\n\n\t// Compress data using gzip\n\tif (accept.match(/\\bgzip\\b/) && range === null) {\n\t\tres.setHeader('Content-Encoding', 'gzip');\n\t\tres.removeHeader('Content-Length');\n\t\tres.writeHead(200);\n\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t} else if (accept.match(/\\bdeflate\\b/) && range === null) {\n\t\t// Compress data using deflate\n\t\tres.setHeader('Content-Encoding', 'deflate');\n\t\tres.removeHeader('Content-Length');\n\t\tres.writeHead(200);\n\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t} else if (range && out_of_range) {\n\t\t// out of range request, return 416\n\t\tres.removeHeader('Content-Length');\n\t\tres.removeHeader('Content-Type');\n\t\tres.removeHeader('Content-Disposition');\n\t\tres.removeHeader('Last-Modified');\n\t\tres.setHeader('Content-Range', `bytes */${ file.size }`);\n\t\tres.writeHead(416);\n\t\tres.end();\n\t} else if (range) {\n\t\tres.setHeader('Content-Range', `bytes ${ range.start }-${ range.stop }/${ file.size }`);\n\t\tres.removeHeader('Content-Length');\n\t\tres.setHeader('Content-Length', range.stop - range.start + 1);\n\t\tres.writeHead(206);\n\t\tlogger.debug('File upload extracting range');\n\t\tws.pipe(new ExtractRange({ start: range.start, stop: range.stop })).pipe(res);\n\t} else {\n\t\tres.writeHead(200);\n\t\tws.pipe(res);\n\t}\n};\n\nconst copyFromGridFS = function(storeName, fileId, file, out) {\n\tconst store = UploadFS.getStore(storeName);\n\tconst rs = store.getReadStream(fileId, file);\n\n\t[rs, out].forEach(stream => stream.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tout.end();\n\t}));\n\n\trs.pipe(out);\n};\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Uploads', {\n\tcollectionName: 'rocketchat_uploads'\n});\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:UserDataFiles', {\n\tcollectionName: 'rocketchat_userDataFiles'\n});\n\n// DEPRECATED: backwards compatibility (remove)\nUploadFS.getStores()['rocketchat_uploads'] = UploadFS.getStores()['GridFS:Uploads'];\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Avatars', {\n\tcollectionName: 'rocketchat_avatars'\n});\n\n\nnew FileUploadClass({\n\tname: 'GridFS:Uploads',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\tres.setHeader('Content-Type', file.type);\n\t\tres.setHeader('Content-Length', file.size);\n\n\t\treturn readFromGridFS(file.store, file._id, file, req, res);\n\t},\n\n\tcopy(file, out) {\n\t\tcopyFromGridFS(file.store, file._id, file, out);\n\t}\n});\n\nnew FileUploadClass({\n\tname: 'GridFS:UserDataFiles',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\tres.setHeader('Content-Type', file.type);\n\t\tres.setHeader('Content-Length', file.size);\n\n\t\treturn readFromGridFS(file.store, file._id, file, req, res);\n\t},\n\n\tcopy(file, out) {\n\t\tcopyFromGridFS(file.store, file._id, file, out);\n\t}\n});\n\nnew FileUploadClass({\n\tname: 'GridFS:Avatars',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\n\t\treturn readFromGridFS(file.store, file._id, file, req, res);\n\t}\n});\n","/* globals Slingshot, FileUpload */\nimport _ from 'underscore';\n\nconst configureSlingshot = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst accessKey = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst secretKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst cdn = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst bucketUrl = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tdelete Slingshot._directives['rocketchat-uploads'];\n\n\tif (type === 'AmazonS3' && !_.isEmpty(bucket) && !_.isEmpty(accessKey) && !_.isEmpty(secretKey)) {\n\t\tif (Slingshot._directives['rocketchat-uploads']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads'];\n\t\t}\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tAmazonS3: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'AmazonS3:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t},\n\t\t\tAWSAccessKeyId: accessKey,\n\t\t\tAWSSecretAccessKey: secretKey\n\t\t};\n\n\t\tif (!_.isEmpty(acl)) {\n\t\t\tconfig.acl = acl;\n\t\t}\n\n\t\tif (!_.isEmpty(cdn)) {\n\t\t\tconfig.cdn = cdn;\n\t\t}\n\n\t\tif (!_.isEmpty(region)) {\n\t\t\tconfig.region = region;\n\t\t}\n\n\t\tif (!_.isEmpty(bucketUrl)) {\n\t\t\tconfig.bucketUrl = bucketUrl;\n\t\t}\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads', Slingshot.S3Storage, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring S3 ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', configureSlingshot);\nRocketChat.settings.get(/^FileUpload_S3_/, configureSlingshot);\n\n\n\nconst createGoogleStorageDirective = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\n\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\n\tif (type === 'GoogleCloudStorage' && !_.isEmpty(secret) && !_.isEmpty(accessId) && !_.isEmpty(bucket)) {\n\t\tif (Slingshot._directives['rocketchat-uploads-gs']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\t\t}\n\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tGoogleAccessId: accessId,\n\t\t\tGoogleSecretKey: secret,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tGoogleStorage: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'GoogleCloudStorage:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads-gs', Slingshot.GoogleCloud, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring GoogleCloudStorage ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', createGoogleStorageDirective);\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, createGoogleStorageDirective);\n","import _ from 'underscore';\n\nMeteor.methods({\n\tasync 'sendFileMessage'(roomId, store, file, msgData = {}) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', roomId, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tcheck(msgData, {\n\t\t\tavatar: Match.Optional(String),\n\t\t\temoji: Match.Optional(String),\n\t\t\talias: Match.Optional(String),\n\t\t\tgroupable: Match.Optional(Boolean),\n\t\t\tmsg: Match.Optional(String)\n\t\t});\n\n\t\tRocketChat.models.Uploads.updateFileComplete(file._id, Meteor.userId(), _.omit(file, '_id'));\n\n\t\tconst fileUrl = `/file-upload/${ file._id }/${ encodeURI(file.name) }`;\n\n\t\tconst attachment = {\n\t\t\ttitle: file.name,\n\t\t\ttype: 'file',\n\t\t\tdescription: file.description,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t\tattachment.image_preview = await FileUpload.resizeImagePreview(file);\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tlet msg = Object.assign({\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tts: new Date(),\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id,\n\t\t\t\tname: file.name,\n\t\t\t\ttype: file.type\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment]\n\t\t}, msgData);\n\n\t\tmsg = Meteor.call('sendMessage', msg);\n\n\t\tMeteor.defer(() => RocketChat.callbacks.run('afterFileUpload', { user, room, message: msg }));\n\n\t\treturn msg;\n\t}\n});\n","/* globals UploadFS */\n\nlet protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nMeteor.methods({\n\tgetS3FileUrl(fileId) {\n\t\tif (protectedFiles && !Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\t\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\n\t\treturn UploadFS.getStore('AmazonS3:Uploads').getRedirectURL(file);\n\t}\n});\n","RocketChat.settings.addGroup('FileUpload', function() {\n\tthis.add('FileUpload_Enabled', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MaxFileSize', 2097152, {\n\t\ttype: 'int',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MediaTypeWhiteList', 'image/*,audio/*,video/*,application/zip,application/x-rar-compressed,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_MediaTypeWhiteListDescription'\n\t});\n\n\tthis.add('FileUpload_ProtectFiles', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_ProtectFilesDescription'\n\t});\n\n\tthis.add('FileUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'AmazonS3',\n\t\t\ti18nLabel: 'AmazonS3'\n\t\t}, {\n\t\t\tkey: 'GoogleCloudStorage',\n\t\t\ti18nLabel: 'GoogleCloudStorage'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\tpublic: true\n\t});\n\n\tthis.section('Amazon S3', function() {\n\t\tthis.add('FileUpload_S3_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Acl', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSAccessKeyId', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSSecretAccessKey', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_CDN', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Region', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_BucketURL', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'Override_URL_to_which_files_are_uploaded_This_url_also_used_for_downloads_unless_a_CDN_is_given.'\n\t\t});\n\t\tthis.add('FileUpload_S3_SignatureVersion', 'v4', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_ForcePathStyle', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_URLExpiryTimeSpan', 120, {\n\t\t\ttype: 'int',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'FileUpload_S3_URLExpiryTimeSpan_Description'\n\t\t});\n\t\tthis.add('FileUpload_S3_Proxy_Avatars', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Proxy_Uploads', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('Google Cloud Storage', function() {\n\t\tthis.add('FileUpload_GoogleStorage_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_AccessId', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Secret', '', {\n\t\t\ttype: 'string',\n\t\t\tmultiline: true,\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Proxy_Avatars', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Proxy_Uploads', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('File System', function() {\n\t\tthis.add('FileUpload_FileSystemPath', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'FileSystem'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.add('FileUpload_Enabled_Direct', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n});\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport _ from 'underscore';\nimport S3 from 'aws-sdk/clients/s3';\nimport stream from 'stream';\n\n/**\n * AmazonS3 store\n * @param options\n * @constructor\n */\nexport class AmazonS3Store extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\t// Default options\n\t\t// options.secretAccessKey,\n\t\t// options.accessKeyId,\n\t\t// options.region,\n\t\t// options.sslEnabled // optional\n\n\t\toptions = _.extend({\n\t\t\thttpOptions: {\n\t\t\t\ttimeout: 6000,\n\t\t\t\tagent: false\n\t\t\t}\n\t\t}, options);\n\n\t\tsuper(options);\n\n\t\tconst classOptions = options;\n\n\t\tconst s3 = new S3(options.connection);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.AmazonS3) {\n\t\t\t\treturn file.AmazonS3.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.s3) {\n\t\t\t\treturn file.s3.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tExpires: classOptions.URLExpiryTimeSpan\n\t\t\t};\n\n\t\t\treturn s3.getSignedUrl('getObject', params);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.AmazonS3 = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\ts3.deleteObject(params, (err, data) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\tif (options.start && options.end) {\n\t\t\t\tparams.Range = `${ options.start } - ${ options.end }`;\n\t\t\t}\n\n\t\t\treturn s3.getObject(params).createReadStream();\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\tconst writeStream = new stream.PassThrough();\n\t\t\twriteStream.length = file.size;\n\n\t\t\twriteStream.on('newListener', (event, listener) => {\n\t\t\t\tif (event === 'finish') {\n\t\t\t\t\tprocess.nextTick(() => {\n\t\t\t\t\t\twriteStream.removeListener(event, listener);\n\t\t\t\t\t\twriteStream.on('real_finish', listener);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\ts3.putObject({\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tBody: writeStream,\n\t\t\t\tContentType: file.type,\n\t\t\t\tContentDisposition: `inline; filename=\"${ encodeURI(file.name) }\"`\n\n\t\t\t}, (error) => {\n\t\t\t\tif (error) {\n\t\t\t\t\tconsole.error(error);\n\t\t\t\t}\n\n\t\t\t\twriteStream.emit('real_finish');\n\t\t\t});\n\n\t\t\treturn writeStream;\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.AmazonS3 = AmazonS3Store;\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport gcStorage from '@google-cloud/storage';\n\n/**\n * GoogleStorage store\n * @param options\n * @constructor\n */\nexport class GoogleStorageStore extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\tsuper(options);\n\n\t\tconst gcs = gcStorage(options.connection);\n\t\tthis.bucket = gcs.bucket(options.bucket);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.GoogleStorage) {\n\t\t\t\treturn file.GoogleStorage.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.googleCloudStorage) {\n\t\t\t\treturn file.googleCloudStorage.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file, callback) {\n\t\t\tconst params = {\n\t\t\t\taction: 'read',\n\t\t\t\tresponseDisposition: 'inline',\n\t\t\t\texpires: Date.now()+this.options.URLExpiryTimeSpan*1000\n\t\t\t};\n\n\t\t\tthis.bucket.file(this.getPath(file)).getSignedUrl(params, callback);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.GoogleStorage = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tthis.bucket.file(this.getPath(file)).delete(function(err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst config = {};\n\n\t\t\tif (options.start != null) {\n\t\t\t\tconfig.start = options.start;\n\t\t\t}\n\n\t\t\tif (options.end != null) {\n\t\t\t\tconfig.end = options.end;\n\t\t\t}\n\n\t\t\treturn this.bucket.file(this.getPath(file)).createReadStream(config);\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\treturn this.bucket.file(this.getPath(file)).createWriteStream({\n\t\t\t\tgzip: false,\n\t\t\t\tmetadata: {\n\t\t\t\t\tcontentType: file.type,\n\t\t\t\t\tcontentDisposition: `inline; filename=${ file.name }`\n\t\t\t\t\t// metadata: {\n\t\t\t\t\t// \tcustom: 'metadata'\n\t\t\t\t\t// }\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.GoogleStorage = GoogleStorageStore;\n"]}