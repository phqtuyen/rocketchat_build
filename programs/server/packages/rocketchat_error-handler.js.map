{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:error-handler/server/lib/RocketChat.ErrorHandler.js","meteor://ðŸ’»app/packages/rocketchat:error-handler/server/startup/settings.js"],"names":["ErrorHandler","constructor","reporting","rid","lastError","registerHandlers","RocketChat","settings","get","key","value","trim","getRoomId","process","on","Meteor","bindEnvironment","error","trackError","message","stack","self","originalMeteorDebug","_debug","call","apply","arguments","roomName","replace","room","models","Rooms","findOneByName","fields","_id","t","user","Users","findOneById","sendMessage","msg","addGroup","add","type"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAMA,YAAN,CAAmB;AAClBC,gBAAc;AACb,SAAKC,SAAL,GAAiB,KAAjB;AACA,SAAKC,GAAL,GAAW,IAAX;AACA,SAAKC,SAAL,GAAiB,IAAjB;AAEA,SAAKC,gBAAL;AAEAC,eAAWC,QAAX,CAAoBC,GAApB,CAAwB,2BAAxB,EAAqD,CAACC,GAAD,EAAMC,KAAN,KAAgB;AACpE,UAAIA,MAAMC,IAAN,EAAJ,EAAkB;AACjB,aAAKT,SAAL,GAAiB,IAAjB;AACA,aAAKC,GAAL,GAAW,KAAKS,SAAL,CAAeF,KAAf,CAAX;AACA,OAHD,MAGO;AACN,aAAKR,SAAL,GAAiB,KAAjB;AACA,aAAKC,GAAL,GAAW,EAAX;AACA;AACD,KARD;AASA;;AAEDE,qBAAmB;AAClBQ,YAAQC,EAAR,CAAW,mBAAX,EAAgCC,OAAOC,eAAP,CAAwBC,KAAD,IAAW;AACjE,UAAI,CAAC,KAAKf,SAAV,EAAqB;AACpB;AACA;;AACD,WAAKgB,UAAL,CAAgBD,MAAME,OAAtB,EAA+BF,MAAMG,KAArC;AACA,KAL+B,CAAhC;AAOA,UAAMC,OAAO,IAAb;AACA,UAAMC,sBAAsBP,OAAOQ,MAAnC;;AACAR,WAAOQ,MAAP,GAAgB,UAASJ,OAAT,EAAkBC,KAAlB,EAAyB;AACxC,UAAI,CAACC,KAAKnB,SAAV,EAAqB;AACpB,eAAOoB,oBAAoBE,IAApB,CAAyB,IAAzB,EAA+BL,OAA/B,EAAwCC,KAAxC,CAAP;AACA;;AACDC,WAAKH,UAAL,CAAgBC,OAAhB,EAAyBC,KAAzB;AACA,aAAOE,oBAAoBG,KAApB,CAA0B,IAA1B,EAAgCC,SAAhC,CAAP;AACA,KAND;AAOA;;AAEDd,YAAUe,QAAV,EAAoB;AACnBA,eAAWA,SAASC,OAAT,CAAiB,GAAjB,CAAX;AACA,UAAMC,OAAOvB,WAAWwB,MAAX,CAAkBC,KAAlB,CAAwBC,aAAxB,CAAsCL,QAAtC,EAAgD;AAAEM,cAAQ;AAAEC,aAAK,CAAP;AAAUC,WAAG;AAAb;AAAV,KAAhD,CAAb;;AACA,QAAIN,SAASA,KAAKM,CAAL,KAAW,GAAX,IAAkBN,KAAKM,CAAL,KAAW,GAAtC,CAAJ,EAAgD;AAC/C,aAAON,KAAKK,GAAZ;AACA,KAFD,MAEO;AACN,WAAKhC,SAAL,GAAiB,KAAjB;AACA;AACD;;AAEDgB,aAAWC,OAAX,EAAoBC,KAApB,EAA2B;AAC1B,QAAI,KAAKlB,SAAL,IAAkB,KAAKC,GAAvB,IAA8B,KAAKC,SAAL,KAAmBe,OAArD,EAA8D;AAC7D,WAAKf,SAAL,GAAiBe,OAAjB;AACA,YAAMiB,OAAO9B,WAAWwB,MAAX,CAAkBO,KAAlB,CAAwBC,WAAxB,CAAoC,YAApC,CAAb;;AAEA,UAAIlB,KAAJ,EAAW;AACVD,kBAAW,GAAGA,OAAS,aAAaC,KAAO,UAA3C;AACA;;AAEDd,iBAAWiC,WAAX,CAAuBH,IAAvB,EAA6B;AAAEI,aAAKrB;AAAP,OAA7B,EAA+C;AAAEe,aAAK,KAAK/B;AAAZ,OAA/C;AACA;AACD;;AA3DiB;;AA8DnBG,WAAWN,YAAX,GAA0B,IAAIA,YAAJ,EAA1B,C;;;;;;;;;;;AC9DAM,WAAWC,QAAX,CAAoBkC,QAApB,CAA6B,MAA7B,EAAqC,YAAW;AAC/C,OAAKC,GAAL,CAAS,2BAAT,EAAsC,EAAtC,EAA0C;AAAEC,UAAM;AAAR,GAA1C;AACA,CAFD,E","file":"/packages/rocketchat_error-handler.js","sourcesContent":["class ErrorHandler {\n\tconstructor() {\n\t\tthis.reporting = false;\n\t\tthis.rid = null;\n\t\tthis.lastError = null;\n\n\t\tthis.registerHandlers();\n\n\t\tRocketChat.settings.get('Log_Exceptions_to_Channel', (key, value) => {\n\t\t\tif (value.trim()) {\n\t\t\t\tthis.reporting = true;\n\t\t\t\tthis.rid = this.getRoomId(value);\n\t\t\t} else {\n\t\t\t\tthis.reporting = false;\n\t\t\t\tthis.rid = '';\n\t\t\t}\n\t\t});\n\t}\n\n\tregisterHandlers() {\n\t\tprocess.on('uncaughtException', Meteor.bindEnvironment((error) => {\n\t\t\tif (!this.reporting) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.trackError(error.message, error.stack);\n\t\t}));\n\n\t\tconst self = this;\n\t\tconst originalMeteorDebug = Meteor._debug;\n\t\tMeteor._debug = function(message, stack) {\n\t\t\tif (!self.reporting) {\n\t\t\t\treturn originalMeteorDebug.call(this, message, stack);\n\t\t\t}\n\t\t\tself.trackError(message, stack);\n\t\t\treturn originalMeteorDebug.apply(this, arguments);\n\t\t};\n\t}\n\n\tgetRoomId(roomName) {\n\t\troomName = roomName.replace('#');\n\t\tconst room = RocketChat.models.Rooms.findOneByName(roomName, { fields: { _id: 1, t: 1 } });\n\t\tif (room && (room.t === 'c' || room.t === 'p')) {\n\t\t\treturn room._id;\n\t\t} else {\n\t\t\tthis.reporting = false;\n\t\t}\n\t}\n\n\ttrackError(message, stack) {\n\t\tif (this.reporting && this.rid && this.lastError !== message) {\n\t\t\tthis.lastError = message;\n\t\t\tconst user = RocketChat.models.Users.findOneById('rocket.cat');\n\n\t\t\tif (stack) {\n\t\t\t\tmessage = `${ message }\\n\\`\\`\\`\\n${ stack }\\n\\`\\`\\``;\n\t\t\t}\n\n\t\t\tRocketChat.sendMessage(user, { msg: message }, { _id: this.rid });\n\t\t}\n\t}\n}\n\nRocketChat.ErrorHandler = new ErrorHandler;\n","RocketChat.settings.addGroup('Logs', function() {\n\tthis.add('Log_Exceptions_to_Channel', '', { type: 'string' });\n});\n"]}