{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:integrations/lib/rocketchat.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/logger.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/lib/validation.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/lib/triggerHandler.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/models/Integrations.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/models/IntegrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/publications/integrations.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/publications/integrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/addIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/updateIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/incoming/deleteIncomingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/addOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/updateOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/replayOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/outgoing/deleteOutgoingIntegration.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/methods/clearIntegrationHistory.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/api/api.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/triggers.js","meteor://ðŸ’»app/packages/rocketchat:integrations/server/processWebhookMessage.js"],"names":["RocketChat","integrations","outgoingEvents","sendMessage","label","value","use","channel","triggerWords","targetRoom","fileUploaded","roomArchived","roomCreated","roomJoined","roomLeft","userCreated","logger","Logger","sections","incoming","outgoing","_","module","watch","require","default","v","s","scopedChannels","validChannelChars","_verifyRequiredFields","integration","event","Match","test","String","trim","Meteor","Error","function","username","urls","index","url","entries","without","undefined","length","_verifyUserHasPermissionForChannels","userId","channels","includes","authz","hasPermission","record","channelType","substr","models","Rooms","findOne","$or","_id","name","Users","usernames","user","_verifyRetryInformation","retryFailedCalls","retryCount","parseInt","retryDelay","toLowerCase","validateOutgoing","_validateOutgoing","map","split","forEach","word","scriptEnabled","script","babelOptions","Object","assign","Babel","getDefaultOptions","runtime","compact","minified","comments","scriptCompiled","compile","code","scriptError","e","pick","runOnEdits","type","moment","vm","triggerHandler","RocketChatIntegrationHandler","constructor","successResults","compiledScripts","triggers","Integrations","find","observe","added","addIntegration","changed","removeIntegration","removed","debug","isEmpty","concat","trigger","values","isTriggerEnabled","trig","enabled","updateHistory","historyId","step","data","triggerWord","ranPrepareScript","prepareSentMessage","processSentMessage","resultMessage","finished","httpCallData","httpError","httpResult","error","errorStack","history","omit","room","JSON","stringify","IntegrationHistory","update","$set","_createdAt","Date","insert","Random","id","nameOrId","message","impersonateUser","findOneByUsername","user_name","tmpRoom","getRoomByNameOrIdWithOptionToJoin","currentUserId","errorOnEmpty","warn","t","bot","i","defaultValues","alias","avatar","emoji","processWebhookMessage","buildSandbox","store","sandbox","console","Store","set","key","val","get","HTTP","method","options","result","call","keys","filter","k","startsWith","getIntegrationScript","compiledScript","_updatedAt","vmScript","info","createScript","runInNewContext","Script","replace","stack","hasScriptAndMethod","executeScript","params","timeout","eventNameArgumentsToObject","argObject","arguments","arghhh","owner","mapEventArgsToData","channel_id","channel_name","message_id","timestamp","ts","user_id","u","text","msg","editedAt","isEdited","createdAt","executeTriggers","triggersToExecute","push","all_direct_messages","all_public_channels","all_private_groups","__any","triggerToExecute","executeTrigger","executeTriggerUrl","theHistoryId","tries","triggerWordAnywhere","indexOf","token","trigger_word","opts","auth","npmRequestOptions","rejectUnauthorized","settings","strictSSL","headers","request","prepareMessage","statusCode","response","status_code","content","content_raw","scriptResult","waitTime","Math","pow","er","setTimeout","attachments","resultMsg","replay","Messages","findOneById","_Base","findByType","disableByUserId","multi","findByIntegrationId","findByIntegrationIdAndCreatedBy","creatorId","findOneByIntegrationIdAndHistoryId","integrationId","findByEventName","findFailed","removeByIntegrationId","remove","publish","_integrationPublication","ready","_integrationHistoryPublication","limit","sort","methods","addIncomingIntegration","isString","extend","_createdBy","fields","Roles","addUserRoles","updateIncomingIntegration","currentIntegration","_updatedBy","deleteIncomingIntegration","addOutgoingIntegration","updateOutgoingIntegration","replayOutgoingIntegration","deleteOutgoingIntegration","clearIntegrationHistory","Api","Restivus","enableCors","apiPath","payloadKeys","bodyParams","payloadIsWrapped","payload","parse","body","success","decodeURIComponent","Livechat","API","v1","failure","createIntegration","runAsUser","target_url","trigger_words","integrationToRemove","executeIntegrationRest","urlParams","setEncoding","read","hash","_parsedUrl","search","query","queryParams","pathname","path","url_raw","url_params","scriptResponse","addIntegrationRest","removeIntegrationRest","integrationSampleRest","integrationInfoRest","addRoute","authRequired","post","callbackHandler","_callbackHandler","eventType","_wrapperFunction","callbacks","add","priority","LOW","messageObj","mustBeJoined","sentData","roomId","channelValue","joinChannel","tryDirectByUserIdOnly","isArray","log","red","parseUrls","groupable","icon_url","icon_emoji","attachment","messageReturn"],"mappings":"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","file":"/packages/rocketchat_integrations.js","sourcesContent":["RocketChat.integrations = {\n\toutgoingEvents: {\n\t\tsendMessage: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_SendMessage',\n\t\t\tvalue: 'sendMessage',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: true,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\tfileUploaded: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_FileUploaded',\n\t\t\tvalue: 'fileUploaded',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomArchived: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomArchived',\n\t\t\tvalue: 'roomArchived',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomCreated: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomCreated',\n\t\t\tvalue: 'roomCreated',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomJoined: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomJoined',\n\t\t\tvalue: 'roomJoined',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\troomLeft: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_RoomLeft',\n\t\t\tvalue: 'roomLeft',\n\t\t\tuse: {\n\t\t\t\tchannel: true,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: false\n\t\t\t}\n\t\t},\n\t\tuserCreated: {\n\t\t\tlabel: 'Integrations_Outgoing_Type_UserCreated',\n\t\t\tvalue: 'userCreated',\n\t\t\tuse: {\n\t\t\t\tchannel: false,\n\t\t\t\ttriggerWords: false,\n\t\t\t\ttargetRoom: true\n\t\t\t}\n\t\t}\n\t}\n};\n","/* globals logger:true */\n/* exported logger */\n\nlogger = new Logger('Integrations', {\n\tsections: {\n\t\tincoming: 'Incoming WebHook',\n\t\toutgoing: 'Outgoing WebHook'\n\t}\n});\n","/* global Babel */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nconst scopedChannels = ['all_public_channels', 'all_private_groups', 'all_direct_messages'];\nconst validChannelChars = ['@', '#'];\n\nfunction _verifyRequiredFields(integration) {\n\tif (!integration.event || !Match.test(integration.event, String) || integration.event.trim() === '' || !RocketChat.integrations.outgoingEvents[integration.event]) {\n\t\tthrow new Meteor.Error('error-invalid-event-type', 'Invalid event type', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (!integration.username || !Match.test(integration.username, String) || integration.username.trim() === '') {\n\t\tthrow new Meteor.Error('error-invalid-username', 'Invalid username', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.targetRoom && !integration.targetRoom) {\n\t\tthrow new Meteor.Error('error-invalid-targetRoom', 'Invalid Target Room', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tif (!Match.test(integration.urls, [String])) {\n\t\tthrow new Meteor.Error('error-invalid-urls', 'Invalid URLs', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n\n\tfor (const [index, url] of integration.urls.entries()) {\n\t\tif (url.trim() === '') {\n\t\t\tdelete integration.urls[index];\n\t\t}\n\t}\n\n\tintegration.urls = _.without(integration.urls, [undefined]);\n\n\tif (integration.urls.length === 0) {\n\t\tthrow new Meteor.Error('error-invalid-urls', 'Invalid URLs', { function: 'validateOutgoing._verifyRequiredFields' });\n\t}\n}\n\nfunction _verifyUserHasPermissionForChannels(integration, userId, channels) {\n\tfor (let channel of channels) {\n\t\tif (scopedChannels.includes(channel)) {\n\t\t\tif (channel === 'all_public_channels') {\n\t\t\t\t// No special permissions needed to add integration to public channels\n\t\t\t} else if (!RocketChat.authz.hasPermission(userId, 'manage-integrations')) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\t\t} else {\n\t\t\tlet record;\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(userId, 'manage-integrations') && RocketChat.authz.hasPermission(userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing._verifyUserHasPermissionForChannels' });\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction _verifyRetryInformation(integration) {\n\tif (!integration.retryFailedCalls) {\n\t\treturn;\n\t}\n\n\t// Don't allow negative retry counts\n\tintegration.retryCount = integration.retryCount && parseInt(integration.retryCount) > 0 ? parseInt(integration.retryCount) : 4;\n\tintegration.retryDelay = !integration.retryDelay || !integration.retryDelay.trim() ? 'powers-of-ten' : integration.retryDelay.toLowerCase();\n}\n\nRocketChat.integrations.validateOutgoing = function _validateOutgoing(integration, userId) {\n\tif (integration.channel && Match.test(integration.channel, String) && integration.channel.trim() === '') {\n\t\tdelete integration.channel;\n\t}\n\n\t//Moved to it's own function to statisfy the complexity rule\n\t_verifyRequiredFields(integration);\n\n\tlet channels = [];\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.channel) {\n\t\tif (!Match.test(integration.channel, String)) {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { function: 'validateOutgoing' });\n\t\t} else {\n\t\t\tchannels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\t\tfor (const channel of channels) {\n\t\t\t\tif (!validChannelChars.includes(channel[0]) && !scopedChannels.includes(channel.toLowerCase())) {\n\t\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { function: 'validateOutgoing' });\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else if (!RocketChat.authz.hasPermission(userId, 'manage-integrations')) {\n\t\tthrow new Meteor.Error('error-invalid-permissions', 'Invalid permission for required Integration creation.', { function: 'validateOutgoing' });\n\t}\n\n\tif (RocketChat.integrations.outgoingEvents[integration.event].use.triggerWords && integration.triggerWords) {\n\t\tif (!Match.test(integration.triggerWords, [String])) {\n\t\t\tthrow new Meteor.Error('error-invalid-triggerWords', 'Invalid triggerWords', { function: 'validateOutgoing' });\n\t\t}\n\n\t\tintegration.triggerWords.forEach((word, index) => {\n\t\t\tif (!word || word.trim() === '') {\n\t\t\t\tdelete integration.triggerWords[index];\n\t\t\t}\n\t\t});\n\n\t\tintegration.triggerWords = _.without(integration.triggerWords, [undefined]);\n\t} else {\n\t\tdelete integration.triggerWords;\n\t}\n\n\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\ttry {\n\t\t\tconst babelOptions = Object.assign(Babel.getDefaultOptions({ runtime: false }), { compact: true, minified: true, comments: false });\n\n\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\tintegration.scriptError = undefined;\n\t\t} catch (e) {\n\t\t\tintegration.scriptCompiled = undefined;\n\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t}\n\t}\n\n\tif (typeof integration.runOnEdits !== 'undefined') {\n\t\t// Verify this value is only true/false\n\t\tintegration.runOnEdits = integration.runOnEdits === true;\n\t}\n\n\t_verifyUserHasPermissionForChannels(integration, userId, channels);\n\t_verifyRetryInformation(integration);\n\n\tconst user = RocketChat.models.Users.findOne({ username: integration.username });\n\n\tif (!user) {\n\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user (did you delete the `rocket.cat` user?)', { function: 'validateOutgoing' });\n\t}\n\n\tintegration.type = 'webhook-outgoing';\n\tintegration.userId = user._id;\n\tintegration.channel = channels;\n\n\treturn integration;\n};\n","/* global logger, processWebhookMessage */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport moment from 'moment';\nimport vm from 'vm';\n\nRocketChat.integrations.triggerHandler = new class RocketChatIntegrationHandler {\n\tconstructor() {\n\t\tthis.vm = vm;\n\t\tthis.successResults = [200, 201, 202];\n\t\tthis.compiledScripts = {};\n\t\tthis.triggers = {};\n\n\t\tRocketChat.models.Integrations.find({type: 'webhook-outgoing'}).observe({\n\t\t\tadded: (record) => {\n\t\t\t\tthis.addIntegration(record);\n\t\t\t},\n\n\t\t\tchanged: (record) => {\n\t\t\t\tthis.removeIntegration(record);\n\t\t\t\tthis.addIntegration(record);\n\t\t\t},\n\n\t\t\tremoved: (record) => {\n\t\t\t\tthis.removeIntegration(record);\n\t\t\t}\n\t\t});\n\t}\n\n\taddIntegration(record) {\n\t\tlogger.outgoing.debug(`Adding the integration ${ record.name } of the event ${ record.event }!`);\n\t\tlet channels;\n\t\tif (record.event && !RocketChat.integrations.outgoingEvents[record.event].use.channel) {\n\t\t\tlogger.outgoing.debug('The integration doesnt rely on channels.');\n\t\t\t//We don't use any channels, so it's special ;)\n\t\t\tchannels = ['__any'];\n\t\t} else if (_.isEmpty(record.channel)) {\n\t\t\tlogger.outgoing.debug('The integration had an empty channel property, so it is going on all the public channels.');\n\t\t\tchannels = ['all_public_channels'];\n\t\t} else {\n\t\t\tlogger.outgoing.debug('The integration is going on these channels:', record.channel);\n\t\t\tchannels = [].concat(record.channel);\n\t\t}\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!this.triggers[channel]) {\n\t\t\t\tthis.triggers[channel] = {};\n\t\t\t}\n\n\t\t\tthis.triggers[channel][record._id] = record;\n\t\t}\n\t}\n\n\tremoveIntegration(record) {\n\t\tfor (const trigger of Object.values(this.triggers)) {\n\t\t\tdelete trigger[record._id];\n\t\t}\n\t}\n\n\tisTriggerEnabled(trigger) {\n\t\tfor (const trig of Object.values(this.triggers)) {\n\t\t\tif (trig[trigger._id]) {\n\t\t\t\treturn trig[trigger._id].enabled;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tupdateHistory({ historyId, step, integration, event, data, triggerWord, ranPrepareScript, prepareSentMessage, processSentMessage, resultMessage, finished, url, httpCallData, httpError, httpResult, error, errorStack }) {\n\t\tconst history = {\n\t\t\ttype: 'outgoing-webhook',\n\t\t\tstep\n\t\t};\n\n\t\t// Usually is only added on initial insert\n\t\tif (integration) {\n\t\t\thistory.integration = integration;\n\t\t}\n\n\t\t// Usually is only added on initial insert\n\t\tif (event) {\n\t\t\thistory.event = event;\n\t\t}\n\n\t\tif (data) {\n\t\t\thistory.data = { ...data };\n\n\t\t\tif (data.user) {\n\t\t\t\thistory.data.user = _.omit(data.user, ['meta', '$loki', 'services']);\n\t\t\t}\n\n\t\t\tif (data.room) {\n\t\t\t\thistory.data.room = _.omit(data.room, ['meta', '$loki', 'usernames']);\n\t\t\t\thistory.data.room.usernames = ['this_will_be_filled_in_with_usernames_when_replayed'];\n\t\t\t}\n\t\t}\n\n\t\tif (triggerWord) {\n\t\t\thistory.triggerWord = triggerWord;\n\t\t}\n\n\t\tif (typeof ranPrepareScript !== 'undefined') {\n\t\t\thistory.ranPrepareScript = ranPrepareScript;\n\t\t}\n\n\t\tif (prepareSentMessage) {\n\t\t\thistory.prepareSentMessage = prepareSentMessage;\n\t\t}\n\n\t\tif (processSentMessage) {\n\t\t\thistory.processSentMessage = processSentMessage;\n\t\t}\n\n\t\tif (resultMessage) {\n\t\t\thistory.resultMessage = resultMessage;\n\t\t}\n\n\t\tif (typeof finished !== 'undefined') {\n\t\t\thistory.finished = finished;\n\t\t}\n\n\t\tif (url) {\n\t\t\thistory.url = url;\n\t\t}\n\n\t\tif (typeof httpCallData !== 'undefined') {\n\t\t\thistory.httpCallData = httpCallData;\n\t\t}\n\n\t\tif (httpError) {\n\t\t\thistory.httpError = httpError;\n\t\t}\n\n\t\tif (typeof httpResult !== 'undefined') {\n\t\t\thistory.httpResult = JSON.stringify(httpResult, null, 2);\n\t\t}\n\n\t\tif (typeof error !== 'undefined') {\n\t\t\thistory.error = error;\n\t\t}\n\n\t\tif (typeof errorStack !== 'undefined') {\n\t\t\thistory.errorStack = errorStack;\n\t\t}\n\n\t\tif (historyId) {\n\t\t\tRocketChat.models.IntegrationHistory.update({ _id: historyId }, { $set: history });\n\t\t\treturn historyId;\n\t\t} else {\n\t\t\thistory._createdAt = new Date();\n\t\t\treturn RocketChat.models.IntegrationHistory.insert(Object.assign({ _id: Random.id() }, history));\n\t\t}\n\t}\n\n\t//Trigger is the trigger, nameOrId is a string which is used to try and find a room, room is a room, message is a message, and data contains \"user_name\" if trigger.impersonateUser is truthful.\n\tsendMessage({ trigger, nameOrId = '', room, message, data }) {\n\t\tlet user;\n\t\t//Try to find the user who we are impersonating\n\t\tif (trigger.impersonateUser) {\n\t\t\tuser = RocketChat.models.Users.findOneByUsername(data.user_name);\n\t\t}\n\n\t\t//If they don't exist (aka the trigger didn't contain a user) then we set the user based upon the\n\t\t//configured username for the integration since this is required at all times.\n\t\tif (!user) {\n\t\t\tuser = RocketChat.models.Users.findOneByUsername(trigger.username);\n\t\t}\n\n\t\tlet tmpRoom;\n\t\tif (nameOrId || trigger.targetRoom || message.channel) {\n\t\t\ttmpRoom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: nameOrId || message.channel || trigger.targetRoom, errorOnEmpty: false }) || room;\n\t\t} else {\n\t\t\ttmpRoom = room;\n\t\t}\n\n\t\t//If no room could be found, we won't be sending any messages but we'll warn in the logs\n\t\tif (!tmpRoom) {\n\t\t\tlogger.outgoing.warn(`The Integration \"${ trigger.name }\" doesn't have a room configured nor did it provide a room to send the message to.`);\n\t\t\treturn;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Found a room for ${ trigger.name } which is: ${ tmpRoom.name } with a type of ${ tmpRoom.t }`);\n\n\t\tmessage.bot = { i: trigger._id };\n\n\t\tconst defaultValues = {\n\t\t\talias: trigger.alias,\n\t\t\tavatar: trigger.avatar,\n\t\t\temoji: trigger.emoji\n\t\t};\n\n\t\tif (tmpRoom.t === 'd') {\n\t\t\tmessage.channel = `@${ tmpRoom._id }`;\n\t\t} else {\n\t\t\tmessage.channel = `#${ tmpRoom._id }`;\n\t\t}\n\n\t\tmessage = processWebhookMessage(message, user, defaultValues);\n\t\treturn message;\n\t}\n\n\tbuildSandbox(store = {}) {\n\t\tconst sandbox = {\n\t\t\t_, s, console, moment,\n\t\t\tStore: {\n\t\t\t\tset: (key, val) => store[key] = val,\n\t\t\t\tget: (key) => store[key]\n\t\t\t},\n\t\t\tHTTP: (method, url, options) => {\n\t\t\t\ttry {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tresult: HTTP.call(method, url, options)\n\t\t\t\t\t};\n\t\t\t\t} catch (error) {\n\t\t\t\t\treturn { error };\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tObject.keys(RocketChat.models).filter(k => !k.startsWith('_')).forEach(k => {\n\t\t\tsandbox[k] = RocketChat.models[k];\n\t\t});\n\n\t\treturn { store, sandbox };\n\t}\n\n\tgetIntegrationScript(integration) {\n\t\tconst compiledScript = this.compiledScripts[integration._id];\n\t\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\t\treturn compiledScript.script;\n\t\t}\n\n\t\tconst script = integration.scriptCompiled;\n\t\tconst { store, sandbox } = this.buildSandbox();\n\n\t\tlet vmScript;\n\t\ttry {\n\t\t\tlogger.outgoing.info('Will evaluate script of Trigger', integration.name);\n\t\t\tlogger.outgoing.debug(script);\n\n\t\t\tvmScript = this.vm.createScript(script, 'script.js');\n\n\t\t\tvmScript.runInNewContext(sandbox);\n\n\t\t\tif (sandbox.Script) {\n\t\t\t\tthis.compiledScripts[integration._id] = {\n\t\t\t\t\tscript: new sandbox.Script(),\n\t\t\t\t\tstore,\n\t\t\t\t\t_updatedAt: integration._updatedAt\n\t\t\t\t};\n\n\t\t\t\treturn this.compiledScripts[integration._id].script;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tlogger.outgoing.error(`Error evaluating Script in Trigger ${ integration.name }:`);\n\t\t\tlogger.outgoing.error(script.replace(/^/gm, '  '));\n\t\t\tlogger.outgoing.error('Stack Trace:');\n\t\t\tlogger.outgoing.error(e.stack.replace(/^/gm, '  '));\n\t\t\tthrow new Meteor.Error('error-evaluating-script');\n\t\t}\n\n\t\tif (!sandbox.Script) {\n\t\t\tlogger.outgoing.error(`Class \"Script\" not in Trigger ${ integration.name }:`);\n\t\t\tthrow new Meteor.Error('class-script-not-found');\n\t\t}\n\t}\n\n\thasScriptAndMethod(integration, method) {\n\t\tif (integration.scriptEnabled !== true || !integration.scriptCompiled || integration.scriptCompiled.trim() === '') {\n\t\t\treturn false;\n\t\t}\n\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = this.getIntegrationScript(integration);\n\t\t} catch (e) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn typeof script[method] !== 'undefined';\n\t}\n\n\texecuteScript(integration, method, params, historyId) {\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = this.getIntegrationScript(integration);\n\t\t} catch (e) {\n\t\t\tthis.updateHistory({ historyId, step: 'execute-script-getting-script', error: true, errorStack: e });\n\t\t\treturn;\n\t\t}\n\n\t\tif (!script[method]) {\n\t\t\tlogger.outgoing.error(`Method \"${ method }\" no found in the Integration \"${ integration.name }\"`);\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-no-method-${ method }` });\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tconst { sandbox } = this.buildSandbox(this.compiledScripts[integration._id].store);\n\t\t\tsandbox.script = script;\n\t\t\tsandbox.method = method;\n\t\t\tsandbox.params = params;\n\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-before-running-${ method }` });\n\t\t\tconst result = this.vm.runInNewContext('script[method](params)', sandbox, { timeout: 3000 });\n\n\t\t\tlogger.outgoing.debug(`Script method \"${ method }\" result of the Integration \"${ integration.name }\" is:`);\n\t\t\tlogger.outgoing.debug(result);\n\n\t\t\treturn result;\n\t\t} catch (e) {\n\t\t\tthis.updateHistory({ historyId, step: `execute-script-error-running-${ method }`, error: true, errorStack: e.stack.replace(/^/gm, '  ') });\n\t\t\tlogger.outgoing.error(`Error running Script in the Integration ${ integration.name }:`);\n\t\t\tlogger.outgoing.debug(integration.scriptCompiled.replace(/^/gm, '  ')); // Only output the compiled script if debugging is enabled, so the logs don't get spammed.\n\t\t\tlogger.outgoing.error('Stack:');\n\t\t\tlogger.outgoing.error(e.stack.replace(/^/gm, '  '));\n\t\t\treturn;\n\t\t}\n\t}\n\n\teventNameArgumentsToObject() {\n\t\tconst argObject = {\n\t\t\tevent: arguments[0]\n\t\t};\n\n\t\tswitch (argObject.event) {\n\t\t\tcase 'sendMessage':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.message = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'fileUploaded':\n\t\t\t\tif (arguments.length >= 2) {\n\t\t\t\t\tconst arghhh = arguments[1];\n\t\t\t\t\targObject.user = arghhh.user;\n\t\t\t\t\targObject.room = arghhh.room;\n\t\t\t\t\targObject.message = arghhh.message;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomArchived':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.room = arguments[1];\n\t\t\t\t\targObject.user = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomCreated':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.owner = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomJoined':\n\t\t\tcase 'roomLeft':\n\t\t\t\tif (arguments.length >= 3) {\n\t\t\t\t\targObject.user = arguments[1];\n\t\t\t\t\targObject.room = arguments[2];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'userCreated':\n\t\t\t\tif (arguments.length >= 2) {\n\t\t\t\t\targObject.user = arguments[1];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tlogger.outgoing.warn(`An Unhandled Trigger Event was called: ${ argObject.event }`);\n\t\t\t\targObject.event = undefined;\n\t\t\t\tbreak;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Got the event arguments for the event: ${ argObject.event }`, argObject);\n\n\t\treturn argObject;\n\t}\n\n\tmapEventArgsToData(data, { event, message, room, owner, user }) {\n\t\tswitch (event) {\n\t\t\tcase 'sendMessage':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.message_id = message._id;\n\t\t\t\tdata.timestamp = message.ts;\n\t\t\t\tdata.user_id = message.u._id;\n\t\t\t\tdata.user_name = message.u.username;\n\t\t\t\tdata.text = message.msg;\n\n\t\t\t\tif (message.alias) {\n\t\t\t\t\tdata.alias = message.alias;\n\t\t\t\t}\n\n\t\t\t\tif (message.bot) {\n\t\t\t\t\tdata.bot = message.bot;\n\t\t\t\t}\n\n\t\t\t\tif (message.editedAt) {\n\t\t\t\t\tdata.isEdited = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'fileUploaded':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.message_id = message._id;\n\t\t\t\tdata.timestamp = message.ts;\n\t\t\t\tdata.user_id = message.u._id;\n\t\t\t\tdata.user_name = message.u.username;\n\t\t\t\tdata.text = message.msg;\n\t\t\t\tdata.user = user;\n\t\t\t\tdata.room = room;\n\t\t\t\tdata.message = message;\n\n\t\t\t\tif (message.alias) {\n\t\t\t\t\tdata.alias = message.alias;\n\t\t\t\t}\n\n\t\t\t\tif (message.bot) {\n\t\t\t\t\tdata.bot = message.bot;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'roomCreated':\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.timestamp = room.ts;\n\t\t\t\tdata.user_id = owner._id;\n\t\t\t\tdata.user_name = owner.username;\n\t\t\t\tdata.owner = owner;\n\t\t\t\tdata.room = room;\n\t\t\t\tbreak;\n\t\t\tcase 'roomArchived':\n\t\t\tcase 'roomJoined':\n\t\t\tcase 'roomLeft':\n\t\t\t\tdata.timestamp = new Date();\n\t\t\t\tdata.channel_id = room._id;\n\t\t\t\tdata.channel_name = room.name;\n\t\t\t\tdata.user_id = user._id;\n\t\t\t\tdata.user_name = user.username;\n\t\t\t\tdata.user = user;\n\t\t\t\tdata.room = room;\n\n\t\t\t\tif (user.type === 'bot') {\n\t\t\t\t\tdata.bot = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 'userCreated':\n\t\t\t\tdata.timestamp = user.createdAt;\n\t\t\t\tdata.user_id = user._id;\n\t\t\t\tdata.user_name = user.username;\n\t\t\t\tdata.user = user;\n\n\t\t\t\tif (user.type === 'bot') {\n\t\t\t\t\tdata.bot = true;\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\texecuteTriggers() {\n\t\tlogger.outgoing.debug('Execute Trigger:', arguments[0]);\n\n\t\tconst argObject = this.eventNameArgumentsToObject(...arguments);\n\t\tconst { event, message, room } = argObject;\n\n\t\t//Each type of event should have an event and a room attached, otherwise we\n\t\t//wouldn't know how to handle the trigger nor would we have anywhere to send the\n\t\t//result of the integration\n\t\tif (!event) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst triggersToExecute = [];\n\n\t\tlogger.outgoing.debug('Starting search for triggers for the room:', room ? room._id : '__any');\n\t\tif (room) {\n\t\t\tswitch (room.t) {\n\t\t\t\tcase 'd':\n\t\t\t\t\tconst id = room._id.replace(message.u._id, '');\n\t\t\t\t\tconst username = _.without(room.usernames, message.u.username)[0];\n\n\t\t\t\t\tif (this.triggers[`@${ id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`@${ id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers.all_direct_messages) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_direct_messages)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (id !== username && this.triggers[`@${ username }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`@${ username }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'c':\n\t\t\t\t\tif (this.triggers.all_public_channels) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_public_channels)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers[`#${ room._id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room._id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (room._id !== room.name && this.triggers[`#${ room.name }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room.name }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tif (this.triggers.all_private_groups) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers.all_private_groups)) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.triggers[`#${ room._id }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room._id }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (room._id !== room.name && this.triggers[`#${ room.name }`]) {\n\t\t\t\t\t\tfor (const trigger of Object.values(this.triggers[`#${ room.name }`])) {\n\t\t\t\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (this.triggers.__any) {\n\t\t\t//For outgoing integration which don't rely on rooms.\n\t\t\tfor (const trigger of Object.values(this.triggers.__any)) {\n\t\t\t\ttriggersToExecute.push(trigger);\n\t\t\t}\n\t\t}\n\n\t\tlogger.outgoing.debug(`Found ${ triggersToExecute.length } to iterate over and see if the match the event.`);\n\n\t\tfor (const triggerToExecute of triggersToExecute) {\n\t\t\tlogger.outgoing.debug(`Is \"${ triggerToExecute.name }\" enabled, ${ triggerToExecute.enabled }, and what is the event? ${ triggerToExecute.event }`);\n\t\t\tif (triggerToExecute.enabled === true && triggerToExecute.event === event) {\n\t\t\t\tthis.executeTrigger(triggerToExecute, argObject);\n\t\t\t}\n\t\t}\n\t}\n\n\texecuteTrigger(trigger, argObject) {\n\t\tfor (const url of trigger.urls) {\n\t\t\tthis.executeTriggerUrl(url, trigger, argObject, 0);\n\t\t}\n\t}\n\n\texecuteTriggerUrl(url, trigger, { event, message, room, owner, user }, theHistoryId, tries = 0) {\n\t\tif (!this.isTriggerEnabled(trigger)) {\n\t\t\tlogger.outgoing.warn(`The trigger \"${ trigger.name }\" is no longer enabled, stopping execution of it at try: ${ tries }`);\n\t\t\treturn;\n\t\t}\n\n\t\tlogger.outgoing.debug(`Starting to execute trigger: ${ trigger.name } (${ trigger._id })`);\n\n\t\tlet word;\n\t\t//Not all triggers/events support triggerWords\n\t\tif (RocketChat.integrations.outgoingEvents[event].use.triggerWords) {\n\t\t\tif (trigger.triggerWords && trigger.triggerWords.length > 0) {\n\t\t\t\tfor (const triggerWord of trigger.triggerWords) {\n\t\t\t\t\tif (!trigger.triggerWordAnywhere && message.msg.indexOf(triggerWord) === 0) {\n\t\t\t\t\t\tword = triggerWord;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t} else if (trigger.triggerWordAnywhere && message.msg.includes(triggerWord)) {\n\t\t\t\t\t\tword = triggerWord;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Stop if there are triggerWords but none match\n\t\t\t\tif (!word) {\n\t\t\t\t\tlogger.outgoing.debug(`The trigger word which \"${ trigger.name }\" was expecting could not be found, not executing.`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (message && message.editedAt && !trigger.runOnEdits) {\n\t\t\tlogger.outgoing.debug(`The trigger \"${ trigger.name }\"'s run on edits is disabled and the message was edited.`);\n\t\t\treturn;\n\t\t}\n\n\t\tconst historyId = this.updateHistory({ step: 'start-execute-trigger-url', integration: trigger, event });\n\n\t\tconst data = {\n\t\t\ttoken: trigger.token,\n\t\t\tbot: false\n\t\t};\n\n\t\tif (word) {\n\t\t\tdata.trigger_word = word;\n\t\t}\n\n\t\tthis.mapEventArgsToData(data, { trigger, event, message, room, owner, user });\n\t\tthis.updateHistory({ historyId, step: 'mapped-args-to-data', data, triggerWord: word });\n\n\t\tlogger.outgoing.info(`Will be executing the Integration \"${ trigger.name }\" to the url: ${ url }`);\n\t\tlogger.outgoing.debug(data);\n\n\t\tlet opts = {\n\t\t\tparams: {},\n\t\t\tmethod: 'POST',\n\t\t\turl,\n\t\t\tdata,\n\t\t\tauth: undefined,\n\t\t\tnpmRequestOptions: {\n\t\t\t\trejectUnauthorized: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs'),\n\t\t\t\tstrictSSL: !RocketChat.settings.get('Allow_Invalid_SelfSigned_Certs')\n\t\t\t},\n\t\t\theaders: {\n\t\t\t\t'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36'\n\t\t\t}\n\t\t};\n\n\t\tif (this.hasScriptAndMethod(trigger, 'prepare_outgoing_request')) {\n\t\t\topts = this.executeScript(trigger, 'prepare_outgoing_request', { request: opts }, historyId);\n\t\t}\n\n\t\tthis.updateHistory({ historyId, step: 'after-maybe-ran-prepare', ranPrepareScript: true });\n\n\t\tif (!opts) {\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-no-opts', finished: true });\n\t\t\treturn;\n\t\t}\n\n\t\tif (opts.message) {\n\t\t\tconst prepareMessage = this.sendMessage({ trigger, room, message: opts.message, data });\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-send-message', prepareSentMessage: prepareMessage });\n\t\t}\n\n\t\tif (!opts.url || !opts.method) {\n\t\t\tthis.updateHistory({ historyId, step: 'after-prepare-no-url_or_method', finished: true });\n\t\t\treturn;\n\t\t}\n\n\t\tthis.updateHistory({ historyId, step: 'pre-http-call', url: opts.url, httpCallData: opts.data });\n\t\tHTTP.call(opts.method, opts.url, opts, (error, result) => {\n\t\t\tif (!result) {\n\t\t\t\tlogger.outgoing.warn(`Result for the Integration ${ trigger.name } to ${ url } is empty`);\n\t\t\t} else {\n\t\t\t\tlogger.outgoing.info(`Status code for the Integration ${ trigger.name } to ${ url } is ${ result.statusCode }`);\n\t\t\t}\n\n\t\t\tthis.updateHistory({ historyId, step: 'after-http-call', httpError: error, httpResult: result });\n\n\t\t\tif (this.hasScriptAndMethod(trigger, 'process_outgoing_response')) {\n\t\t\t\tconst sandbox = {\n\t\t\t\t\trequest: opts,\n\t\t\t\t\tresponse: {\n\t\t\t\t\t\terror,\n\t\t\t\t\t\tstatus_code: result ? result.statusCode : undefined, //These values will be undefined to close issues #4175, #5762, and #5896\n\t\t\t\t\t\tcontent: result ? result.data : undefined,\n\t\t\t\t\t\tcontent_raw: result ? result.content : undefined,\n\t\t\t\t\t\theaders: result ? result.headers : {}\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tconst scriptResult = this.executeScript(trigger, 'process_outgoing_response', sandbox, historyId);\n\n\t\t\t\tif (scriptResult && scriptResult.content) {\n\t\t\t\t\tconst resultMessage = this.sendMessage({ trigger, room, message: scriptResult.content, data });\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-send-message', processSentMessage: resultMessage, finished: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (scriptResult === false) {\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-false-result', finished: true });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// if the result contained nothing or wasn't a successful statusCode\n\t\t\tif (!result || !this.successResults.includes(result.statusCode)) {\n\t\t\t\tif (error) {\n\t\t\t\t\tlogger.outgoing.error(`Error for the Integration \"${ trigger.name }\" to ${ url } is:`);\n\t\t\t\t\tlogger.outgoing.error(error);\n\t\t\t\t}\n\n\t\t\t\tif (result) {\n\t\t\t\t\tlogger.outgoing.error(`Error for the Integration \"${ trigger.name }\" to ${ url } is:`);\n\t\t\t\t\tlogger.outgoing.error(result);\n\n\t\t\t\t\tif (result.statusCode === 410) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-http-status-410', error: true });\n\t\t\t\t\t\tlogger.outgoing.error(`Disabling the Integration \"${ trigger.name }\" because the status code was 401 (Gone).`);\n\t\t\t\t\t\tRocketChat.models.Integrations.update({ _id: trigger._id }, { $set: { enabled: false }});\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (result.statusCode === 500) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'after-process-http-status-500', error: true });\n\t\t\t\t\t\tlogger.outgoing.error(`Error \"500\" for the Integration \"${ trigger.name }\" to ${ url }.`);\n\t\t\t\t\t\tlogger.outgoing.error(result.content);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (trigger.retryFailedCalls) {\n\t\t\t\t\tif (tries < trigger.retryCount && trigger.retryDelay) {\n\t\t\t\t\t\tthis.updateHistory({ historyId, error: true, step: `going-to-retry-${ tries + 1 }` });\n\n\t\t\t\t\t\tlet waitTime;\n\n\t\t\t\t\t\tswitch (trigger.retryDelay) {\n\t\t\t\t\t\t\tcase 'powers-of-ten':\n\t\t\t\t\t\t\t\t// Try again in 0.1s, 1s, 10s, 1m40s, 16m40s, 2h46m40s, 27h46m40s, etc\n\t\t\t\t\t\t\t\twaitTime = Math.pow(10, tries + 2);\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'powers-of-two':\n\t\t\t\t\t\t\t\t// 2 seconds, 4 seconds, 8 seconds\n\t\t\t\t\t\t\t\twaitTime = Math.pow(2, tries + 1) * 1000;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'increments-of-two':\n\t\t\t\t\t\t\t\t// 2 second, 4 seconds, 6 seconds, etc\n\t\t\t\t\t\t\t\twaitTime = (tries + 1) * 2 * 1000;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tconst er = new Error('The integration\\'s retryDelay setting is invalid.');\n\t\t\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'failed-and-retry-delay-is-invalid', error: true, errorStack: er.stack });\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlogger.outgoing.info(`Trying the Integration ${ trigger.name } to ${ url } again in ${ waitTime } milliseconds.`);\n\t\t\t\t\t\tMeteor.setTimeout(() => {\n\t\t\t\t\t\t\tthis.executeTriggerUrl(url, trigger, { event, message, room, owner, user }, historyId, tries + 1);\n\t\t\t\t\t\t}, waitTime);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.updateHistory({ historyId, step: 'too-many-retries', error: true });\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'failed-and-not-configured-to-retry', error: true });\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t//process outgoing webhook response as a new message\n\t\t\tif (result && this.successResults.includes(result.statusCode)) {\n\t\t\t\tif (result && result.data && (result.data.text || result.data.attachments)) {\n\t\t\t\t\tconst resultMsg = this.sendMessage({ trigger, room, message: result.data, data });\n\t\t\t\t\tthis.updateHistory({ historyId, step: 'url-response-sent-message', resultMessage: resultMsg, finished: true });\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\treplay(integration, history) {\n\t\tif (!integration || integration.type !== 'webhook-outgoing') {\n\t\t\tthrow new Meteor.Error('integration-type-must-be-outgoing', 'The integration type to replay must be an outgoing webhook.');\n\t\t}\n\n\t\tif (!history || !history.data) {\n\t\t\tthrow new Meteor.Error('history-data-must-be-defined', 'The history data must be defined to replay an integration.');\n\t\t}\n\n\t\tconst event = history.event;\n\t\tconst message = RocketChat.models.Messages.findOneById(history.data.message_id);\n\t\tconst room = RocketChat.models.Rooms.findOneById(history.data.channel_id);\n\t\tconst user = RocketChat.models.Users.findOneById(history.data.user_id);\n\t\tlet owner;\n\n\t\tif (history.data.owner && history.data.owner._id) {\n\t\t\towner = RocketChat.models.Users.findOneById(history.data.owner._id);\n\t\t}\n\n\t\tthis.executeTriggerUrl(history.url, integration, { event, message, room, owner, user });\n\t}\n};\n","RocketChat.models.Integrations = new class Integrations extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('integrations');\n\t}\n\n\tfindByType(type, options) {\n\t\tif (type !== 'webhook-incoming' && type !== 'webhook-outgoing') {\n\t\t\tthrow new Meteor.Error('invalid-type-to-find');\n\t\t}\n\n\t\treturn this.find({ type }, options);\n\t}\n\n\tdisableByUserId(userId) {\n\t\treturn this.update({ userId }, { $set: { enabled: false }}, { multi: true });\n\t}\n};\n","RocketChat.models.IntegrationHistory = new class IntegrationHistory extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('integration_history');\n\t}\n\n\tfindByType(type, options) {\n\t\tif (type !== 'outgoing-webhook' || type !== 'incoming-webhook') {\n\t\t\tthrow new Meteor.Error('invalid-integration-type');\n\t\t}\n\n\t\treturn this.find({ type }, options);\n\t}\n\n\tfindByIntegrationId(id, options) {\n\t\treturn this.find({ 'integration._id': id }, options);\n\t}\n\n\tfindByIntegrationIdAndCreatedBy(id, creatorId, options) {\n\t\treturn this.find({ 'integration._id': id, 'integration._createdBy._id': creatorId }, options);\n\t}\n\n\tfindOneByIntegrationIdAndHistoryId(integrationId, historyId) {\n\t\treturn this.findOne({ 'integration._id': integrationId, _id: historyId });\n\t}\n\n\tfindByEventName(event, options) {\n\t\treturn this.find({ event }, options);\n\t}\n\n\tfindFailed(options) {\n\t\treturn this.find({ error: true }, options);\n\t}\n\n\tremoveByIntegrationId(integrationId) {\n\t\treturn this.remove({ 'integration._id': integrationId });\n\t}\n};\n","Meteor.publish('integrations', function _integrationPublication() {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\treturn RocketChat.models.Integrations.find();\n\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\treturn RocketChat.models.Integrations.find({ '_createdBy._id': this.userId });\n\t} else {\n\t\tthrow new Meteor.Error('not-authorized');\n\t}\n});\n","Meteor.publish('integrationHistory', function _integrationHistoryPublication(integrationId, limit = 25) {\n\tif (!this.userId) {\n\t\treturn this.ready();\n\t}\n\n\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\treturn RocketChat.models.IntegrationHistory.findByIntegrationId(integrationId, { sort: { _updatedAt: -1 }, limit });\n\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\treturn RocketChat.models.IntegrationHistory.findByIntegrationIdAndCreatedBy(integrationId, this.userId, { sort: { _updatedAt: -1 }, limit });\n\t} else {\n\t\tthrow new Meteor.Error('not-authorized');\n\t}\n});\n","/* global Babel */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nconst validChannelChars = ['@', '#'];\n\nMeteor.methods({\n\taddIncomingIntegration(integration) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (!_.isString(integration.channel)) {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.channel.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tconst channels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!validChannelChars.includes(channel[0])) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tif (!_.isString(integration.username) || integration.username.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-username', 'Invalid username', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\t\ttry {\n\t\t\t\tlet babelOptions = Babel.getDefaultOptions({ runtime: false });\n\t\t\t\tbabelOptions = _.extend(babelOptions, { compact: true, minified: true, comments: false });\n\n\t\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\t\tintegration.scriptError = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tintegration.scriptCompiled = undefined;\n\t\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t\t}\n\t\t}\n\n\t\tfor (let channel of channels) {\n\t\t\tlet record;\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'addIncomingIntegration' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { method: 'addIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne({username: integration.username});\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'addIncomingIntegration' });\n\t\t}\n\n\t\tconst token = Random.id(48);\n\n\t\tintegration.type = 'webhook-incoming';\n\t\tintegration.token = token;\n\t\tintegration.channel = channels;\n\t\tintegration.userId = user._id;\n\t\tintegration._createdAt = new Date();\n\t\tintegration._createdBy = RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}});\n\n\t\tRocketChat.models.Roles.addUserRoles(user._id, 'bot');\n\n\t\tintegration._id = RocketChat.models.Integrations.insert(integration);\n\n\t\treturn integration;\n\t}\n});\n","/* global Babel */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nconst validChannelChars = ['@', '#'];\n\nMeteor.methods({\n\tupdateIncomingIntegration(integrationId, integration) {\n\t\tif (!_.isString(integration.channel) || integration.channel.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid channel', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tconst channels = _.map(integration.channel.split(','), (channel) => s.trim(channel));\n\n\t\tfor (const channel of channels) {\n\t\t\tif (!validChannelChars.includes(channel[0])) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel-start-with-chars', 'Invalid channel. Start with @ or #', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tlet currentIntegration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne({ _id: integrationId, '_createdBy._id': this.userId });\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tif (integration.scriptEnabled === true && integration.script && integration.script.trim() !== '') {\n\t\t\ttry {\n\t\t\t\tlet babelOptions = Babel.getDefaultOptions({ runtime: false });\n\t\t\t\tbabelOptions = _.extend(babelOptions, { compact: true, minified: true, comments: false });\n\n\t\t\t\tintegration.scriptCompiled = Babel.compile(integration.script, babelOptions).code;\n\t\t\t\tintegration.scriptError = undefined;\n\t\t\t} catch (e) {\n\t\t\t\tintegration.scriptCompiled = undefined;\n\t\t\t\tintegration.scriptError = _.pick(e, 'name', 'message', 'stack');\n\t\t\t}\n\t\t}\n\n\t\tfor (let channel of channels) {\n\t\t\tconst channelType = channel[0];\n\t\t\tchannel = channel.substr(1);\n\t\t\tlet record;\n\n\t\t\tswitch (channelType) {\n\t\t\t\tcase '#':\n\t\t\t\t\trecord = RocketChat.models.Rooms.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{name: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t\tcase '@':\n\t\t\t\t\trecord = RocketChat.models.Users.findOne({\n\t\t\t\t\t\t$or: [\n\t\t\t\t\t\t\t{_id: channel},\n\t\t\t\t\t\t\t{username: channel}\n\t\t\t\t\t\t]\n\t\t\t\t\t});\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (!record) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\n\t\t\tif (record.usernames && !RocketChat.authz.hasPermission(this.userId, 'manage-integrations') && RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') && !record.usernames.includes(Meteor.user().username)) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-channel', 'Invalid Channel', { method: 'updateIncomingIntegration' });\n\t\t\t}\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOne({ username: currentIntegration.username });\n\n\t\tif (!user || !user._id) {\n\t\t\tthrow new Meteor.Error('error-invalid-post-as-user', 'Invalid Post As User', { method: 'updateIncomingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Roles.addUserRoles(user._id, 'bot');\n\n\t\tRocketChat.models.Integrations.update(integrationId, {\n\t\t\t$set: {\n\t\t\t\tenabled: integration.enabled,\n\t\t\t\tname: integration.name,\n\t\t\t\tavatar: integration.avatar,\n\t\t\t\temoji: integration.emoji,\n\t\t\t\talias: integration.alias,\n\t\t\t\tchannel: channels,\n\t\t\t\tscript: integration.script,\n\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\tscriptCompiled: integration.scriptCompiled,\n\t\t\t\tscriptError: integration.scriptError,\n\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}})\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.models.Integrations.findOne(integrationId);\n\t}\n});\n","Meteor.methods({\n\tdeleteIncomingIntegration(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields : { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'deleteIncomingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'deleteIncomingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Integrations.remove({ _id: integrationId });\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\taddOutgoingIntegration(integration) {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'manage-integrations')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')\n\t\t\t&& !RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tthrow new Meteor.Error('not_authorized');\n\t\t}\n\n\t\tintegration = RocketChat.integrations.validateOutgoing(integration, this.userId);\n\n\t\tintegration._createdAt = new Date();\n\t\tintegration._createdBy = RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}});\n\t\tintegration._id = RocketChat.models.Integrations.insert(integration);\n\n\t\treturn integration;\n\t}\n});\n","Meteor.methods({\n\tupdateOutgoingIntegration(integrationId, integration) {\n\t\tintegration = RocketChat.integrations.validateOutgoing(integration, this.userId);\n\n\t\tif (!integration.token || integration.token.trim() === '') {\n\t\t\tthrow new Meteor.Error('error-invalid-token', 'Invalid token', { method: 'updateOutgoingIntegration' });\n\t\t}\n\n\t\tlet currentIntegration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations')) {\n\t\t\tcurrentIntegration = RocketChat.models.Integrations.findOne({ _id: integrationId, '_createdBy._id': this.userId });\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'updateOutgoingIntegration' });\n\t\t}\n\n\t\tif (!currentIntegration) {\n\t\t\tthrow new Meteor.Error('invalid_integration', '[methods] updateOutgoingIntegration -> integration not found');\n\t\t}\n\n\t\tRocketChat.models.Integrations.update(integrationId, {\n\t\t\t$set: {\n\t\t\t\tevent: integration.event,\n\t\t\t\tenabled: integration.enabled,\n\t\t\t\tname: integration.name,\n\t\t\t\tavatar: integration.avatar,\n\t\t\t\temoji: integration.emoji,\n\t\t\t\talias: integration.alias,\n\t\t\t\tchannel: integration.channel,\n\t\t\t\ttargetRoom: integration.targetRoom,\n\t\t\t\timpersonateUser: integration.impersonateUser,\n\t\t\t\tusername: integration.username,\n\t\t\t\tuserId: integration.userId,\n\t\t\t\turls: integration.urls,\n\t\t\t\ttoken: integration.token,\n\t\t\t\tscript: integration.script,\n\t\t\t\tscriptEnabled: integration.scriptEnabled,\n\t\t\t\tscriptCompiled: integration.scriptCompiled,\n\t\t\t\tscriptError: integration.scriptError,\n\t\t\t\ttriggerWords: integration.triggerWords,\n\t\t\t\tretryFailedCalls: integration.retryFailedCalls,\n\t\t\t\tretryCount: integration.retryCount,\n\t\t\t\tretryDelay: integration.retryDelay,\n\t\t\t\ttriggerWordAnywhere: integration.triggerWordAnywhere,\n\t\t\t\trunOnEdits: integration.runOnEdits,\n\t\t\t\t_updatedAt: new Date(),\n\t\t\t\t_updatedBy: RocketChat.models.Users.findOne(this.userId, {fields: {username: 1}})\n\t\t\t}\n\t\t});\n\n\t\treturn RocketChat.models.Integrations.findOne(integrationId);\n\t}\n});\n","Meteor.methods({\n\treplayOutgoingIntegration({ integrationId, historyId }) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tconst history = RocketChat.models.IntegrationHistory.findOneByIntegrationIdAndHistoryId(integration._id, historyId);\n\n\t\tif (!history) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration-history', 'Invalid Integration History', { method: 'replayOutgoingIntegration' });\n\t\t}\n\n\t\tRocketChat.integrations.triggerHandler.replay(integration, history);\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\tdeleteOutgoingIntegration(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'deleteOutgoingIntegration' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'deleteOutgoingIntegration' });\n\t\t}\n\n\t\tRocketChat.models.Integrations.remove({ _id: integrationId });\n\t\tRocketChat.models.IntegrationHistory.removeByIntegrationId(integrationId);\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\tclearIntegrationHistory(integrationId) {\n\t\tlet integration;\n\n\t\tif (RocketChat.authz.hasPermission(this.userId, 'manage-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId);\n\t\t} else if (RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations') || RocketChat.authz.hasPermission(this.userId, 'manage-own-integrations', 'bot')) {\n\t\t\tintegration = RocketChat.models.Integrations.findOne(integrationId, { fields: { '_createdBy._id': this.userId }});\n\t\t} else {\n\t\t\tthrow new Meteor.Error('not_authorized', 'Unauthorized', { method: 'clearIntegrationHistory' });\n\t\t}\n\n\t\tif (!integration) {\n\t\t\tthrow new Meteor.Error('error-invalid-integration', 'Invalid integration', { method: 'clearIntegrationHistory' });\n\t\t}\n\n\t\tRocketChat.models.IntegrationHistory.removeByIntegrationId(integrationId);\n\n\t\treturn true;\n\t}\n});\n","/* globals Meteor Restivus logger processWebhookMessage*/\n// TODO: remove globals\n\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport vm from 'vm';\nimport moment from 'moment';\n\nconst Api = new Restivus({\n\tenableCors: true,\n\tapiPath: 'hooks/',\n\tauth: {\n\t\tuser() {\n\t\t\tconst payloadKeys = Object.keys(this.bodyParams);\n\t\t\tconst payloadIsWrapped = (this.bodyParams && this.bodyParams.payload) && payloadKeys.length === 1;\n\t\t\tif (payloadIsWrapped && this.request.headers['content-type'] === 'application/x-www-form-urlencoded') {\n\t\t\t\ttry {\n\t\t\t\t\tthis.bodyParams = JSON.parse(this.bodyParams.payload);\n\t\t\t\t} catch ({message}) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\terror: {\n\t\t\t\t\t\t\tstatusCode: 400,\n\t\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\t\terror: message\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.integration = RocketChat.models.Integrations.findOne({\n\t\t\t\t_id: this.request.params.integrationId,\n\t\t\t\ttoken: decodeURIComponent(this.request.params.token)\n\t\t\t});\n\n\t\t\tif (!this.integration) {\n\t\t\t\tlogger.incoming.info('Invalid integration id', this.request.params.integrationId, 'or token', this.request.params.token);\n\n\t\t\t\treturn {\n\t\t\t\t\terror: {\n\t\t\t\t\t\tstatusCode: 404,\n\t\t\t\t\t\tbody: {\n\t\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\t\terror: 'Invalid integration id or token provided.'\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst user = RocketChat.models.Users.findOne({\n\t\t\t\t_id: this.integration.userId\n\t\t\t});\n\n\t\t\treturn { user };\n\t\t}\n\t}\n});\n\nconst compiledScripts = {};\nfunction buildSandbox(store = {}) {\n\tconst sandbox = {\n\t\t_,\n\t\ts,\n\t\tconsole,\n\t\tmoment,\n\t\tLivechat: RocketChat.Livechat,\n\t\tStore: {\n\t\t\tset(key, val) {\n\t\t\t\treturn store[key] = val;\n\t\t\t},\n\t\t\tget(key) {\n\t\t\t\treturn store[key];\n\t\t\t}\n\t\t},\n\t\tHTTP(method, url, options) {\n\t\t\ttry {\n\t\t\t\treturn {\n\t\t\t\t\tresult: HTTP.call(method, url, options)\n\t\t\t\t};\n\t\t\t} catch (error) {\n\t\t\t\treturn {\n\t\t\t\t\terror\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t};\n\n\tObject.keys(RocketChat.models).filter((k) => !k.startsWith('_')).forEach((k) => sandbox[k] = RocketChat.models[k]);\n\treturn { store, sandbox\t};\n}\n\nfunction getIntegrationScript(integration) {\n\tconst compiledScript = compiledScripts[integration._id];\n\tif (compiledScript && +compiledScript._updatedAt === +integration._updatedAt) {\n\t\treturn compiledScript.script;\n\t}\n\n\tconst script = integration.scriptCompiled;\n\tconst { sandbox, store } = buildSandbox();\n\ttry {\n\t\tlogger.incoming.info('Will evaluate script of Trigger', integration.name);\n\t\tlogger.incoming.debug(script);\n\n\t\tconst vmScript = vm.createScript(script, 'script.js');\n\t\tvmScript.runInNewContext(sandbox);\n\t\tif (sandbox.Script) {\n\t\t\tcompiledScripts[integration._id] = {\n\t\t\t\tscript: new sandbox.Script(),\n\t\t\t\tstore,\n\t\t\t\t_updatedAt: integration._updatedAt\n\t\t\t};\n\n\t\t\treturn compiledScripts[integration._id].script;\n\t\t}\n\t} catch ({ stack }) {\n\t\tlogger.incoming.error('[Error evaluating Script in Trigger', integration.name, ':]');\n\t\tlogger.incoming.error(script.replace(/^/gm, '  '));\n\t\tlogger.incoming.error('[Stack:]');\n\t\tlogger.incoming.error(stack.replace(/^/gm, '  '));\n\t\tthrow RocketChat.API.v1.failure('error-evaluating-script');\n\t}\n\n\tif (!sandbox.Script) {\n\t\tlogger.incoming.error('[Class \"Script\" not in Trigger', integration.name, ']');\n\t\tthrow RocketChat.API.v1.failure('class-script-not-found');\n\t}\n}\n\nfunction createIntegration(options, user) {\n\tlogger.incoming.info('Add integration', options.name);\n\tlogger.incoming.debug(options);\n\n\tMeteor.runAsUser(user._id, function() {\n\t\tswitch (options['event']) {\n\t\t\tcase 'newMessageOnChannel':\n\t\t\t\tif (options.data == null) {\n\t\t\t\t\toptions.data = {};\n\t\t\t\t}\n\t\t\t\tif ((options.data.channel_name != null) && options.data.channel_name.indexOf('#') === -1) {\n\t\t\t\t\toptions.data.channel_name = `#${ options.data.channel_name }`;\n\t\t\t\t}\n\t\t\t\treturn Meteor.call('addOutgoingIntegration', {\n\t\t\t\t\tusername: 'rocket.cat',\n\t\t\t\t\turls: [options.target_url],\n\t\t\t\t\tname: options.name,\n\t\t\t\t\tchannel: options.data.channel_name,\n\t\t\t\t\ttriggerWords: options.data.trigger_words\n\t\t\t\t});\n\t\t\tcase 'newMessageToUser':\n\t\t\t\tif (options.data.username.indexOf('@') === -1) {\n\t\t\t\t\toptions.data.username = `@${ options.data.username }`;\n\t\t\t\t}\n\t\t\t\treturn Meteor.call('addOutgoingIntegration', {\n\t\t\t\t\tusername: 'rocket.cat',\n\t\t\t\t\turls: [options.target_url],\n\t\t\t\t\tname: options.name,\n\t\t\t\t\tchannel: options.data.username,\n\t\t\t\t\ttriggerWords: options.data.trigger_words\n\t\t\t\t});\n\t\t}\n\t});\n\n\treturn RocketChat.API.v1.success();\n}\n\nfunction removeIntegration(options, user) {\n\tlogger.incoming.info('Remove integration');\n\tlogger.incoming.debug(options);\n\n\tconst integrationToRemove = RocketChat.models.Integrations.findOne({\n\t\turls: options.target_url\n\t});\n\n\tMeteor.runAsUser(user._id, () => {\n\t\treturn Meteor.call('deleteOutgoingIntegration', integrationToRemove._id);\n\t});\n\n\treturn RocketChat.API.v1.success();\n}\n\nfunction executeIntegrationRest() {\n\tlogger.incoming.info('Post integration:', this.integration.name);\n\tlogger.incoming.debug('@urlParams:', this.urlParams);\n\tlogger.incoming.debug('@bodyParams:', this.bodyParams);\n\n\tif (this.integration.enabled !== true) {\n\t\treturn {\n\t\t\tstatusCode: 503,\n\t\t\tbody: 'Service Unavailable'\n\t\t};\n\t}\n\n\tconst defaultValues = {\n\t\tchannel: this.integration.channel,\n\t\talias: this.integration.alias,\n\t\tavatar: this.integration.avatar,\n\t\temoji: this.integration.emoji\n\t};\n\n\tif (this.integration.scriptEnabled && this.integration.scriptCompiled && this.integration.scriptCompiled.trim() !== '') {\n\t\tlet script;\n\t\ttry {\n\t\t\tscript = getIntegrationScript(this.integration);\n\t\t} catch (e) {\n\t\t\tlogger.incoming.warn(e);\n\t\t\treturn RocketChat.API.v1.failure(e.message);\n\t\t}\n\n\t\tthis.request.setEncoding('utf8');\n\t\tconst content_raw = this.request.read();\n\n\t\tconst request = {\n\t\t\turl: {\n\t\t\t\thash: this.request._parsedUrl.hash,\n\t\t\t\tsearch: this.request._parsedUrl.search,\n\t\t\t\tquery: this.queryParams,\n\t\t\t\tpathname: this.request._parsedUrl.pathname,\n\t\t\t\tpath: this.request._parsedUrl.path\n\t\t\t},\n\t\t\turl_raw: this.request.url,\n\t\t\turl_params: this.urlParams,\n\t\t\tcontent: this.bodyParams,\n\t\t\tcontent_raw,\n\t\t\theaders: this.request.headers,\n\t\t\tbody: this.request.body,\n\t\t\tuser: {\n\t\t\t\t_id: this.user._id,\n\t\t\t\tname: this.user.name,\n\t\t\t\tusername: this.user.username\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tconst { sandbox } = buildSandbox(compiledScripts[this.integration._id].store);\n\t\t\tsandbox.script = script;\n\t\t\tsandbox.request = request;\n\n\t\t\tconst result = vm.runInNewContext('script.process_incoming_request({ request: request })', sandbox, {\n\t\t\t\ttimeout: 3000\n\t\t\t});\n\n\t\t\tif (!result) {\n\t\t\t\tlogger.incoming.debug('[Process Incoming Request result of Trigger', this.integration.name, ':] No data');\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t} else if (result && result.error) {\n\t\t\t\treturn RocketChat.API.v1.failure(result.error);\n\t\t\t}\n\n\t\t\tthis.bodyParams = result && result.content;\n\t\t\tthis.scriptResponse = result.response;\n\t\t\tif (result.user) {\n\t\t\t\tthis.user = result.user;\n\t\t\t}\n\n\t\t\tlogger.incoming.debug('[Process Incoming Request result of Trigger', this.integration.name, ':]');\n\t\t\tlogger.incoming.debug('result', this.bodyParams);\n\t\t} catch ({stack}) {\n\t\t\tlogger.incoming.error('[Error running Script in Trigger', this.integration.name, ':]');\n\t\t\tlogger.incoming.error(this.integration.scriptCompiled.replace(/^/gm, '  '));\n\t\t\tlogger.incoming.error('[Stack:]');\n\t\t\tlogger.incoming.error(stack.replace(/^/gm, '  '));\n\t\t\treturn RocketChat.API.v1.failure('error-running-script');\n\t\t}\n\t}\n\n\t// TODO: Turn this into an option on the integrations - no body means a success\n\t// TODO: Temporary fix for https://github.com/RocketChat/Rocket.Chat/issues/7770 until the above is implemented\n\tif (!this.bodyParams || (_.isEmpty(this.bodyParams) && !this.integration.scriptEnabled)) {\n\t\t// return RocketChat.API.v1.failure('body-empty');\n\t\treturn RocketChat.API.v1.success();\n\t}\n\n\tthis.bodyParams.bot = { i: this.integration._id };\n\n\ttry {\n\t\tconst message = processWebhookMessage(this.bodyParams, this.user, defaultValues);\n\t\tif (_.isEmpty(message)) {\n\t\t\treturn RocketChat.API.v1.failure('unknown-error');\n\t\t}\n\n\t\tif (this.scriptResponse) {\n\t\t\tlogger.incoming.debug('response', this.scriptResponse);\n\t\t}\n\n\t\treturn RocketChat.API.v1.success(this.scriptResponse);\n\t} catch ({ error, message }) {\n\t\treturn RocketChat.API.v1.failure(error || message);\n\t}\n}\n\nfunction addIntegrationRest() {\n\treturn createIntegration(this.bodyParams, this.user);\n}\n\nfunction removeIntegrationRest() {\n\treturn removeIntegration(this.bodyParams, this.user);\n}\n\nfunction integrationSampleRest() {\n\tlogger.incoming.info('Sample Integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: [\n\t\t\t{\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 1',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}, {\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 2',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}, {\n\t\t\t\ttoken: Random.id(24),\n\t\t\t\tchannel_id: Random.id(),\n\t\t\t\tchannel_name: 'general',\n\t\t\t\ttimestamp: new Date,\n\t\t\t\tuser_id: Random.id(),\n\t\t\t\tuser_name: 'rocket.cat',\n\t\t\t\ttext: 'Sample text 3',\n\t\t\t\ttrigger_word: 'Sample'\n\t\t\t}\n\t\t]\n\t};\n}\n\nfunction integrationInfoRest() {\n\tlogger.incoming.info('Info integration');\n\treturn {\n\t\tstatusCode: 200,\n\t\tbody: {\n\t\t\tsuccess: true\n\t\t}\n\t};\n}\n\nApi.addRoute(':integrationId/:userId/:token', { authRequired: true }, {\n\tpost: executeIntegrationRest,\n\tget: executeIntegrationRest\n});\n\nApi.addRoute(':integrationId/:token', { authRequired: true }, {\n\tpost: executeIntegrationRest,\n\tget: executeIntegrationRest\n});\n\nApi.addRoute('sample/:integrationId/:userId/:token', { authRequired: true }, {\n\tget: integrationSampleRest\n});\n\nApi.addRoute('sample/:integrationId/:token', { authRequired: true }, {\n\tget: integrationSampleRest\n});\n\nApi.addRoute('info/:integrationId/:userId/:token', { authRequired: true }, {\n\tget: integrationInfoRest\n});\n\nApi.addRoute('info/:integrationId/:token', { authRequired: true }, {\n\tget: integrationInfoRest\n});\n\nApi.addRoute('add/:integrationId/:userId/:token', { authRequired: true }, {\n\tpost: addIntegrationRest\n});\n\nApi.addRoute('add/:integrationId/:token', { authRequired: true }, {\n\tpost: addIntegrationRest\n});\n\nApi.addRoute('remove/:integrationId/:userId/:token', { authRequired: true }, {\n\tpost: removeIntegrationRest\n});\n\nApi.addRoute('remove/:integrationId/:token', { authRequired: true }, {\n\tpost: removeIntegrationRest\n});\n","const callbackHandler = function _callbackHandler(eventType) {\n\treturn function _wrapperFunction() {\n\t\treturn RocketChat.integrations.triggerHandler.executeTriggers(eventType, ...arguments);\n\t};\n};\n\nRocketChat.callbacks.add('afterSaveMessage', callbackHandler('sendMessage'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreateChannel', callbackHandler('roomCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreatePrivateGroup', callbackHandler('roomCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterCreateUser', callbackHandler('userCreated'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterJoinRoom', callbackHandler('roomJoined'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterLeaveRoom', callbackHandler('roomLeft'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterRoomArchived', callbackHandler('roomArchived'), RocketChat.callbacks.priority.LOW);\nRocketChat.callbacks.add('afterFileUpload', callbackHandler('fileUploaded'), RocketChat.callbacks.priority.LOW);\n","import _ from 'underscore';\nimport s from 'underscore.string';\n\nthis.processWebhookMessage = function(messageObj, user, defaultValues = { channel: '', alias: '', avatar: '', emoji: '' }, mustBeJoined = false) {\n\tconst sentData = [];\n\tconst channels = [].concat(messageObj.channel || messageObj.roomId || defaultValues.channel);\n\n\tfor (const channel of channels) {\n\t\tconst channelType = channel[0];\n\n\t\tlet channelValue = channel.substr(1);\n\t\tlet room;\n\n\t\tswitch (channelType) {\n\t\t\tcase '#':\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, joinChannel: true });\n\t\t\t\tbreak;\n\t\t\tcase '@':\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, type: 'd' });\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tchannelValue = channelType + channelValue;\n\n\t\t\t\t//Try to find the room by id or name if they didn't include the prefix.\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, joinChannel: true, errorOnEmpty: false });\n\t\t\t\tif (room) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t//We didn't get a room, let's try finding direct messages\n\t\t\t\troom = RocketChat.getRoomByNameOrIdWithOptionToJoin({ currentUserId: user._id, nameOrId: channelValue, type: 'd', tryDirectByUserIdOnly: true });\n\t\t\t\tif (room) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\t//No room, so throw an error\n\t\t\t\tthrow new Meteor.Error('invalid-channel');\n\t\t}\n\n\t\tif (mustBeJoined && !room.usernames.includes(user.username)) {\n\t\t\t// throw new Meteor.Error('invalid-room', 'Invalid room provided to send a message to, must be joined.');\n\t\t\tthrow new Meteor.Error('invalid-channel'); // Throwing the generic one so people can't \"brute force\" find rooms\n\t\t}\n\n\t\tif (messageObj.attachments && !_.isArray(messageObj.attachments)) {\n\t\t\tconsole.log('Attachments should be Array, ignoring value'.red, messageObj.attachments);\n\t\t\tmessageObj.attachments = undefined;\n\t\t}\n\n\t\tconst message = {\n\t\t\talias: messageObj.username || messageObj.alias || defaultValues.alias,\n\t\t\tmsg: s.trim(messageObj.text || messageObj.msg || ''),\n\t\t\tattachments: messageObj.attachments || [],\n\t\t\tparseUrls: messageObj.parseUrls !== undefined ? messageObj.parseUrls : !messageObj.attachments,\n\t\t\tbot: messageObj.bot,\n\t\t\tgroupable: (messageObj.groupable !== undefined) ? messageObj.groupable : false\n\t\t};\n\n\t\tif (!_.isEmpty(messageObj.icon_url) || !_.isEmpty(messageObj.avatar)) {\n\t\t\tmessage.avatar = messageObj.icon_url || messageObj.avatar;\n\t\t} else if (!_.isEmpty(messageObj.icon_emoji) || !_.isEmpty(messageObj.emoji)) {\n\t\t\tmessage.emoji = messageObj.icon_emoji || messageObj.emoji;\n\t\t} else if (!_.isEmpty(defaultValues.avatar)) {\n\t\t\tmessage.avatar = defaultValues.avatar;\n\t\t} else if (!_.isEmpty(defaultValues.emoji)) {\n\t\t\tmessage.emoji = defaultValues.emoji;\n\t\t}\n\n\t\tif (_.isArray(message.attachments)) {\n\t\t\tfor (let i = 0; i < message.attachments.length; i++) {\n\t\t\t\tconst attachment = message.attachments[i];\n\t\t\t\tif (attachment.msg) {\n\t\t\t\t\tattachment.text = s.trim(attachment.msg);\n\t\t\t\t\tdelete attachment.msg;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tconst messageReturn = RocketChat.sendMessage(user, message, room);\n\t\tsentData.push({ channel, message: messageReturn });\n\t}\n\n\treturn sentData;\n};\n"]}