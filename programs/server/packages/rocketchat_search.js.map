{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:search/server/index.js","meteor://ðŸ’»app/packages/rocketchat:search/server/events/events.js","meteor://ðŸ’»app/packages/rocketchat:search/server/logger/logger.js","meteor://ðŸ’»app/packages/rocketchat:search/server/model/provider.js","meteor://ðŸ’»app/packages/rocketchat:search/server/provider/defaultProvider.js","meteor://ðŸ’»app/packages/rocketchat:search/server/service/providerService.js","meteor://ðŸ’»app/packages/rocketchat:search/server/service/validationService.js"],"names":["module","export","searchProviderService","SearchProvider","watch","require","v","default","SearchLogger","EventService","_pushError","name","value","payload","debug","promoteEvent","activeProvider","on","eventService","RocketChat","callbacks","add","m","_id","models","Users","type","user","Rooms","room","Logger","exportDefault","Setting","constructor","basekey","key","defaultValue","options","_basekey","_value","undefined","id","load","settings","get","Settings","list","Object","keys","map","Error","forEach","match","info","_key","_settings","i18nLabel","i18nDescription","iconName","settingsAsMap","resultTemplate","suggestionItemTemplate","search","text","context","callback","suggest","supportsSuggestions","run","reason","Promise","resolve","reject","start","stop","DefaultProvider","alert","_rid","searchAll","rid","_limit","limit","Meteor","call","register","_","validationService","SearchProviderService","providers","use","stopProvider","then","e","provider","addGroup","self","values","public","filter","length","section","setting","_options","enableQuery","push","configProvider","debounce","bindEnvironment","providerId","startup","methods","JSON","stringify","error","data","validateSearchResult","description","icon","mapObject","ValidationService","result","subscriptionCache","getSubscription","uid","hasOwnProperty","userCache","getUsername","findById","fetch","username","userId","message","docs","msg","subscription","r","t","valid"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,OAAOC,MAAP,CAAc;AAACC,yBAAsB,MAAIA,qBAA3B;AAAiDC,kBAAe,MAAIA;AAApE,CAAd;AAAmGH,OAAOI,KAAP,CAAaC,QAAQ,kBAAR,CAAb;AAA0CL,OAAOI,KAAP,CAAaC,QAAQ,8BAAR,CAAb;AAAsDL,OAAOI,KAAP,CAAaC,QAAQ,gCAAR,CAAb;AAAwDL,OAAOI,KAAP,CAAaC,QAAQ,oBAAR,CAAb;AAA4CL,OAAOI,KAAP,CAAaC,QAAQ,+BAAR,CAAb;AAAuD,IAAIH,qBAAJ;AAA0BF,OAAOI,KAAP,CAAaC,QAAQ,2BAAR,CAAb,EAAkD;AAACH,wBAAsBI,CAAtB,EAAwB;AAACJ,4BAAsBI,CAAtB;AAAwB;;AAAlD,CAAlD,EAAsG,CAAtG;AAAyG,IAAIH,cAAJ;AAAmBH,OAAOI,KAAP,CAAaC,QAAQ,kBAAR,CAAb,EAAyC;AAACE,UAAQD,CAAR,EAAU;AAACH,qBAAeG,CAAf;AAAiB;;AAA7B,CAAzC,EAAwE,CAAxE,E;;;;;;;;;;;ACApf,IAAIJ,qBAAJ;AAA0BF,OAAOI,KAAP,CAAaC,QAAQ,4BAAR,CAAb,EAAmD;AAACH,wBAAsBI,CAAtB,EAAwB;AAACJ,4BAAsBI,CAAtB;AAAwB;;AAAlD,CAAnD,EAAuG,CAAvG;AAA0G,IAAIE,YAAJ;AAAiBR,OAAOI,KAAP,CAAaC,QAAQ,kBAAR,CAAb,EAAyC;AAACE,UAAQD,CAAR,EAAU;AAACE,mBAAaF,CAAb;AAAe;;AAA3B,CAAzC,EAAsE,CAAtE;;AAGrJ,MAAMG,YAAN,CAAmB;AAElB;AACAC,aAAWC,IAAX,EAAiBC,KAAjB,EAAwBC,OAAxB,EAAiC;AAChC;AACAL,iBAAaM,KAAb,CAAoB,mBAAmBH,IAAM,cAAcC,KAAO,GAAlE;AACA;;AAEDG,eAAaJ,IAAb,EAAmBC,KAAnB,EAA0BC,OAA1B,EAAmC;AAClC,QAAI,EAAEX,sBAAsBc,cAAtB,IAAwCd,sBAAsBc,cAAtB,CAAqCC,EAArC,CAAwCN,IAAxC,EAA8CC,KAA9C,EAAqDC,OAArD,CAA1C,CAAJ,EAA8G;AAC7G,WAAKH,UAAL,CAAgBC,IAAhB,EAAsBC,KAAtB,EAA6BC,OAA7B;AACA;AACD;;AAZiB;;AAenB,MAAMK,eAAe,IAAIT,YAAJ,EAArB;AAEA;;;;AAGAU,WAAWC,SAAX,CAAqBC,GAArB,CAAyB,kBAAzB,EAA6C,UAASC,CAAT,EAAY;AACxDJ,eAAaH,YAAb,CAA0B,cAA1B,EAA0CO,EAAEC,GAA5C,EAAiDD,CAAjD;AACA,CAFD;AAIAH,WAAWC,SAAX,CAAqBC,GAArB,CAAyB,oBAAzB,EAA+C,UAASC,CAAT,EAAY;AAC1DJ,eAAaH,YAAb,CAA0B,gBAA1B,EAA4CO,EAAEC,GAA9C;AACA,CAFD;AAIA;;;;AAIAJ,WAAWK,MAAX,CAAkBC,KAAlB,CAAwBR,EAAxB,CAA2B,SAA3B,EAAsC,CAACS,IAAD,EAAOC,IAAP,KAAc;AACnD,MAAID,SAAS,UAAT,IAAuBA,SAAS,SAApC,EAA+C;AAC9CR,iBAAaH,YAAb,CAA0B,WAA1B,EAAuCY,KAAKJ,GAA5C,EAAiDI,IAAjD;AACA;;AACD,MAAID,SAAS,SAAb,EAAwB;AACvBR,iBAAaH,YAAb,CAA0B,aAA1B,EAAyCY,KAAKJ,GAA9C;AACA;AACD,CAPD;AASAJ,WAAWK,MAAX,CAAkBI,KAAlB,CAAwBX,EAAxB,CAA2B,SAA3B,EAAsC,CAACS,IAAD,EAAOG,IAAP,KAAc;AACnD,MAAIH,SAAS,UAAT,IAAuBA,SAAS,SAApC,EAA+C;AAC9CR,iBAAaH,YAAb,CAA0B,WAA1B,EAAuCc,KAAKN,GAA5C,EAAiDM,IAAjD;AACA;;AACD,MAAIH,SAAS,SAAb,EAAwB;AACvBR,iBAAaH,YAAb,CAA0B,aAA1B,EAAyCc,KAAKN,GAA9C;AACA;AACD,CAPD,E;;;;;;;;;;;AC5CA,MAAMf,eAAe,IAAIsB,MAAJ,CAAW,eAAX,EAA4B,EAA5B,CAArB;AAAA9B,OAAO+B,aAAP,CACevB,YADf,E;;;;;;;;;;;ACAAR,OAAOC,MAAP,CAAc;AAACM,WAAQ,MAAIJ;AAAb,CAAd;AAA4C,IAAIK,YAAJ;AAAiBR,OAAOI,KAAP,CAAaC,QAAQ,kBAAR,CAAb,EAAyC;AAACE,UAAQD,CAAR,EAAU;AAACE,mBAAaF,CAAb;AAAe;;AAA3B,CAAzC,EAAsE,CAAtE;;AAG7D;;;AAGA,MAAM0B,OAAN,CAAc;AACbC,cAAYC,OAAZ,EAAqBC,GAArB,EAA0BT,IAA1B,EAAgCU,YAAhC,EAA8CC,UAAU,EAAxD,EAA4D;AAC3D,SAAKC,QAAL,GAAgBJ,OAAhB;AACA,SAAKC,GAAL,GAAWA,GAAX;AACA,SAAKT,IAAL,GAAYA,IAAZ;AACA,SAAKU,YAAL,GAAoBA,YAApB;AACA,SAAKC,OAAL,GAAeA,OAAf;AACA,SAAKE,MAAL,GAAcC,SAAd;AACA;;AAED,MAAI5B,KAAJ,GAAY;AACX,WAAO,KAAK2B,MAAZ;AACA;AAED;;;;;;AAIA,MAAIE,EAAJ,GAAS;AACR,WAAQ,UAAU,KAAKH,QAAU,IAAI,KAAKH,GAAK,EAA/C;AACA;;AAEDO,SAAO;AACN,SAAKH,MAAL,GAAcpB,WAAWwB,QAAX,CAAoBC,GAApB,CAAwB,KAAKH,EAA7B,CAAd;;AAEA,QAAI,KAAKF,MAAL,KAAgBC,SAApB,EAA+B;AAAE,WAAKD,MAAL,GAAc,KAAKH,YAAnB;AAAkC;AACnE;;AA1BY;AA8Bd;;;;;AAGA,MAAMS,QAAN,CAAe;AACdZ,cAAYC,OAAZ,EAAqB;AACpB,SAAKA,OAAL,GAAeA,OAAf;AACA,SAAKS,QAAL,GAAgB,EAAhB;AACA;;AAEDtB,MAAIc,GAAJ,EAAST,IAAT,EAAeU,YAAf,EAA6BC,OAA7B,EAAsC;AACrC,SAAKM,QAAL,CAAcR,GAAd,IAAqB,IAAIH,OAAJ,CAAY,KAAKE,OAAjB,EAA0BC,GAA1B,EAA+BT,IAA/B,EAAqCU,YAArC,EAAmDC,OAAnD,CAArB;AACA;;AAEDS,SAAO;AACN,WAAOC,OAAOC,IAAP,CAAY,KAAKL,QAAjB,EAA2BM,GAA3B,CAA+Bd,OAAO,KAAKQ,QAAL,CAAcR,GAAd,CAAtC,CAAP;AACA;;AAEDc,QAAM;AACL,WAAO,KAAKN,QAAZ;AACA;AAED;;;;;;AAIAC,MAAIT,GAAJ,EAAS;AACR,QAAI,CAAC,KAAKQ,QAAL,CAAcR,GAAd,CAAL,EAAyB;AAAE,YAAM,IAAIe,KAAJ,CAAU,oBAAV,CAAN;AAAwC;;AACnE,WAAO,KAAKP,QAAL,CAAcR,GAAd,EAAmBvB,KAA1B;AACA;AAED;;;;;AAGA8B,SAAO;AACNK,WAAOC,IAAP,CAAY,KAAKL,QAAjB,EAA2BQ,OAA3B,CAAoChB,GAAD,IAAS;AAC3C,WAAKQ,QAAL,CAAcR,GAAd,EAAmBO,IAAnB;AACA,KAFD;AAGA;;AAlCa;;AAqCA,MAAMvC,cAAN,CAAqB;AAEnC;;;;AAIA8B,cAAYE,GAAZ,EAAiB;AAEhB,QAAI,CAACA,IAAIiB,KAAJ,CAAU,aAAV,CAAL,EAA+B;AAAE,YAAM,IAAIF,KAAJ,CAAW,gCAAgCf,GAAK,6BAAhD,CAAN;AAAsF;;AAEvH3B,iBAAa6C,IAAb,CAAmB,0BAA0BlB,GAAK,EAAlD;AAEA,SAAKmB,IAAL,GAAYnB,GAAZ;AACA,SAAKoB,SAAL,GAAiB,IAAIV,QAAJ,CAAaV,GAAb,CAAjB;AACA;AAED;;;AACA,MAAIA,GAAJ,GAAU;AACT,WAAO,KAAKmB,IAAZ;AACA;;AAED,MAAIE,SAAJ,GAAgB;AACf,WAAOhB,SAAP;AACA;;AAED,MAAIiB,eAAJ,GAAsB;AACrB,WAAOjB,SAAP;AACA;;AAED,MAAIkB,QAAJ,GAAe;AACd,WAAO,WAAP;AACA;;AAED,MAAIf,QAAJ,GAAe;AACd,WAAO,KAAKY,SAAL,CAAeT,IAAf,EAAP;AACA;;AAED,MAAIa,aAAJ,GAAoB;AACnB,WAAO,KAAKJ,SAAL,CAAeN,GAAf,EAAP;AACA;AAED;;;AACA,MAAIW,cAAJ,GAAqB;AACpB,WAAO,6BAAP;AACA;;AAED,MAAIC,sBAAJ,GAA6B;AAC5B,WAAO,+BAAP;AACA;AAED;;AACA;;;;;;;;;;AAQAC,SAAOC,IAAP,EAAaC,OAAb,EAAsBnD,OAAtB,EAA+BoD,QAA/B,EAAyC;AACxC,UAAM,IAAIf,KAAJ,CAAU,uCAAV,CAAN;AACA;AAED;;;;;;;;;AAOAgB,UAAQH,IAAR,EAAcC,OAAd,EAAuBnD,OAAvB,EAAgCoD,QAAhC,EAA0C;AACzCA,aAAS,IAAT,EAAe,EAAf;AACA;;AAED,MAAIE,mBAAJ,GAA0B;AACzB,WAAO,KAAP;AACA;AAED;;;AACAlD,KAAGN,IAAH,EAASC,KAAT,EAAgB;AACf,WAAO,IAAP;AACA;AAED;;;AACAwD,MAAIC,MAAJ,EAAYJ,QAAZ,EAAsB;AACrB,WAAO,IAAIK,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvC,WAAKjB,SAAL,CAAeb,IAAf;;AACA,WAAK+B,KAAL,CAAWJ,MAAX,EAAmBE,OAAnB,EAA4BC,MAA5B;AACA,KAHM,CAAP;AAIA;;AAEDC,QAAMJ,MAAN,EAAcE,OAAd,EAAuB;AACtBA;AACA;;AAEDG,OAAKH,OAAL,EAAc;AACbA;AACA;;AAjGkC,C;;;;;;;;;;;AC5EpC,IAAIrE,qBAAJ;AAA0BF,OAAOI,KAAP,CAAaC,QAAQ,4BAAR,CAAb,EAAmD;AAACH,wBAAsBI,CAAtB,EAAwB;AAACJ,4BAAsBI,CAAtB;AAAwB;;AAAlD,CAAnD,EAAuG,CAAvG;AAA0G,IAAIH,cAAJ;AAAmBH,OAAOI,KAAP,CAAaC,QAAQ,mBAAR,CAAb,EAA0C;AAACE,UAAQD,CAAR,EAAU;AAACH,qBAAeG,CAAf;AAAiB;;AAA7B,CAA1C,EAAyE,CAAzE;;AAGvJ;;;AAGA,MAAMqE,eAAN,SAA8BxE,cAA9B,CAA6C;AAE5C;;;AAGA8B,gBAAc;AACb,UAAM,iBAAN;;AACA,SAAKsB,SAAL,CAAelC,GAAf,CAAmB,qBAAnB,EAA0C,SAA1C,EAAqD,KAArD,EAA4D;AAC3DmC,iBAAW,eADgD;AAE3DoB,aAAO;AAFoD,KAA5D;;AAIA,SAAKrB,SAAL,CAAelC,GAAf,CAAmB,UAAnB,EAA+B,KAA/B,EAAsC,EAAtC,EAA0C;AACzCmC,iBAAW;AAD8B,KAA1C;AAGA;;AAED,MAAIA,SAAJ,GAAgB;AACf,WAAO,kBAAP;AACA;;AAED,MAAIC,eAAJ,GAAsB;AACrB,WAAO,gCAAP;AACA;AAED;;;;;;AAIAK,SAAOC,IAAP,EAAaC,OAAb,EAAsBnD,UAAU,EAAhC,EAAoCoD,QAApC,EAA8C;AAE7C,UAAMY,OAAOhE,QAAQiE,SAAR,GAAoBtC,SAApB,GAAgCwB,QAAQe,GAArD;;AAEA,UAAMC,SAASnE,QAAQoE,KAAR,IAAiB,KAAK1B,SAAL,CAAeX,GAAf,CAAmB,UAAnB,CAAhC;;AAEAsC,WAAOC,IAAP,CAAY,eAAZ,EAA6BpB,IAA7B,EAAmCc,IAAnC,EAAyCG,MAAzC,EAAiDf,QAAjD;AAEA;;AApC2C,C,CAuC7C;;;AACA/D,sBAAsBkF,QAAtB,CAA+B,IAAIT,eAAJ,EAA/B,E;;;;;;;;;;;;;;;AC9CA3E,OAAOC,MAAP,CAAc;AAACC,yBAAsB,MAAIA;AAA3B,CAAd;;AAAiE,IAAImF,CAAJ;;AAAMrF,OAAOI,KAAP,CAAaC,QAAQ,YAAR,CAAb,EAAmC;AAACE,UAAQD,CAAR,EAAU;AAAC+E,QAAE/E,CAAF;AAAI;;AAAhB,CAAnC,EAAqD,CAArD;AAAwD,IAAIgF,iBAAJ;AAAsBtF,OAAOI,KAAP,CAAaC,QAAQ,8BAAR,CAAb,EAAqD;AAACiF,oBAAkBhF,CAAlB,EAAoB;AAACgF,wBAAkBhF,CAAlB;AAAoB;;AAA1C,CAArD,EAAiG,CAAjG;AAAoG,IAAIE,YAAJ;AAAiBR,OAAOI,KAAP,CAAaC,QAAQ,kBAAR,CAAb,EAAyC;AAACE,UAAQD,CAAR,EAAU;AAACE,mBAAaF,CAAb;AAAe;;AAA3B,CAAzC,EAAsE,CAAtE;;AAM1Q,MAAMiF,qBAAN,CAA4B;AAE3BtD,gBAAc;AACb,SAAKuD,SAAL,GAAiB,EAAjB;AACA,SAAKxE,cAAL,GAAsBwB,SAAtB;AACA;AAED;;;;;;;AAKAiD,MAAIhD,EAAJ,EAAQ;AAEP,WAAO,IAAI6B,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvC,UAAI,CAAC,KAAKgB,SAAL,CAAe/C,EAAf,CAAL,EAAyB;AAAE,cAAM,IAAIS,KAAJ,CAAW,YAAYT,EAAI,kBAA3B,CAAN;AAAsD;;AAEjF,UAAI4B,SAAS,QAAb;;AAEA,UAAI,CAAC,KAAKrD,cAAV,EAA0B;AACzBqD,iBAAS,SAAT;AACA,OAFD,MAEO,IAAI,KAAKrD,cAAL,CAAoBmB,GAApB,KAA4B,KAAKqD,SAAL,CAAe/C,EAAf,EAAmBN,GAAnD,EAAwD;AAC9DkC,iBAAS,QAAT;AACA;;AAED,YAAMqB,eAAe,MAAM;AAC1B,eAAO,IAAIpB,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvC,cAAI,KAAKxD,cAAT,EAAyB;AAExBR,yBAAaM,KAAb,CAAoB,sBAAsB,KAAKE,cAAL,CAAoBmB,GAAK,GAAnE;AAEA,iBAAKnB,cAAL,CAAoB0D,IAApB,CAAyBH,OAAzB,EAAkCC,MAAlC;AACA,WALD,MAKO;AACND;AACA;AACD,SATM,CAAP;AAUA,OAXD;;AAaAmB,qBAAeC,IAAf,CAAoB,MAAM;AACzB,aAAK3E,cAAL,GAAsBwB,SAAtB;AAEAhC,qBAAaM,KAAb,CAAoB,mBAAmB2B,EAAI,GAA3C;;AAEA,YAAI;AAEH,eAAK+C,SAAL,CAAe/C,EAAf,EAAmB2B,GAAnB,CAAuBC,MAAvB,EAA+BsB,IAA/B,CAAoC,MAAM;AACzC,iBAAK3E,cAAL,GAAsB,KAAKwE,SAAL,CAAe/C,EAAf,CAAtB;AACA8B;AACA,WAHD,EAGGC,MAHH;AAKA,SAPD,CAOE,OAAOoB,CAAP,EAAU;AACXpB,iBAAOoB,CAAP;AACA;AACD,OAfD,EAeGpB,MAfH;AAiBA,KAzCM,CAAP;AA2CA;AAED;;;;;;AAIAY,WAASS,QAAT,EAAmB;AAClB,SAAKL,SAAL,CAAeK,SAAS1D,GAAxB,IAA+B0D,QAA/B;AACA;AAED;;;;;AAGApB,UAAQ;AACPjE,iBAAaM,KAAb,CAAmB,6BAAnB;AAEA,UAAM0E,YAAY,KAAKA,SAAvB,CAHO,CAKP;;AACArE,eAAWwB,QAAX,CAAoBmD,QAApB,CAA6B,QAA7B,EAAuC,YAAW;AAEjD,YAAMC,OAAO,IAAb;AAEAA,WAAK1E,GAAL,CAAS,iBAAT,EAA4B,iBAA5B,EAA+C;AAC9CK,cAAM,QADwC;AAE9CsE,gBAAQjD,OAAOC,IAAP,CAAYwC,SAAZ,EAAuBvC,GAAvB,CAA4Bd,GAAD,IAAS;AAAE,iBAAO;AAACA,eAAD;AAAMqB,uBAAWgC,UAAUrD,GAAV,EAAeqB;AAAhC,WAAP;AAAoD,SAA1F,CAFsC;AAG9CyC,gBAAQ,IAHsC;AAI9CzC,mBAAW;AAJmC,OAA/C;AAOAT,aAAOC,IAAP,CAAYwC,SAAZ,EACEU,MADF,CACU/D,GAAD,IAASqD,UAAUrD,GAAV,EAAeQ,QAAf,IAA2B6C,UAAUrD,GAAV,EAAeQ,QAAf,CAAwBwD,MAAxB,GAAiC,CAD9E,EAEEhD,OAFF,CAEU,UAAShB,GAAT,EAAc;AACtB4D,aAAKK,OAAL,CAAaZ,UAAUrD,GAAV,EAAeqB,SAA5B,EAAuC,YAAW;AACjDgC,oBAAUrD,GAAV,EAAeQ,QAAf,CAAwBQ,OAAxB,CAAiCkD,OAAD,IAAa;AAE5C,kBAAMC;AACL5E,oBAAM2E,QAAQ3E;AADT,eAEF2E,QAAQhE,OAFN,CAAN;;AAKAiE,qBAASC,WAAT,GAAuBD,SAASC,WAAT,IAAwB,EAA/C;;AAEAD,qBAASC,WAAT,CAAqBC,IAArB,CAA0B;AACzBjF,mBAAK,iBADoB;AAEzBX,qBAAOuB;AAFkB,aAA1B;;AAKA,iBAAKd,GAAL,CAASgF,QAAQ5D,EAAjB,EAAqB4D,QAAQjE,YAA7B,EAA2CkE,QAA3C;AACA,WAfD;AAgBA,SAjBD;AAkBA,OArBF;AAsBA,KAjCD,EANO,CAyCP;;AACA,UAAMG,iBAAiBpB,EAAEqB,QAAF,CAAWxB,OAAOyB,eAAP,CAAuB,MAAM;AAC9D,YAAMC,aAAazF,WAAWwB,QAAX,CAAoBC,GAApB,CAAwB,iBAAxB,CAAnB;;AAEA,UAAIgE,UAAJ,EAAgB;AACf,aAAKnB,GAAL,CAASmB,UAAT,EADe,CACM;AACrB;AAED,KAPiC,CAAX,EAOnB,IAPmB,CAAvB;;AASAzF,eAAWwB,QAAX,CAAoBC,GAApB,CAAwB,WAAxB,EAAqC6D,cAArC;AACA;;AA1H0B;;AA8HrB,MAAMvG,wBAAwB,IAAIqF,qBAAJ,EAA9B;AAEPL,OAAO2B,OAAP,CAAe,MAAM;AACpB3G,wBAAsBuE,KAAtB;AACA,CAFD;AAIAS,OAAO4B,OAAP,CAAe;AACd;;;;;;;;AAQA,4BAA0B/C,IAA1B,EAAgCC,OAAhC,EAAyCnD,OAAzC,EAAkD;AAEjD,WAAO,IAAIyD,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAEvC3D,gBAAUA,YAAY,IAAZ,GAAmBA,OAAnB,GAA6B2B,SAAvC,CAFuC,CAEU;;AAEjD,UAAI;AAEH,YAAI,CAACtC,sBAAsBc,cAA3B,EAA2C;AAC1C,gBAAM,IAAIkC,KAAJ,CAAU,+BAAV,CAAN;AACA;;AAED1C,qBAAaM,KAAb,CAAmB,UAAnB,EAAgC,YAAYiD,IAAM,eAAegD,KAAKC,SAAL,CAAehD,OAAf,CAAyB,eAAe+C,KAAKC,SAAL,CAAenG,OAAf,CAAyB,EAAlI;AAEAX,8BAAsBc,cAAtB,CAAqC8C,MAArC,CAA4CC,IAA5C,EAAkDC,OAAlD,EAA2DnD,OAA3D,EAAoE,CAACoG,KAAD,EAAQC,IAAR,KAAiB;AACpF,cAAID,KAAJ,EAAW;AACVzC,mBAAOyC,KAAP;AACA,WAFD,MAEO;AACN1C,oBAAQe,kBAAkB6B,oBAAlB,CAAuCD,IAAvC,CAAR;AACA;AACD,SAND;AAOA,OAfD,CAeE,OAAOtB,CAAP,EAAU;AACXpB,eAAOoB,CAAP;AACA;AACD,KAtBM,CAAP;AAuBA,GAlCa;;AAmCd,6BAA2B7B,IAA3B,EAAiCC,OAAjC,EAA0CnD,OAA1C,EAAmD;AAElD,WAAO,IAAIyD,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvC3D,gBAAUA,YAAY,IAAZ,GAAmBA,OAAnB,GAA6B2B,SAAvC,CADuC,CACU;;AAEjD,UAAI;AAEH,YAAI,CAACtC,sBAAsBc,cAA3B,EAA2C;AAAE,gBAAM,IAAIkC,KAAJ,CAAU,+BAAV,CAAN;AAAmD;;AAEhG1C,qBAAaM,KAAb,CAAmB,WAAnB,EAAiC,YAAYiD,IAAM,eAAegD,KAAKC,SAAL,CAAehD,OAAf,CAAyB,eAAe+C,KAAKC,SAAL,CAAenG,OAAf,CAAyB,EAAnI;AAEAX,8BAAsBc,cAAtB,CAAqCkD,OAArC,CAA6CH,IAA7C,EAAmDC,OAAnD,EAA4DnD,OAA5D,EAAqE,CAACoG,KAAD,EAAQC,IAAR,KAAiB;AACrF,cAAID,KAAJ,EAAW;AACVzC,mBAAOyC,KAAP;AACA,WAFD,MAEO;AACN1C,oBAAQ2C,IAAR;AACA;AACD,SAND;AAOA,OAbD,CAaE,OAAOtB,CAAP,EAAU;AACXpB,eAAOoB,CAAP;AACA;AACD,KAnBM,CAAP;AAoBA,GAzDa;;AA0Dd;;;;AAIA,mCAAiC;AAChC,QAAI,CAAC1F,sBAAsBc,cAA3B,EAA2C;AAAE,aAAOwB,SAAP;AAAmB;;AAEhE,WAAO;AACNL,WAAKjC,sBAAsBc,cAAtB,CAAqCmB,GADpC;AAENiF,mBAAalH,sBAAsBc,cAAtB,CAAqCyC,eAF5C;AAGN4D,YAAMnH,sBAAsBc,cAAtB,CAAqC0C,QAHrC;AAINE,sBAAgB1D,sBAAsBc,cAAtB,CAAqC4C,cAJ/C;AAKNO,2BAAqBjE,sBAAsBc,cAAtB,CAAqCmD,mBALpD;AAMNN,8BAAwB3D,sBAAsBc,cAAtB,CAAqC6C,sBANvD;AAONlB,gBAAU0C,EAAEiC,SAAF,CAAYpH,sBAAsBc,cAAtB,CAAqC2C,aAAjD,EAAiE0C,OAAD,IAAa;AACtF,eAAOA,QAAQzF,KAAf;AACA,OAFS;AAPJ,KAAP;AAWA;;AA5Ea,CAAf,E;;;;;;;;;;;AC1IAZ,OAAOC,MAAP,CAAc;AAACqF,qBAAkB,MAAIA;AAAvB,CAAd;AAAyD,IAAI9E,YAAJ;AAAiBR,OAAOI,KAAP,CAAaC,QAAQ,kBAAR,CAAb,EAAyC;AAACE,UAAQD,CAAR,EAAU;AAACE,mBAAaF,CAAb;AAAe;;AAA3B,CAAzC,EAAsE,CAAtE;;AAE1E,MAAMiH,iBAAN,CAAwB;AACvBtF,gBAAc,CAAE;;AAEhBkF,uBAAqBK,MAArB,EAA6B;AAE5B,UAAMC,oBAAoB,EAA1B;;AAEA,UAAMC,kBAAkB,CAAC3C,GAAD,EAAM4C,GAAN,KAAc;AACrC,UAAI,CAACF,kBAAkBG,cAAlB,CAAiC7C,GAAjC,CAAL,EAA4C;AAC3C0C,0BAAkB1C,GAAlB,IAAyBG,OAAOC,IAAP,CAAY,eAAZ,EAA6BJ,GAA7B,EAAkC4C,GAAlC,CAAzB;AACA;;AAED,aAAOF,kBAAkB1C,GAAlB,CAAP;AACA,KAND;;AAQA,UAAM8C,YAAY,EAAlB;;AAEA,UAAMC,cAAeH,GAAD,IAAS;AAC5B,UAAI,CAACE,UAAUD,cAAV,CAAyBD,GAAzB,CAAL,EAAoC;AACnC,YAAI;AACHE,oBAAUF,GAAV,IAAiBxG,WAAWK,MAAX,CAAkBC,KAAlB,CAAwBsG,QAAxB,CAAiCJ,GAAjC,EAAsCK,KAAtC,GAA8C,CAA9C,EAAiDC,QAAlE;AACA,SAFD,CAEE,OAAOrC,CAAP,EAAU;AACXiC,oBAAUF,GAAV,IAAiBnF,SAAjB;AACA;AACD;;AACD,aAAOqF,UAAUF,GAAV,CAAP;AACA,KATD;;AAWA,UAAMA,MAAMzC,OAAOgD,MAAP,EAAZ,CAzB4B,CA0B5B;;AACA,QAAIV,OAAOW,OAAX,EAAoB;AACnBX,aAAOW,OAAP,CAAeC,IAAf,CAAoBjF,OAApB,CAA6BkF,GAAD,IAAS;AAEpC,cAAMC,eAAeZ,gBAAgBW,IAAItD,GAApB,EAAyB4C,GAAzB,CAArB;;AAEA,YAAIW,YAAJ,EAAkB;AACjBD,cAAIE,CAAJ,GAAQ;AAAC5H,kBAAM2H,aAAa3H,IAApB;AAA0B6H,eAAGF,aAAaE;AAA1C,WAAR;AACAH,cAAIJ,QAAJ,GAAeH,YAAYO,IAAI1G,IAAhB,CAAf;AACA0G,cAAII,KAAJ,GAAY,IAAZ;AACAjI,uBAAaM,KAAb,CAAoB,QAAQ6G,GAAK,eAAeU,IAAItD,GAAK,MAAMuD,aAAaE,CAAb,KAAmB,GAAnB,GAAyBF,aAAaL,QAAtC,GAAiDK,aAAa3H,IAAM,IAAnI;AACA,SALD,MAKO;AACNH,uBAAaM,KAAb,CAAoB,QAAQ6G,GAAK,mBAAmBU,IAAItD,GAAK,EAA7D;AACA;AACD,OAZD;AAcAyC,aAAOW,OAAP,CAAeC,IAAf,CAAoBlC,MAApB,CAA4BmC,GAAD,IAAS;AACnC,eAAOA,IAAII,KAAX;AACA,OAFD;AAGA;;AAED,QAAIjB,OAAO3F,IAAX,EAAiB;AAChB2F,aAAO3F,IAAP,CAAYuG,IAAZ,CAAiBjF,OAAjB,CAA0BtB,IAAD,IAAU;AAClC,cAAMyG,eAAeZ,gBAAgB7F,KAAKN,GAArB,EAA0BoG,GAA1B,CAArB;;AACA,YAAIW,YAAJ,EAAkB;AACjBzG,eAAK4G,KAAL,GAAa,IAAb;AACAjI,uBAAaM,KAAb,CAAoB,QAAQ6G,GAAK,eAAe9F,KAAKN,GAAK,MAAM+G,aAAaE,CAAb,KAAmB,GAAnB,GAAyBF,aAAaL,QAAtC,GAAiDK,aAAa3H,IAAM,IAApI;AACA,SAHD,MAGO;AACNH,uBAAaM,KAAb,CAAoB,QAAQ6G,GAAK,mBAAmB9F,KAAKN,GAAK,EAA9D;AACA;AACD,OARD;AAUAiG,aAAO3F,IAAP,CAAYuG,IAAZ,CAAiBlC,MAAjB,CAAyBrE,IAAD,IAAU;AACjC,eAAOA,KAAK4G,KAAZ;AACA,OAFD;AAGA;;AAED,WAAOjB,MAAP;AACA;;AAnEsB;;AAsEjB,MAAMlC,oBAAoB,IAAIiC,iBAAJ,EAA1B,C","file":"/packages/rocketchat_search.js","sourcesContent":["import './model/provider';\nimport './service/providerService.js';\nimport './service/validationService.js';\nimport './events/events.js';\nimport './provider/defaultProvider.js';\n\nimport {searchProviderService} from './service/providerService';\nimport SearchProvider from './model/provider';\n\nexport {\n\tsearchProviderService,\n\tSearchProvider\n};\n","import {searchProviderService} from '../service/providerService';\nimport SearchLogger from '../logger/logger';\n\nclass EventService {\n\n\t/*eslint no-unused-vars: [2, { \"args\": \"none\" }]*/\n\t_pushError(name, value, payload) {\n\t\t//TODO implement a (performant) cache\n\t\tSearchLogger.debug(`Error on event '${ name }' with id '${ value }'`);\n\t}\n\n\tpromoteEvent(name, value, payload) {\n\t\tif (!(searchProviderService.activeProvider && searchProviderService.activeProvider.on(name, value, payload))) {\n\t\t\tthis._pushError(name, value, payload);\n\t\t}\n\t}\n}\n\nconst eventService = new EventService();\n\n/**\n * Listen to message changes via Hooks\n */\nRocketChat.callbacks.add('afterSaveMessage', function(m) {\n\teventService.promoteEvent('message.save', m._id, m);\n});\n\nRocketChat.callbacks.add('afterDeleteMessage', function(m) {\n\teventService.promoteEvent('message.delete', m._id);\n});\n\n/**\n * Listen to user and room changes via cursor\n */\n\nRocketChat.models.Users.on('changed', (type, user)=>{\n\tif (type === 'inserted' || type === 'updated') {\n\t\teventService.promoteEvent('user.save', user._id, user);\n\t}\n\tif (type === 'removed') {\n\t\teventService.promoteEvent('user.delete', user._id);\n\t}\n});\n\nRocketChat.models.Rooms.on('changed', (type, room)=>{\n\tif (type === 'inserted' || type === 'updated') {\n\t\teventService.promoteEvent('room.save', room._id, room);\n\t}\n\tif (type === 'removed') {\n\t\teventService.promoteEvent('room.delete', room._id);\n\t}\n});\n","const SearchLogger = new Logger('Search Logger', {});\nexport default SearchLogger;\n","/*eslint no-unused-vars: [2, { \"args\": \"none\" }]*/\nimport SearchLogger from '../logger/logger';\n\n/**\n * Setting Object in order to manage settings loading for providers and admin ui display\n */\nclass Setting {\n\tconstructor(basekey, key, type, defaultValue, options = {}) {\n\t\tthis._basekey = basekey;\n\t\tthis.key = key;\n\t\tthis.type = type;\n\t\tthis.defaultValue = defaultValue;\n\t\tthis.options = options;\n\t\tthis._value = undefined;\n\t}\n\n\tget value() {\n\t\treturn this._value;\n\t}\n\n\t/**\n\t * Id is generated based on baseKey and key\n\t * @returns {string}\n\t */\n\tget id() {\n\t\treturn `Search.${ this._basekey }.${ this.key }`;\n\t}\n\n\tload() {\n\t\tthis._value = RocketChat.settings.get(this.id);\n\n\t\tif (this._value === undefined) { this._value = this.defaultValue; }\n\t}\n\n}\n\n/**\n * Settings Object allows to manage Setting Objects\n */\nclass Settings {\n\tconstructor(basekey) {\n\t\tthis.basekey = basekey;\n\t\tthis.settings = {};\n\t}\n\n\tadd(key, type, defaultValue, options) {\n\t\tthis.settings[key] = new Setting(this.basekey, key, type, defaultValue, options);\n\t}\n\n\tlist() {\n\t\treturn Object.keys(this.settings).map(key => this.settings[key]);\n\t}\n\n\tmap() {\n\t\treturn this.settings;\n\t}\n\n\t/**\n\t * return the value for key\n\t * @param key\n\t */\n\tget(key) {\n\t\tif (!this.settings[key]) { throw new Error('Setting is not set'); }\n\t\treturn this.settings[key].value;\n\t}\n\n\t/**\n\t * load currently stored values of all settings\n\t */\n\tload() {\n\t\tObject.keys(this.settings).forEach((key) => {\n\t\t\tthis.settings[key].load();\n\t\t});\n\t}\n}\n\nexport default class SearchProvider {\n\n\t/**\n\t * Create search provider, key must match /^[a-z0-9]+$/\n\t * @param key\n\t */\n\tconstructor(key) {\n\n\t\tif (!key.match(/^[A-z0-9]+$/)) { throw new Error(`cannot instantiate provider: ${ key } does not match key-pattern`); }\n\n\t\tSearchLogger.info(`create search provider ${ key }`);\n\n\t\tthis._key = key;\n\t\tthis._settings = new Settings(key);\n\t}\n\n\t/*--- basic params ---*/\n\tget key() {\n\t\treturn this._key;\n\t}\n\n\tget i18nLabel() {\n\t\treturn undefined;\n\t}\n\n\tget i18nDescription() {\n\t\treturn undefined;\n\t}\n\n\tget iconName() {\n\t\treturn 'magnifier';\n\t}\n\n\tget settings() {\n\t\treturn this._settings.list();\n\t}\n\n\tget settingsAsMap() {\n\t\treturn this._settings.map();\n\t}\n\n\t/*--- templates ---*/\n\tget resultTemplate() {\n\t\treturn 'DefaultSearchResultTemplate';\n\t}\n\n\tget suggestionItemTemplate() {\n\t\treturn 'DefaultSuggestionItemTemplate';\n\t}\n\n\t/*--- search functions ---*/\n\t/**\n\t * Search using the current search provider and check if results are valid for the user. The search result has\n\t * the format {messages:{start:0,numFound:1,docs:[{...}]},users:{...},rooms:{...}}\n\t * @param text the search text\n\t * @param context the context (uid, rid)\n\t * @param payload custom payload (e.g. for paging)\n\t * @param callback is used to return result an can be called with (error,result)\n\t */\n\tsearch(text, context, payload, callback) {\n\t\tthrow new Error('Function search has to be implemented');\n\t}\n\n\t/**\n\t * Returns an ordered list of suggestions. The result should have at least the form [{text:string}]\n\t * @param text\n\t * @param context\n\t * @param payload\n\t * @param callback\n\t */\n\tsuggest(text, context, payload, callback) {\n\t\tcallback(null, []);\n\t}\n\n\tget supportsSuggestions() {\n\t\treturn false;\n\t}\n\n\t/*--- triggers ---*/\n\ton(name, value) {\n\t\treturn true;\n\t}\n\n\t/*--- livecycle ---*/\n\trun(reason, callback) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis._settings.load();\n\t\t\tthis.start(reason, resolve, reject);\n\t\t});\n\t}\n\n\tstart(reason, resolve) {\n\t\tresolve();\n\t}\n\n\tstop(resolve) {\n\t\tresolve();\n\t}\n}\n\n","import {searchProviderService} from '../service/providerService';\nimport SearchProvider from '../model/provider';\n\n/**\n * Implements the default provider (based on mongo db search)\n */\nclass DefaultProvider extends SearchProvider {\n\n\t/**\n\t * Enable settings: GlobalSearchEnabled, PageSize\n\t */\n\tconstructor() {\n\t\tsuper('defaultProvider');\n\t\tthis._settings.add('GlobalSearchEnabled', 'boolean', false, {\n\t\t\ti18nLabel: 'Global_Search',\n\t\t\talert: 'This feature is currently in beta and could decrease the application performance! Please report bugs to github.com/RocketChat/Rocket.Chat/issues'\n\t\t});\n\t\tthis._settings.add('PageSize', 'int', 10, {\n\t\t\ti18nLabel: 'Search_Page_Size'\n\t\t});\n\t}\n\n\tget i18nLabel() {\n\t\treturn 'Default provider';\n\t}\n\n\tget i18nDescription() {\n\t\treturn 'You_can_search_using_RegExp_eg';\n\t}\n\n\t/**\n\t * {@inheritDoc}\n\t * Uses Meteor function 'messageSearch'\n\t */\n\tsearch(text, context, payload = {}, callback) {\n\n\t\tconst _rid = payload.searchAll ? undefined : context.rid;\n\n\t\tconst _limit = payload.limit || this._settings.get('PageSize');\n\n\t\tMeteor.call('messageSearch', text, _rid, _limit, callback);\n\n\t}\n}\n\n//register provider\nsearchProviderService.register(new DefaultProvider());\n","/* globals RocketChat */\nimport _ from 'underscore';\n\nimport {validationService} from '../service/validationService';\nimport SearchLogger from '../logger/logger';\n\nclass SearchProviderService {\n\n\tconstructor() {\n\t\tthis.providers = {};\n\t\tthis.activeProvider = undefined;\n\t}\n\n\t/**\n\t * Stop current provider (if there is one) and start the new\n\t * @param id the id of the provider which should be started\n\t * @param cb a possible callback if provider is active or not (currently not in use)\n\t */\n\tuse(id) {\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (!this.providers[id]) { throw new Error(`provider ${ id } cannot be found`); }\n\n\t\t\tlet reason = 'switch';\n\n\t\t\tif (!this.activeProvider) {\n\t\t\t\treason = 'startup';\n\t\t\t} else if (this.activeProvider.key === this.providers[id].key) {\n\t\t\t\treason = 'update';\n\t\t\t}\n\n\t\t\tconst stopProvider = () => {\n\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\tif (this.activeProvider) {\n\n\t\t\t\t\t\tSearchLogger.debug(`Stopping provider '${ this.activeProvider.key }'`);\n\n\t\t\t\t\t\tthis.activeProvider.stop(resolve, reject);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tstopProvider().then(() => {\n\t\t\t\tthis.activeProvider = undefined;\n\n\t\t\t\tSearchLogger.debug(`Start provider '${ id }'`);\n\n\t\t\t\ttry {\n\n\t\t\t\t\tthis.providers[id].run(reason).then(() => {\n\t\t\t\t\t\tthis.activeProvider = this.providers[id];\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t}, reject);\n\n\t\t\t\t} catch (e) {\n\t\t\t\t\treject(e);\n\t\t\t\t}\n\t\t\t}, reject);\n\n\t\t});\n\n\t}\n\n\t/**\n\t * Registers a search provider on system startup\n\t * @param provider\n\t */\n\tregister(provider) {\n\t\tthis.providers[provider.key] = provider;\n\t}\n\n\t/**\n\t * Starts the service (loads provider settings for admin ui, add lister not setting changes, enable current provider\n\t */\n\tstart() {\n\t\tSearchLogger.debug('Load data for all providers');\n\n\t\tconst providers = this.providers;\n\n\t\t//add settings for admininistration\n\t\tRocketChat.settings.addGroup('Search', function() {\n\n\t\t\tconst self = this;\n\n\t\t\tself.add('Search.Provider', 'defaultProvider', {\n\t\t\t\ttype: 'select',\n\t\t\t\tvalues: Object.keys(providers).map((key) => { return {key, i18nLabel: providers[key].i18nLabel}; }),\n\t\t\t\tpublic: true,\n\t\t\t\ti18nLabel: 'Search_Provider'\n\t\t\t});\n\n\t\t\tObject.keys(providers)\n\t\t\t\t.filter((key) => providers[key].settings && providers[key].settings.length > 0)\n\t\t\t\t.forEach(function(key) {\n\t\t\t\t\tself.section(providers[key].i18nLabel, function() {\n\t\t\t\t\t\tproviders[key].settings.forEach((setting) => {\n\n\t\t\t\t\t\t\tconst _options = {\n\t\t\t\t\t\t\t\ttype: setting.type,\n\t\t\t\t\t\t\t\t...setting.options\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t_options.enableQuery = _options.enableQuery || [];\n\n\t\t\t\t\t\t\t_options.enableQuery.push({\n\t\t\t\t\t\t\t\t_id: 'Search.Provider',\n\t\t\t\t\t\t\t\tvalue: key\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tthis.add(setting.id, setting.defaultValue, _options);\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t});\n\n\t\t//add listener to react on setting changes\n\t\tconst configProvider = _.debounce(Meteor.bindEnvironment(() => {\n\t\t\tconst providerId = RocketChat.settings.get('Search.Provider');\n\n\t\t\tif (providerId) {\n\t\t\t\tthis.use(providerId);//TODO do something with success and errors\n\t\t\t}\n\n\t\t}), 1000);\n\n\t\tRocketChat.settings.get(/^Search\\./, configProvider);\n\t}\n\n}\n\nexport const searchProviderService = new SearchProviderService();\n\nMeteor.startup(() => {\n\tsearchProviderService.start();\n});\n\nMeteor.methods({\n\t/**\n\t * Search using the current search provider and check if results are valid for the user. The search result has\n\t * the format {messages:{start:0,numFound:1,docs:[{...}]},users:{...},rooms:{...}}\n\t * @param text the search text\n\t * @param context the context (uid, rid)\n\t * @param payload custom payload (e.g. for paging)\n\t * @returns {*}\n\t */\n\t'rocketchatSearch.search'(text, context, payload) {\n\n\t\treturn new Promise((resolve, reject) => {\n\n\t\t\tpayload = payload !== null ? payload : undefined;//TODO is this cleanup necessary?\n\n\t\t\ttry {\n\n\t\t\t\tif (!searchProviderService.activeProvider) {\n\t\t\t\t\tthrow new Error('Provider currently not active');\n\t\t\t\t}\n\n\t\t\t\tSearchLogger.debug('search: ', `\\n\\tText:${ text }\\n\\tContext:${ JSON.stringify(context) }\\n\\tPayload:${ JSON.stringify(payload) }`);\n\n\t\t\t\tsearchProviderService.activeProvider.search(text, context, payload, (error, data) => {\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve(validationService.validateSearchResult(data));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} catch (e) {\n\t\t\t\treject(e);\n\t\t\t}\n\t\t});\n\t},\n\t'rocketchatSearch.suggest'(text, context, payload) {\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tpayload = payload !== null ? payload : undefined;//TODO is this cleanup necessary?\n\n\t\t\ttry {\n\n\t\t\t\tif (!searchProviderService.activeProvider) { throw new Error('Provider currently not active'); }\n\n\t\t\t\tSearchLogger.debug('suggest: ', `\\n\\tText:${ text }\\n\\tContext:${ JSON.stringify(context) }\\n\\tPayload:${ JSON.stringify(payload) }`);\n\n\t\t\t\tsearchProviderService.activeProvider.suggest(text, context, payload, (error, data) => {\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve(data);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} catch (e) {\n\t\t\t\treject(e);\n\t\t\t}\n\t\t});\n\t},\n\t/**\n\t * Get the current provider with key, description, resultTemplate, suggestionItemTemplate and settings (as Map)\n\t * @returns {*}\n\t */\n\t'rocketchatSearch.getProvider'() {\n\t\tif (!searchProviderService.activeProvider) { return undefined; }\n\n\t\treturn {\n\t\t\tkey: searchProviderService.activeProvider.key,\n\t\t\tdescription: searchProviderService.activeProvider.i18nDescription,\n\t\t\ticon: searchProviderService.activeProvider.iconName,\n\t\t\tresultTemplate: searchProviderService.activeProvider.resultTemplate,\n\t\t\tsupportsSuggestions: searchProviderService.activeProvider.supportsSuggestions,\n\t\t\tsuggestionItemTemplate: searchProviderService.activeProvider.suggestionItemTemplate,\n\t\t\tsettings: _.mapObject(searchProviderService.activeProvider.settingsAsMap, (setting) => {\n\t\t\t\treturn setting.value;\n\t\t\t})\n\t\t};\n\t}\n});\n\n","import SearchLogger from '../logger/logger';\n\nclass ValidationService {\n\tconstructor() {}\n\n\tvalidateSearchResult(result) {\n\n\t\tconst subscriptionCache = {};\n\n\t\tconst getSubscription = (rid, uid) => {\n\t\t\tif (!subscriptionCache.hasOwnProperty(rid)) {\n\t\t\t\tsubscriptionCache[rid] = Meteor.call('canAccessRoom', rid, uid);\n\t\t\t}\n\n\t\t\treturn subscriptionCache[rid];\n\t\t};\n\n\t\tconst userCache = {};\n\n\t\tconst getUsername = (uid) => {\n\t\t\tif (!userCache.hasOwnProperty(uid)) {\n\t\t\t\ttry {\n\t\t\t\t\tuserCache[uid] = RocketChat.models.Users.findById(uid).fetch()[0].username;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tuserCache[uid] = undefined;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn userCache[uid];\n\t\t};\n\n\t\tconst uid = Meteor.userId();\n\t\t//get subscription for message\n\t\tif (result.message) {\n\t\t\tresult.message.docs.forEach((msg) => {\n\n\t\t\t\tconst subscription = getSubscription(msg.rid, uid);\n\n\t\t\t\tif (subscription) {\n\t\t\t\t\tmsg.r = {name: subscription.name, t: subscription.t};\n\t\t\t\t\tmsg.username = getUsername(msg.user);\n\t\t\t\t\tmsg.valid = true;\n\t\t\t\t\tSearchLogger.debug(`user ${ uid } can access ${ msg.rid } ( ${ subscription.t === 'd' ? subscription.username : subscription.name } )`);\n\t\t\t\t} else {\n\t\t\t\t\tSearchLogger.debug(`user ${ uid } can NOT access ${ msg.rid }`);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tresult.message.docs.filter((msg) => {\n\t\t\t\treturn msg.valid;\n\t\t\t});\n\t\t}\n\n\t\tif (result.room) {\n\t\t\tresult.room.docs.forEach((room) => {\n\t\t\t\tconst subscription = getSubscription(room._id, uid);\n\t\t\t\tif (subscription) {\n\t\t\t\t\troom.valid = true;\n\t\t\t\t\tSearchLogger.debug(`user ${ uid } can access ${ room._id } ( ${ subscription.t === 'd' ? subscription.username : subscription.name } )`);\n\t\t\t\t} else {\n\t\t\t\t\tSearchLogger.debug(`user ${ uid } can NOT access ${ room._id }`);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tresult.room.docs.filter((room) => {\n\t\t\t\treturn room.valid;\n\t\t\t});\n\t\t}\n\n\t\treturn result;\n\t}\n}\n\nexport const validationService = new ValidationService();\n"]}