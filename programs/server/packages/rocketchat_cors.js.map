{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:cors/cors.js","meteor://ðŸ’»app/packages/rocketchat:cors/common.js"],"names":["_","module","watch","require","default","v","url","Mongo","tls","DEFAULT_ECDH_CURVE","setConnectionOptions","ignoreUndefined","WebApp","rawConnectHandlers","use","Meteor","bindEnvironment","req","res","next","_body","headers","undefined","isNaN","indexOf","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","buf","setEncoding","on","chunk","RocketChat","debugLevel","console","log","green","method","body","JSON","parse","error","test","setHeader","key","val","toLowerCase","apply","arguments","_staticFilesMiddleware","WebAppInternals","staticFilesMiddleware","staticFiles","oldHttpServerListeners","httpServer","listeners","slice","removeAllListeners","addListener","oldListener","settings","get","remoteAddress","connection","socket","localhostRegexp","localhostTest","x","isLocal","all","split","isSsl","pair","host","absoluteUrl","hostname","replace","writeHead","end","startup","onload","value","defaultOptions","secure"],"mappings":"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","file":"/packages/rocketchat_cors.js","sourcesContent":["/* globals WebAppInternals */\nimport _ from 'underscore';\n\nimport url from 'url';\n\nimport { Mongo } from 'meteor/mongo';\nimport tls from 'tls';\n// FIX For TLS error see more here https://github.com/RocketChat/Rocket.Chat/issues/9316\n// TODO: Remove after NodeJS fix it, more information https://github.com/nodejs/node/issues/16196 https://github.com/nodejs/node/pull/16853\ntls.DEFAULT_ECDH_CURVE = 'auto';\n\n// Revert change from Meteor 1.6.1 who set ignoreUndefined: true\n// more information https://github.com/meteor/meteor/pull/9444\nMongo.setConnectionOptions({\n\tignoreUndefined: false\n});\n\nWebApp.rawConnectHandlers.use(Meteor.bindEnvironment(function(req, res, next) {\n\tif (req._body) {\n\t\treturn next();\n\t}\n\tif (req.headers['transfer-encoding'] === undefined && isNaN(req.headers['content-length'])) {\n\t\treturn next();\n\t}\n\tif (req.headers['content-type'] !== '' && req.headers['content-type'] !== undefined) {\n\t\treturn next();\n\t}\n\tif (req.url.indexOf(`${ __meteor_runtime_config__.ROOT_URL_PATH_PREFIX }/ufs/`) === 0) {\n\t\treturn next();\n\t}\n\n\tlet buf = '';\n\treq.setEncoding('utf8');\n\treq.on('data', function(chunk) {\n\t\treturn buf += chunk;\n\t});\n\n\treq.on('end', function() {\n\t\tif (RocketChat && RocketChat.debugLevel === 'debug') {\n\t\t\tconsole.log('[request]'.green, req.method, req.url, '\\nheaders ->', req.headers, '\\nbody ->', buf);\n\t\t}\n\n\t\ttry {\n\t\t\treq.body = JSON.parse(buf);\n\t\t} catch (error) {\n\t\t\treq.body = buf;\n\t\t}\n\t\treq._body = true;\n\n\t\treturn next();\n\t});\n}));\n\nWebApp.rawConnectHandlers.use(function(req, res, next) {\n\tif (/^\\/(api|_timesync|sockjs|tap-i18n|__cordova)(\\/|$)/.test(req.url)) {\n\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t}\n\n\tconst setHeader = res.setHeader;\n\tres.setHeader = function(key, val) {\n\t\tif (key.toLowerCase() === 'access-control-allow-origin' && val === 'http://meteor.local') {\n\t\t\treturn;\n\t\t}\n\t\treturn setHeader.apply(this, arguments);\n\t};\n\treturn next();\n});\n\nconst _staticFilesMiddleware = WebAppInternals.staticFilesMiddleware;\n\nWebAppInternals._staticFilesMiddleware = function(staticFiles, req, res, next) {\n\tres.setHeader('Access-Control-Allow-Origin', '*');\n\treturn _staticFilesMiddleware(staticFiles, req, res, next);\n};\n\nconst oldHttpServerListeners = WebApp.httpServer.listeners('request').slice(0);\n\nWebApp.httpServer.removeAllListeners('request');\n\nWebApp.httpServer.addListener('request', function(req, res) {\n\tconst next = () => {\n\t\tfor (const oldListener of oldHttpServerListeners) {\n\t\t\toldListener.apply(WebApp.httpServer, arguments);\n\t\t}\n\t};\n\n\tif (RocketChat.settings.get('Force_SSL') !== true) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\tconst remoteAddress = req.connection.remoteAddress || req.socket.remoteAddress;\n\tconst localhostRegexp = /^\\s*(127\\.0\\.0\\.1|::1)\\s*$/;\n\tconst localhostTest = function(x) {\n\t\treturn localhostRegexp.test(x);\n\t};\n\n\tconst isLocal = localhostRegexp.test(remoteAddress) && (!req.headers['x-forwarded-for'] || _.all(req.headers['x-forwarded-for'].split(','), localhostTest));\n\tconst isSsl = req.connection.pair || (req.headers['x-forwarded-proto'] && req.headers['x-forwarded-proto'].indexOf('https') !== -1);\n\n\tif (RocketChat && RocketChat.debugLevel === 'debug') {\n\t\tconsole.log('req.url', req.url);\n\t\tconsole.log('remoteAddress', remoteAddress);\n\t\tconsole.log('isLocal', isLocal);\n\t\tconsole.log('isSsl', isSsl);\n\t\tconsole.log('req.headers', req.headers);\n\t}\n\n\tif (!isLocal && !isSsl) {\n\t\tlet host = req.headers['host'] || url.parse(Meteor.absoluteUrl()).hostname;\n\t\thost = host.replace(/:\\d+$/, '');\n\t\tres.writeHead(302, {\n\t\t\t'Location': `https://${ host }${ req.url }`\n\t\t});\n\t\tres.end();\n\t\treturn;\n\t}\n\n\treturn next();\n});\n","Meteor.startup(function() {\n\tRocketChat.settings.onload('Force_SSL', function(key, value) {\n\t\tMeteor.absoluteUrl.defaultOptions.secure = value;\n\t});\n});\n"]}