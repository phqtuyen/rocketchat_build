{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:reactions/server/models/Messages.js","meteor://ðŸ’»app/packages/rocketchat:reactions/setReaction.js"],"names":["RocketChat","models","Messages","setReactions","messageId","reactions","update","_id","$set","unsetReactions","$unset","_","module","watch","require","default","v","Meteor","methods","setReaction","reaction","userId","Error","method","message","findOneById","room","call","rid","replace","emoji","list","EmojiCustom","findByNameOrAlias","count","user","Array","isArray","muted","indexOf","username","reactWhenReadOnly","Notifications","notifyUser","Random","id","ts","Date","msg","TAPi18n","__","language","Subscriptions","findOne","usernames","splice","length","isEmpty","callbacks","run","push","msgStream","emit"],"mappings":"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","file":"/packages/rocketchat_reactions.js","sourcesContent":["RocketChat.models.Messages.setReactions = function(messageId, reactions) {\n\treturn this.update({ _id: messageId }, { $set: { reactions }});\n};\n\nRocketChat.models.Messages.unsetReactions = function(messageId) {\n\treturn this.update({ _id: messageId }, { $unset: { reactions: 1 }});\n};\n","/* globals msgStream */\nimport _ from 'underscore';\n\nMeteor.methods({\n\tsetReaction(reaction, messageId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'setReaction' });\n\t\t}\n\n\t\tconst message = RocketChat.models.Messages.findOneById(messageId);\n\n\t\tif (!message) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'setReaction' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', message.rid, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'setReaction' });\n\t\t}\n\n\t\treaction = `:${ reaction.replace(/:/g, '') }:`;\n\n\t\tif (!RocketChat.emoji.list[reaction] && RocketChat.models.EmojiCustom.findByNameOrAlias(reaction).count() === 0) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Invalid emoji provided.', { method: 'setReaction' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif (Array.isArray(room.muted) && room.muted.indexOf(user.username) !== -1 && !room.reactWhenReadOnly) {\n\t\t\tRocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {\n\t\t\t\t_id: Random.id(),\n\t\t\t\trid: room._id,\n\t\t\t\tts: new Date(),\n\t\t\t\tmsg: TAPi18n.__('You_have_been_muted', {}, user.language)\n\t\t\t});\n\t\t\treturn false;\n\t\t} else if (!RocketChat.models.Subscriptions.findOne({ rid: message.rid })) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (message.reactions && message.reactions[reaction] && message.reactions[reaction].usernames.indexOf(user.username) !== -1) {\n\t\t\tmessage.reactions[reaction].usernames.splice(message.reactions[reaction].usernames.indexOf(user.username), 1);\n\n\t\t\tif (message.reactions[reaction].usernames.length === 0) {\n\t\t\t\tdelete message.reactions[reaction];\n\t\t\t}\n\n\t\t\tif (_.isEmpty(message.reactions)) {\n\t\t\t\tdelete message.reactions;\n\t\t\t\tRocketChat.models.Messages.unsetReactions(messageId);\n\t\t\t\tRocketChat.callbacks.run('unsetReaction', messageId, reaction);\n\t\t\t} else {\n\t\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\t\tRocketChat.callbacks.run('setReaction', messageId, reaction);\n\t\t\t}\n\t\t} else {\n\t\t\tif (!message.reactions) {\n\t\t\t\tmessage.reactions = {};\n\t\t\t}\n\t\t\tif (!message.reactions[reaction]) {\n\t\t\t\tmessage.reactions[reaction] = {\n\t\t\t\t\tusernames: []\n\t\t\t\t};\n\t\t\t}\n\t\t\tmessage.reactions[reaction].usernames.push(user.username);\n\n\t\t\tRocketChat.models.Messages.setReactions(messageId, message.reactions);\n\t\t\tRocketChat.callbacks.run('setReaction', messageId, reaction);\n\t\t}\n\n\t\tmsgStream.emit(message.rid, message);\n\n\t\treturn;\n\t}\n});\n"]}