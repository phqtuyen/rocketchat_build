{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:livechat/livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/startup.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/visitorStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/externalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/leadCapture.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/markRoomResponded.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/offlineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/RDStation.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToCRM.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/hooks/sendToFacebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/addManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/changeLivechatStatus.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeByVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/closeRoom.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/facebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getCustomFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getAgentData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getInitialData.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/getNextAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loadHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/loginByToken.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/pageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/registerGuest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeManager.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/removeTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveSurveyFeedback.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/searchAgent.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendMessageLivechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendOfflineMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/setDepartmentForVisitor.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/startVideoCall.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/transfer.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/webhookTest.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/takeInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/returnAsInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/saveOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/methods/sendTranscript.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Users.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/Rooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatExternalMessage.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatCustomField.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartment.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatDepartmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatTrigger.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/indexes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatInquiry.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatOfficeHour.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/models/LivechatVisitors.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/Livechat.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/QueueMethods.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OfficeClock.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/lib/OmniChannel.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/sendMessageBySMS.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/unclosedLivechats.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/customFields.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/departmentAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/externalMessages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAgents.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatAppearance.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatDepartments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatIntegration.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatManagers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatRooms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatQueue.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatTriggers.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorHistory.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorInfo.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/visitorPageVisited.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatInquiries.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/publications/livechatOfficeHours.js","meteor://ðŸ’»app/packages/rocketchat:livechat/server/api.js","meteor://ðŸ’»app/packages/rocketchat:livechat/permissions.js","meteor://ðŸ’»app/packages/rocketchat:livechat/messageTypes.js","meteor://ðŸ’»app/packages/rocketchat:livechat/roomType.js","meteor://ðŸ’»app/packages/rocketchat:livechat/config.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/departments.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/facebook.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/messages.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/sms.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/users.js","meteor://ðŸ’»app/packages/rocketchat:livechat/imports/server/rest/visitors.js"],"names":["_","module","watch","require","default","v","url","WebApp","Package","webapp","Autoupdate","autoupdate","connectHandlers","use","Meteor","bindEnvironment","req","res","next","reqUrl","parse","pathname","setHeader","domainWhiteList","RocketChat","settings","get","headers","referer","isEmpty","trim","map","split","domain","contains","host","protocol","head","Assets","getText","baseUrl","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","test","html","autoupdateVersion","JSON","stringify","write","end","startup","roomTypes","setRoomFind","code","models","Rooms","findLivechatByCode","authz","addRoomAccessValidator","room","user","t","hasPermission","_id","extraData","token","callbacks","add","Error","TAPi18n","__","lng","language","priority","LOW","UserPresenceEvents","on","session","status","metadata","visitor","LivechatInquiry","updateVisitorStatus","knowledgeEnabled","apiaiKey","apiaiLanguage","key","value","message","editedAt","defer","response","HTTP","post","data","query","msg","lang","sessionId","result","fulfillment","speech","LivechatExternalMessage","insert","rid","orig","ts","Date","e","SystemLogger","error","LivechatVisitors","validateMessage","phoneRegexp","RegExp","msgPhones","match","emailRegexp","msgEmails","saveGuestEmailPhoneById","run","waitingResponse","now","setResponseByRoomId","u","username","responseDate","responseTime","getTime","postData","type","sentAt","name","email","Livechat","sendRequest","MEDIUM","sendToRDStation","livechatData","getLivechatRoomGuestInfo","options","token_rdstation","identificador","client_id","nome","phone","telefone","tags","Object","keys","customFields","forEach","field","call","console","sendToCRM","includeMessages","messages","Messages","findVisibleByRoomId","sort","Array","agentId","push","saveCRMDataByRoomId","open","OmniChannel","facebook","reply","page","id","text","methods","userId","method","addAgent","addManager","newStatus","statusLivechat","Users","setLivechatStatus","roomId","findOneOpenByVisitorToken","getVisitorByToken","closeRoom","comment","findOneById","usernames","indexOf","action","enabled","hasToken","enable","success","updateById","disable","listPages","subscribe","unsubscribe","LivechatCustomField","find","fetch","check","String","servedBy","getAgentInfo","visitorToken","info","title","color","registrationForm","triggers","departments","allowSwitchingDepartments","online","offlineColor","offlineMessage","offlineSuccessMessage","offlineUnavailableMessage","displayOfflineForm","videoCall","conversationFinishedMessage","findOpenByVisitorToken","fields","cl","length","visitorEmails","initSettings","getInitSettings","Livechat_title","Livechat_title_color","Livechat_enabled","Livechat_registration_form","offlineTitle","Livechat_offline_title","Livechat_offline_title_color","Livechat_offline_message","Livechat_offline_success_message","Livechat_offline_form_unavailable","Livechat_display_offline_form","Language","Livechat_videocall_enabled","Jitsi_Enabled","transcript","Livechat_enable_transcript","transcriptMessage","Livechat_transcript_message","Livechat_conversation_finished_message","agentData","LivechatTrigger","findEnabled","trigger","pick","LivechatDepartment","findEnabledWithAgents","department","Livechat_allow_switching_departments","findOnlineAgents","count","requireDeparment","getRequiredDepartment","agent","getNextAgent","limit","ls","loadMessageHistory","pageInfo","savePageHistory","registerGuest","LivechatPageVisited","keepHistoryForToken","removeAgent","customField","removeById","removeDepartment","removeManager","triggerId","validSettings","valid","every","setting","customFieldData","Match","ObjectIncluding","label","scope","visibility","createOrUpdateCustomField","departmentData","departmentAgents","saveDepartment","guestData","roomData","Optional","topic","ret","saveGuest","saveRoomInfo","s","values","visitorRoom","formData","undefined","updateData","item","updateSurveyFeedbackById","Maybe","description","Boolean","conditions","actions","isString","findOneByUsername","sendMessageLivechat","guest","sendMessage","dns","header","placeholders","replace","footer","fromEmail","emailDomain","substr","lastIndexOf","wrapAsync","resolveMx","Email","send","to","from","replyTo","subject","substring","DDPRateLimiter","addRule","connectionId","overwrite","updateLivechatDataByToken","setDepartmentForGuest","Random","getRoom","jitsiTimeout","createWithTypeRoomIdMessageAndUser","actionLinks","icon","i18nLabel","method_id","params","jitsiRoom","transferData","departmentId","hasRole","transfer","postCatchError","resolve","err","unblock","sampleData","createdAt","lastMessageAt","productId","ip","browser","os","customerId","log","statusCode","inquiryId","inquiry","subscriptionData","alert","unread","userMentions","groupMentions","desktopNotifications","mobilePushNotifications","emailNotifications","Subscriptions","changeAgentByRoomId","takeInquiry","createCommandWithRoomIdAndUser","stream","emit","removeByRoomId","removeUsernameById","findOne","openInquiry","day","start","finish","LivechatOfficeHour","updateHours","moment","userLanguage","author","datetime","locale","format","singleMessage","emailSettings","setOperator","operator","update","$set","$exists","$ne","roles","findOneOnlineAgentByUsername","findAgents","findOnlineUserFromList","userList","$in","concat","collectionObj","model","rawCollection","findAndModify","livechatCount","$inc","closeOffice","self","openOffice","emails","surveyFeedback","findLivechat","filter","offset","extend","parseInt","getNextLivechatRoomCode","settingsRaw","Settings","findByVisitorToken","findByVisitorId","visitorId","responseBy","$unset","closeByRoomId","closeInfo","closer","closedBy","closedAt","chatDuration","setLabelByRoomId","findOpenByAgent","newAgent","crmData","_Base","constructor","isClient","_initModel","findByRoomId","record","remove","tryEnsureIndex","numAgents","findByDepartmentId","createOrUpdateDepartment","showOnRegistration","agents","savedAgents","pluck","LivechatDepartmentAgents","agentsToSave","difference","removeByDepartmentIdAndAgentId","saveAgent","order","$gt","upsert","getNextAgentForDepartment","onlineUsers","onlineUsernames","getOnlineForDepartment","depAgents","findUsersInQueue","usersList","replaceUsernameOfAgentByUserId","multi","sparse","expireAfterSeconds","saveByToken","keepHistoryMiliseconds","expireAt","findByToken","removeAll","findById","getStatus","newStart","newFinish","newOpen","isNowWithinHours","currentTime","utc","todaysOfficeHours","isBefore","isBetween","isOpeningTime","isSame","isClosingTime","findVisitorByToken","findOneVisitorByPhone","getNextVisitorUsername","saveGuestById","setData","unsetData","address","phoneNumber","findOneGuestByEmailAddress","emailAddress","escapeRegExp","phones","$addToSet","saveEmail","$each","savePhone","exportDefault","UAParser","historyMonitorType","logger","Logger","sections","webhook","i","queryString","getAgents","getOnlineAgents","onlineRequired","dept","onlineAgents","roomInfo","newRoom","routingMethod","QueueMethods","alias","showConnecting","updateUser","existingUser","userData","connection","userAgent","httpHeaders","clientAddress","number","users","closeData","groupable","hideByRoomIdAndUserId","findNotHiddenPublic","setTopicAndTagsById","updateNameByRoomId","closeOpenChats","forwardOpenChats","change","without","removeByRoomIdAndUserId","createUserLeaveWithRoomIdAndUser","createUserJoinWithRoomIdAndUser","callback","trying","warn","setTimeout","ua","setUA","lm","getOS","version","getBrowser","addUserRoles","removeUserFromRoles","Streamer","allowRead","roomCode","msgs","agentIds","setInterval","gatewayURL","pageId","SMS","sms","SMSService","getService","agentsHandler","monitorAgents","actionTimeout","queue","clearTimeout","exists","runAgentLeaveAction","observeChanges","added","changed","removed","stop","UserPresenceMonitor","onSetUserStatus","publish","handle","getUsersInRole","ready","onStop","findByIds","$gte","setDate","getDate","setSeconds","getSeconds","$lte","handleDepts","Roles","createOrUpdate","Permissions","MessageTypes","registerType","system","register","instance","tabBar","isServer","Notifications","notifyRoom","setHiddenById","RoomSettingsEnum","RoomTypeConfig","RoomTypeRouteConfig","UiTextContext","LivechatRoomRoute","path","openRoom","link","sub","LivechatRoomType","identifier","route","notSubscribedTpl","template","findRoom","ChatRoom","roomName","condition","hasAllPermission","canSendMessage","getUserStatus","Session","allowRoomSettingChange","JOIN_CODE","getUiText","context","HIDE_WARNING","LEAVE_WARNING","addGroup","group","public","section","i18nDescription","enableQuery","API","v1","addRoute","authRequired","unauthorized","bodyParams","failure","urlParams","put","delete","crypto","attachments","request","signature","createHmac","body","digest","mid","rooms","first_name","last_name","sucess","sentMessages","sentMessage","service","media","curr","attachment","message_link","contentType","image_url","video_url","audio_url","extra","fromCountry","fromState","fromCity","role"],"mappings":"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","file":"/packages/rocketchat_livechat.js","sourcesContent":["/* globals WebApp:true */\nimport _ from 'underscore';\nimport url from 'url';\n\nWebApp = Package.webapp.WebApp;\nconst Autoupdate = Package.autoupdate.Autoupdate;\n\nWebApp.connectHandlers.use('/livechat', Meteor.bindEnvironment((req, res, next) => {\n\tconst reqUrl = url.parse(req.url);\n\tif (reqUrl.pathname !== '/') {\n\t\treturn next();\n\t}\n\tres.setHeader('content-type', 'text/html; charset=utf-8');\n\n\tlet domainWhiteList = RocketChat.settings.get('Livechat_AllowedDomainsList');\n\tif (req.headers.referer && !_.isEmpty(domainWhiteList.trim())) {\n\t\tdomainWhiteList = _.map(domainWhiteList.split(','), function(domain) {\n\t\t\treturn domain.trim();\n\t\t});\n\n\t\tconst referer = url.parse(req.headers.referer);\n\t\tif (!_.contains(domainWhiteList, referer.host)) {\n\t\t\tres.setHeader('X-FRAME-OPTIONS', 'DENY');\n\t\t\treturn next();\n\t\t}\n\n\t\tres.setHeader('X-FRAME-OPTIONS', `ALLOW-FROM ${ referer.protocol }//${ referer.host }`);\n\t}\n\n\tconst head = Assets.getText('public/head.html');\n\n\tlet baseUrl;\n\tif (__meteor_runtime_config__.ROOT_URL_PATH_PREFIX && __meteor_runtime_config__.ROOT_URL_PATH_PREFIX.trim() !== '') {\n\t\tbaseUrl = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX;\n\t} else {\n\t\tbaseUrl = '/';\n\t}\n\tif (/\\/$/.test(baseUrl) === false) {\n\t\tbaseUrl += '/';\n\t}\n\n\tconst html = `<html>\n\t\t<head>\n\t\t\t<link rel=\"stylesheet\" type=\"text/css\" class=\"__meteor-css__\" href=\"${ baseUrl }livechat/livechat.css?_dc=${ Autoupdate.autoupdateVersion }\">\n\t\t\t<script type=\"text/javascript\">\n\t\t\t\t__meteor_runtime_config__ = ${ JSON.stringify(__meteor_runtime_config__) };\n\t\t\t</script>\n\n\t\t\t<base href=\"${ baseUrl }\">\n\n\t\t\t${ head }\n\t\t</head>\n\t\t<body>\n\t\t\t<script type=\"text/javascript\" src=\"${ baseUrl }livechat/livechat.js?_dc=${ Autoupdate.autoupdateVersion }\"></script>\n\t\t</body>\n\t</html>`;\n\n\tres.write(html);\n\tres.end();\n}));\n","Meteor.startup(() => {\n\tRocketChat.roomTypes.setRoomFind('l', (code) => {\n\t\treturn RocketChat.models.Rooms.findLivechatByCode(code);\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user) {\n\t\treturn room.t === 'l' && user && RocketChat.authz.hasPermission(user._id, 'view-livechat-rooms');\n\t});\n\n\tRocketChat.authz.addRoomAccessValidator(function(room, user, extraData) {\n\t\treturn room.t === 'l' && extraData && extraData.token && room.v && room.v.token === extraData.token;\n\t});\n\n\tRocketChat.callbacks.add('beforeLeaveRoom', function(user, room) {\n\t\tif (room.t !== 'l') {\n\t\t\treturn user;\n\t\t}\n\t\tthrow new Meteor.Error(TAPi18n.__('You_cant_leave_a_livechat_room_Please_use_the_close_button', {\n\t\t\tlng: user.language || RocketChat.settings.get('language') || 'en'\n\t\t}));\n\t}, RocketChat.callbacks.priority.LOW, 'cant-leave-room');\n});\n","/* globals UserPresenceEvents */\nMeteor.startup(() => {\n\tUserPresenceEvents.on('setStatus', (session, status, metadata) => {\n\t\tif (metadata && metadata.visitor) {\n\t\t\tRocketChat.models.LivechatInquiry.updateVisitorStatus(metadata.visitor, status);\n\t\t\tRocketChat.models.Rooms.updateVisitorStatus(metadata.visitor, status);\n\t\t}\n\t});\n});\n","/* globals HTTP, SystemLogger */\nimport _ from 'underscore';\n\nlet knowledgeEnabled = false;\nlet apiaiKey = '';\nlet apiaiLanguage = 'en';\nRocketChat.settings.get('Livechat_Knowledge_Enabled', function(key, value) {\n\tknowledgeEnabled = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Key', function(key, value) {\n\tapiaiKey = value;\n});\nRocketChat.settings.get('Livechat_Knowledge_Apiai_Language', function(key, value) {\n\tapiaiLanguage = value;\n});\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!knowledgeEnabled) {\n\t\treturn message;\n\t}\n\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message hasn't a token, it was not sent by the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\ttry {\n\t\t\tconst response = HTTP.post('https://api.api.ai/api/query?v=20150910', {\n\t\t\t\tdata: {\n\t\t\t\t\tquery: message.msg,\n\t\t\t\t\tlang: apiaiLanguage,\n\t\t\t\t\tsessionId: room._id\n\t\t\t\t},\n\t\t\t\theaders: {\n\t\t\t\t\t'Content-Type': 'application/json; charset=utf-8',\n\t\t\t\t\t'Authorization': `Bearer ${ apiaiKey }`\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (response.data && response.data.status.code === 200 && !_.isEmpty(response.data.result.fulfillment.speech)) {\n\t\t\t\tRocketChat.models.LivechatExternalMessage.insert({\n\t\t\t\t\trid: message.rid,\n\t\t\t\t\tmsg: response.data.result.fulfillment.speech,\n\t\t\t\t\torig: message._id,\n\t\t\t\t\tts: new Date()\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error using Api.ai ->', e);\n\t\t}\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'externalWebHook');\n","import LivechatVisitors from '../../server/models/LivechatVisitors';\n\nfunction validateMessage(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn false;\n\t}\n\n\t// message valid only if it is a livechat room\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.v && room.v.token)) {\n\t\treturn false;\n\t}\n\n\t// if the message hasn't a token, it was NOT sent from the visitor, so ignore it\n\tif (!message.token) {\n\t\treturn false;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\tif (!validateMessage(message, room)) {\n\t\treturn message;\n\t}\n\n\tconst phoneRegexp = new RegExp(RocketChat.settings.get('Livechat_lead_phone_regex'), 'g');\n\tconst msgPhones = message.msg.match(phoneRegexp);\n\n\tconst emailRegexp = new RegExp(RocketChat.settings.get('Livechat_lead_email_regex'), 'gi');\n\tconst msgEmails = message.msg.match(emailRegexp);\n\n\tif (msgEmails || msgPhones) {\n\t\tLivechatVisitors.saveGuestEmailPhoneById(room.v._id, msgEmails, msgPhones);\n\n\t\tRocketChat.callbacks.run('livechat.leadCapture', room);\n\t}\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'leadCapture');\n","RocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (!message || message.editedAt) {\n\t\treturn message;\n\t}\n\n\t// check if room is yet awaiting for response\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.waitingResponse)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent by the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\tMeteor.defer(() => {\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.setResponseByRoomId(room._id, {\n\t\t\tuser: {\n\t\t\t\t_id: message.u._id,\n\t\t\t\tusername: message.u.username\n\t\t\t},\n\t\t\tresponseDate: now,\n\t\t\tresponseTime: (now.getTime() - room.ts) / 1000\n\t\t});\n\t});\n\n\treturn message;\n}, RocketChat.callbacks.priority.LOW, 'markRoomResponded');\n","RocketChat.callbacks.add('livechat.offlineMessage', (data) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_offline_msg')) {\n\t\treturn data;\n\t}\n\n\tconst postData = {\n\t\ttype: 'LivechatOfflineMessage',\n\t\tsentAt: new Date(),\n\t\tvisitor: {\n\t\t\tname: data.name,\n\t\t\temail: data.email\n\t\t},\n\t\tmessage: data.message\n\t};\n\n\tRocketChat.Livechat.sendRequest(postData);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-email-offline-message');\n","function sendToRDStation(room) {\n\tif (!RocketChat.settings.get('Livechat_RDStation_Token')) {\n\t\treturn room;\n\t}\n\n\tconst livechatData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tif (!livechatData.visitor.email) {\n\t\treturn room;\n\t}\n\n\tconst options = {\n\t\theaders: {\n\t\t\t'Content-Type': 'application/json'\n\t\t},\n\t\tdata: {\n\t\t\ttoken_rdstation: RocketChat.settings.get('Livechat_RDStation_Token'),\n\t\t\tidentificador: 'rocketchat-livechat',\n\t\t\tclient_id: livechatData.visitor._id,\n\t\t\temail: livechatData.visitor.email\n\t\t}\n\t};\n\n\toptions.data.nome = livechatData.visitor.name || livechatData.visitor.username;\n\n\tif (livechatData.visitor.phone) {\n\t\toptions.data.telefone = livechatData.visitor.phone;\n\t}\n\n\tif (livechatData.tags) {\n\t\toptions.data.tags = livechatData.tags;\n\t}\n\n\tObject.keys(livechatData.customFields || {}).forEach(field => {\n\t\toptions.data[field] = livechatData.customFields[field];\n\t});\n\n\tObject.keys(livechatData.visitor.customFields || {}).forEach(field => {\n\t\toptions.data[field] = livechatData.visitor.customFields[field];\n\t});\n\n\ttry {\n\t\tHTTP.call('POST', 'https://www.rdstation.com.br/api/1.3/conversions', options);\n\t} catch (e) {\n\t\tconsole.error('Error sending lead to RD Station ->', e);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', sendToRDStation, RocketChat.callbacks.priority.MEDIUM, 'livechat-rd-station-save-info');\n","function sendToCRM(type, room, includeMessages = true) {\n\tconst postData = RocketChat.Livechat.getLivechatRoomGuestInfo(room);\n\n\tpostData.type = type;\n\n\tpostData.messages = [];\n\n\tlet messages;\n\tif (typeof includeMessages === 'boolean' && includeMessages) {\n\t\tmessages = RocketChat.models.Messages.findVisibleByRoomId(room._id, { sort: { ts: 1 } });\n\t} else if (includeMessages instanceof Array) {\n\t\tmessages = includeMessages;\n\t}\n\n\tif (messages) {\n\t\tmessages.forEach((message) => {\n\t\t\tif (message.t) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst msg = {\n\t\t\t\t_id: message._id,\n\t\t\t\tusername: message.u.username,\n\t\t\t\tmsg: message.msg,\n\t\t\t\tts: message.ts,\n\t\t\t\teditedAt: message.editedAt\n\t\t\t};\n\n\t\t\tif (message.u.username !== postData.visitor.username) {\n\t\t\t\tmsg.agentId = message.u._id;\n\t\t\t}\n\t\t\tpostData.messages.push(msg);\n\t\t});\n\t}\n\n\tconst response = RocketChat.Livechat.sendRequest(postData);\n\n\tif (response && response.data && response.data.data) {\n\t\tRocketChat.models.Rooms.saveCRMDataByRoomId(room._id, response.data.data);\n\t}\n\n\treturn room;\n}\n\nRocketChat.callbacks.add('livechat.closeRoom', (room) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_close')) {\n\t\treturn room;\n\t}\n\n\treturn sendToCRM('LivechatSession', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-close-room');\n\nRocketChat.callbacks.add('livechat.saveInfo', (room) => {\n\t// Do not send to CRM if the chat is still open\n\tif (room.open) {\n\t\treturn room;\n\t}\n\n\treturn sendToCRM('LivechatEdit', room);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-save-info');\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// only call webhook if it is a livechat room\n\tif (room.t !== 'l' || room.v == null || room.v.token == null) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor\n\t// if not, it was sent from the agent\n\tif (message.token) {\n\t\tif (!RocketChat.settings.get('Livechat_webhook_on_visitor_message')) {\n\t\t\treturn message;\n\t\t}\n\t} else if (!RocketChat.settings.get('Livechat_webhook_on_agent_message')) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tsendToCRM('Message', room, [message]);\n\treturn message;\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-message');\n\nRocketChat.callbacks.add('livechat.leadCapture', (room) => {\n\tif (!RocketChat.settings.get('Livechat_webhook_on_capture')) {\n\t\treturn room;\n\t}\n\treturn sendToCRM('LeadCapture', room, false);\n}, RocketChat.callbacks.priority.MEDIUM, 'livechat-send-crm-lead-capture');\n","import OmniChannel from '../lib/OmniChannel';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled') || !RocketChat.settings.get('Livechat_Facebook_API_Key')) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.facebook && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tOmniChannel.reply({\n\t\tpage: room.facebook.page.id,\n\t\ttoken: room.v.token,\n\t\ttext: message.msg\n\t});\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageToFacebook');\n","Meteor.methods({\n\t'livechat:addAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:addManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.addManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:changeLivechatStatus'() {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:changeLivechatStatus' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tconst newStatus = user.statusLivechat === 'available' ? 'not-available' : 'available';\n\n\t\treturn RocketChat.models.Users.setLivechatStatus(user._id, newStatus);\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:closeByVisitor'({ roomId, token }) {\n\t\tconst room = RocketChat.models.Rooms.findOneOpenByVisitorToken(token, roomId);\n\n\t\tif (!room || !room.open) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\n\t\tconst language = (visitor && visitor.language) || RocketChat.settings.get('language') || 'en';\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tvisitor,\n\t\t\troom,\n\t\t\tcomment: TAPi18n.__('Closed_by_visitor', { lng: language })\n\t\t});\n\t}\n});\n","Meteor.methods({\n\t'livechat:closeRoom'(roomId, comment) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'close-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\t\tif (!room || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('room-not-found', 'Room not found', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\tconst user = Meteor.user();\n\n\t\tif ((!room.usernames || room.usernames.indexOf(user.username) === -1) && !RocketChat.authz.hasPermission(Meteor.userId(), 'close-others-livechat-room')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeRoom' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom,\n\t\t\tcomment\n\t\t});\n\t}\n});\n","import OmniChannel from '../lib/OmniChannel';\n\nMeteor.methods({\n\t'livechat:facebook'(options) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\ttry {\n\t\t\tswitch (options.action) {\n\t\t\t\tcase 'initialState': {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tenabled: RocketChat.settings.get('Livechat_Facebook_Enabled'),\n\t\t\t\t\t\thasToken: !!RocketChat.settings.get('Livechat_Facebook_API_Key')\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tcase 'enable': {\n\t\t\t\t\tconst result = OmniChannel.enable();\n\n\t\t\t\t\tif (!result.success) {\n\t\t\t\t\t\treturn result;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', true);\n\t\t\t\t}\n\n\t\t\t\tcase 'disable': {\n\t\t\t\t\tOmniChannel.disable();\n\n\t\t\t\t\treturn RocketChat.settings.updateById('Livechat_Facebook_Enabled', false);\n\t\t\t\t}\n\n\t\t\t\tcase 'list-pages': {\n\t\t\t\t\treturn OmniChannel.listPages();\n\t\t\t\t}\n\n\t\t\t\tcase 'subscribe': {\n\t\t\t\t\treturn OmniChannel.subscribe(options.page);\n\t\t\t\t}\n\n\t\t\t\tcase 'unsubscribe': {\n\t\t\t\t\treturn OmniChannel.unsubscribe(options.page);\n\t\t\t\t}\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (e.response && e.response.data && e.response.data.error) {\n\t\t\t\tif (e.response.data.error.error) {\n\t\t\t\t\tthrow new Meteor.Error(e.response.data.error.error, e.response.data.error.message);\n\t\t\t\t}\n\t\t\t\tif (e.response.data.error.response) {\n\t\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.response.error.message);\n\t\t\t\t}\n\t\t\t\tif (e.response.data.error.message) {\n\t\t\t\t\tthrow new Meteor.Error('integration-error', e.response.data.error.message);\n\t\t\t\t}\n\t\t\t}\n\t\t\tconsole.error('Error contacting omni.rocket.chat:', e);\n\t\t\tthrow new Meteor.Error('integration-error', e.error);\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:getCustomFields'() {\n\t\treturn RocketChat.models.LivechatCustomField.find().fetch();\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:getAgentData'({ roomId, token }) {\n\t\tcheck(roomId, String);\n\t\tcheck(token, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== visitor.token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tif (!room.servedBy) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(room.servedBy._id);\n\t}\n});\n","import _ from 'underscore';\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:getInitialData'(visitorToken) {\n\t\tconst info = {\n\t\t\tenabled: null,\n\t\t\ttitle: null,\n\t\t\tcolor: null,\n\t\t\tregistrationForm: null,\n\t\t\troom: null,\n\t\t\tvisitor: null,\n\t\t\ttriggers: [],\n\t\t\tdepartments: [],\n\t\t\tallowSwitchingDepartments: null,\n\t\t\tonline: true,\n\t\t\tofflineColor: null,\n\t\t\tofflineMessage: null,\n\t\t\tofflineSuccessMessage: null,\n\t\t\tofflineUnavailableMessage: null,\n\t\t\tdisplayOfflineForm: null,\n\t\t\tvideoCall: null,\n\t\t\tconversationFinishedMessage: null\n\t\t};\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tv: 1,\n\t\t\t\tservedBy: 1\n\t\t\t}\n\t\t}).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\tinfo.room = room[0];\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tvisitorEmails: 1\n\t\t\t}\n\t\t});\n\n\t\tif (room) {\n\t\t\tinfo.visitor = visitor;\n\t\t}\n\n\t\tconst initSettings = RocketChat.Livechat.getInitSettings();\n\n\t\tinfo.title = initSettings.Livechat_title;\n\t\tinfo.color = initSettings.Livechat_title_color;\n\t\tinfo.enabled = initSettings.Livechat_enabled;\n\t\tinfo.registrationForm = initSettings.Livechat_registration_form;\n\t\tinfo.offlineTitle = initSettings.Livechat_offline_title;\n\t\tinfo.offlineColor = initSettings.Livechat_offline_title_color;\n\t\tinfo.offlineMessage = initSettings.Livechat_offline_message;\n\t\tinfo.offlineSuccessMessage = initSettings.Livechat_offline_success_message;\n\t\tinfo.offlineUnavailableMessage = initSettings.Livechat_offline_form_unavailable;\n\t\tinfo.displayOfflineForm = initSettings.Livechat_display_offline_form;\n\t\tinfo.language = initSettings.Language;\n\t\tinfo.videoCall = initSettings.Livechat_videocall_enabled === true && initSettings.Jitsi_Enabled === true;\n\t\tinfo.transcript = initSettings.Livechat_enable_transcript;\n\t\tinfo.transcriptMessage = initSettings.Livechat_transcript_message;\n\t\tinfo.conversationFinishedMessage = initSettings.Livechat_conversation_finished_message;\n\n\t\tinfo.agentData = room && room[0] && room[0].servedBy && RocketChat.models.Users.getAgentInfo(room[0].servedBy._id);\n\n\t\tRocketChat.models.LivechatTrigger.findEnabled().forEach((trigger) => {\n\t\t\tinfo.triggers.push(_.pick(trigger, '_id', 'actions', 'conditions'));\n\t\t});\n\n\t\tRocketChat.models.LivechatDepartment.findEnabledWithAgents().forEach((department) => {\n\t\t\tinfo.departments.push(department);\n\t\t});\n\t\tinfo.allowSwitchingDepartments = initSettings.Livechat_allow_switching_departments;\n\n\t\tinfo.online = RocketChat.models.Users.findOnlineAgents().count() > 0;\n\n\t\treturn info;\n\t}\n});\n","Meteor.methods({\n\t'livechat:getNextAgent'({ token, department }) {\n\t\tcheck(token, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOpenByVisitorToken(token).fetch();\n\n\t\tif (room && room.length > 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!department) {\n\t\t\tconst requireDeparment = RocketChat.Livechat.getRequiredDepartment();\n\t\t\tif (requireDeparment) {\n\t\t\t\tdepartment = requireDeparment._id;\n\t\t\t}\n\t\t}\n\n\t\tconst agent = RocketChat.Livechat.getNextAgent(department);\n\t\tif (!agent) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.models.Users.getAgentInfo(agent.agentId);\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:loadHistory'({ token, rid, end, limit = 20, ls}) {\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!visitor) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn RocketChat.loadMessageHistory({ userId: visitor._id, rid, end, limit, ls });\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:loginByToken'(token) {\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn {\n\t\t\t_id: user._id\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:pageVisited'(token, pageInfo) {\n\t\treturn RocketChat.Livechat.savePageHistory(token, pageInfo);\n\t}\n});\n","Meteor.methods({\n\t'livechat:registerGuest'({ token, name, email, department } = {}) {\n\t\tconst userId = RocketChat.Livechat.registerGuest.call(this, {\n\t\t\ttoken,\n\t\t\tname,\n\t\t\temail,\n\t\t\tdepartment\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.LivechatPageVisited.keepHistoryForToken(token);\n\n\t\treturn {\n\t\t\tuserId\n\t\t};\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeAgent(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeCustomField'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\tcheck(_id, String);\n\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!customField) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom field not found', { method: 'livechat:removeCustomField' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.removeById(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeDepartment'(_id) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeDepartment(_id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeManager'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.removeManager(username);\n\t}\n});\n","Meteor.methods({\n\t'livechat:removeTrigger'(triggerId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:removeTrigger' });\n\t\t}\n\n\t\tcheck(triggerId, String);\n\n\t\treturn RocketChat.models.LivechatTrigger.removeById(triggerId);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveAppearance'(settings) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveAppearance' });\n\t\t}\n\n\t\tconst validSettings = [\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_show_agent_email',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_email',\n\t\t\t'Livechat_conversation_finished_message'\n\t\t];\n\n\t\tconst valid = settings.every((setting) => {\n\t\t\treturn validSettings.indexOf(setting._id) !== -1;\n\t\t});\n\n\t\tif (!valid) {\n\t\t\tthrow new Meteor.Error('invalid-setting');\n\t\t}\n\n\t\tsettings.forEach((setting) => {\n\t\t\tRocketChat.settings.updateById(setting._id, setting.value);\n\t\t});\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveCustomField'(_id, customFieldData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tcheck(_id, String);\n\t\t}\n\n\t\tcheck(customFieldData, Match.ObjectIncluding({ field: String, label: String, scope: String, visibility: String }));\n\n\t\tif (!/^[0-9a-zA-Z-_]+$/.test(customFieldData.field)) {\n\t\t\tthrow new Meteor.Error('error-invalid-custom-field-nmae', 'Invalid custom field name. Use only letters, numbers, hyphens and underscores.', { method: 'livechat:saveCustomField' });\n\t\t}\n\n\t\tif (_id) {\n\t\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(_id);\n\t\t\tif (!customField) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-custom-field', 'Custom Field Not found', { method: 'livechat:saveCustomField' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatCustomField.createOrUpdateCustomField(_id, customFieldData.field, customFieldData.label, customFieldData.scope, customFieldData.visibility);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveDepartment'(_id, departmentData, departmentAgents) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.saveDepartment(_id, departmentData, departmentAgents);\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\", \"Match.Optional\"]}] */\n\nMeteor.methods({\n\t'livechat:saveInfo'(guestData, roomData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tcheck(guestData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\tname: Match.Optional(String),\n\t\t\temail: Match.Optional(String),\n\t\t\tphone: Match.Optional(String)\n\t\t}));\n\n\t\tcheck(roomData, Match.ObjectIncluding({\n\t\t\t_id: String,\n\t\t\ttopic: Match.Optional(String),\n\t\t\ttags: Match.Optional(String)\n\t\t}));\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(roomData._id, {fields: {t: 1, servedBy: 1}});\n\n\t\tif (room == null || room.t !== 'l') {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tif ((!room.servedBy || room.servedBy._id !== Meteor.userId()) && !RocketChat.authz.hasPermission(Meteor.userId(), 'save-others-livechat-room-info')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveInfo' });\n\t\t}\n\n\t\tconst ret = RocketChat.Livechat.saveGuest(guestData) && RocketChat.Livechat.saveRoomInfo(roomData, guestData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveInfo', RocketChat.models.Rooms.findOneById(roomData._id));\n\t\t});\n\n\t\treturn ret;\n\t}\n});\n","import s from 'underscore.string';\n\nMeteor.methods({\n\t'livechat:saveIntegration'(values) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveIntegration' });\n\t\t}\n\n\t\tif (typeof values['Livechat_webhookUrl'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhookUrl', s.trim(values['Livechat_webhookUrl']));\n\t\t}\n\n\t\tif (typeof values['Livechat_secret_token'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_secret_token', s.trim(values['Livechat_secret_token']));\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_close'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_close', !!values['Livechat_webhook_on_close']);\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_offline_msg'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_offline_msg', !!values['Livechat_webhook_on_offline_msg']);\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_visitor_message'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_visitor_message', !!values['Livechat_webhook_on_visitor_message']);\n\t\t}\n\n\t\tif (typeof values['Livechat_webhook_on_agent_message'] !== 'undefined') {\n\t\t\tRocketChat.settings.updateById('Livechat_webhook_on_agent_message', !!values['Livechat_webhook_on_agent_message']);\n\t\t}\n\n\t\treturn;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.ObjectIncluding\"]}] */\nimport LivechatVisitors from '../models/LivechatVisitors';\nimport _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:saveSurveyFeedback'(visitorToken, visitorRoom, formData) {\n\t\tcheck(visitorToken, String);\n\t\tcheck(visitorRoom, String);\n\t\tcheck(formData, [Match.ObjectIncluding({ name: String, value: String })]);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\t\tconst room = RocketChat.models.Rooms.findOneById(visitorRoom);\n\n\t\tif (visitor !== undefined && room !== undefined && room.v !== undefined && room.v.token === visitor.token) {\n\t\t\tconst updateData = {};\n\t\t\tfor (const item of formData) {\n\t\t\t\tif (_.contains(['satisfaction', 'agentKnowledge', 'agentResposiveness', 'agentFriendliness'], item.name) && _.contains(['1', '2', '3', '4', '5'], item.value)) {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t} else if (item.name === 'additionalFeedback') {\n\t\t\t\t\tupdateData[item.name] = item.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!_.isEmpty(updateData)) {\n\t\t\t\treturn RocketChat.models.Rooms.updateSurveyFeedbackById(room._id, updateData);\n\t\t\t}\n\t\t}\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveTrigger'(trigger) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveTrigger' });\n\t\t}\n\n\t\tcheck(trigger, {\n\t\t\t_id: Match.Maybe(String),\n\t\t\tname: String,\n\t\t\tdescription: String,\n\t\t\tenabled: Boolean,\n\t\t\tconditions: Array,\n\t\t\tactions: Array\n\t\t});\n\n\t\tif (trigger._id) {\n\t\t\treturn RocketChat.models.LivechatTrigger.updateById(trigger._id, trigger);\n\t\t} else {\n\t\t\treturn RocketChat.models.LivechatTrigger.insert(trigger);\n\t\t}\n\t}\n});\n","import _ from 'underscore';\n\nMeteor.methods({\n\t'livechat:searchAgent'(username) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tif (!username || !_.isString(username)) {\n\t\t\tthrow new Meteor.Error('error-invalid-arguments', 'Invalid arguments', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:searchAgent' });\n\t\t}\n\n\t\treturn user;\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\tsendMessageLivechat({ token, _id, rid, msg }, agent) {\n\t\tcheck(token, String);\n\t\tcheck(_id, String);\n\t\tcheck(rid, String);\n\t\tcheck(msg, String);\n\n\t\tcheck(agent, Match.Maybe({\n\t\t\tagentId: String,\n\t\t\tusername: String\n\t\t}));\n\n\t\tconst guest = LivechatVisitors.getVisitorByToken(token, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tusername: 1,\n\t\t\t\tdepartment: 1,\n\t\t\t\ttoken: 1\n\t\t\t}\n\t\t});\n\n\t\tif (!guest) {\n\t\t\tthrow new Meteor.Error('invalid-token');\n\t\t}\n\n\t\treturn RocketChat.Livechat.sendMessage({\n\t\t\tguest,\n\t\t\tmessage: {\n\t\t\t\t_id,\n\t\t\t\trid,\n\t\t\t\tmsg,\n\t\t\t\ttoken\n\t\t\t},\n\t\t\tagent\n\t\t});\n\t}\n});\n","/* globals DDPRateLimiter */\nimport dns from 'dns';\n\nMeteor.methods({\n\t'livechat:sendOfflineMessage'(data) {\n\t\tcheck(data, {\n\t\t\tname: String,\n\t\t\temail: String,\n\t\t\tmessage: String\n\t\t});\n\n\t\tif (!RocketChat.settings.get('Livechat_display_offline_form')) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tconst message = (`${ data.message }`).replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + '<br>' + '$2');\n\n\t\tconst html = `\n\t\t\t<h1>New livechat message</h1>\n\t\t\t<p><strong>Visitor name:</strong> ${ data.name }</p>\n\t\t\t<p><strong>Visitor email:</strong> ${ data.email }</p>\n\t\t\t<p><strong>Message:</strong><br>${ message }</p>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\tif (RocketChat.settings.get('Livechat_validate_offline_email')) {\n\t\t\tconst emailDomain = data.email.substr(data.email.lastIndexOf('@') + 1);\n\n\t\t\ttry {\n\t\t\t\tMeteor.wrapAsync(dns.resolveMx)(emailDomain);\n\t\t\t} catch (e) {\n\t\t\t\tthrow new Meteor.Error('error-invalid-email-address', 'Invalid email address', { method: 'livechat:sendOfflineMessage' });\n\t\t\t}\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send({\n\t\t\t\tto: RocketChat.settings.get('Livechat_offline_email'),\n\t\t\t\tfrom: `${ data.name } - ${ data.email } <${ fromEmail }>`,\n\t\t\t\treplyTo: `${ data.name } <${ data.email }>`,\n\t\t\t\tsubject: `Livechat offline message from ${ data.name }: ${ (`${ data.message }`).substring(0, 20) }`,\n\t\t\t\thtml: header + html + footer\n\t\t\t});\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.offlineMessage', data);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendOfflineMessage',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:setCustomField'(token, key, value, overwrite = true) {\n\t\tconst customField = RocketChat.models.LivechatCustomField.findOneById(key);\n\t\tif (customField) {\n\t\t\tif (customField.scope === 'room') {\n\t\t\t\treturn RocketChat.models.Rooms.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t} else {\n\t\t\t\t// Save in user\n\t\t\t\treturn LivechatVisitors.updateLivechatDataByToken(token, key, value, overwrite);\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n});\n","Meteor.methods({\n\t'livechat:setDepartmentForVisitor'({ token, department } = {}) {\n\t\tRocketChat.Livechat.setDepartmentForGuest.call(this, {\n\t\t\ttoken,\n\t\t\tdepartment\n\t\t});\n\n\t\t// update visited page history to not expire\n\t\tRocketChat.models.LivechatPageVisited.keepHistoryForToken(token);\n\n\t\treturn true;\n\t}\n});\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"MD5\"]}] */\nMeteor.methods({\n\t'livechat:startVideoCall'(roomId) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:closeByVisitor' });\n\t\t}\n\n\t\tconst guest = Meteor.user();\n\n\t\tconst message = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId || Random.id(),\n\t\t\tmsg: '',\n\t\t\tts: new Date()\n\t\t};\n\n\t\tconst { room } = RocketChat.Livechat.getRoom(guest, message, { jitsiTimeout: new Date(Date.now() + 3600 * 1000) });\n\t\tmessage.rid = room._id;\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('livechat_video_call', room._id, '', guest, {\n\t\t\tactionLinks: [\n\t\t\t\t{ icon: 'icon-videocam', i18nLabel: 'Accept', method_id: 'createLivechatCall', params: '' },\n\t\t\t\t{ icon: 'icon-cancel', i18nLabel: 'Decline', method_id: 'denyLivechatCall', params: '' }\n\t\t\t]\n\t\t});\n\n\t\treturn {\n\t\t\troomId: room._id,\n\t\t\tdomain: RocketChat.settings.get('Jitsi_Domain'),\n\t\t\tjitsiRoom: RocketChat.settings.get('Jitsi_URL_Room_Prefix') + RocketChat.settings.get('uniqueID') + roomId\n\t\t};\n\t}\n});\n\n","/* eslint new-cap: [2, {\"capIsNewExceptions\": [\"Match.Optional\"]}] */\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:transfer'(transferData) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:transfer' });\n\t\t}\n\n\t\tcheck(transferData, {\n\t\t\troomId: String,\n\t\t\tuserId: Match.Optional(String),\n\t\t\tdepartmentId: Match.Optional(String)\n\t\t});\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(transferData.roomId);\n\n\t\tconst guest = LivechatVisitors.findOneById(room.v._id);\n\n\t\tconst user = Meteor.user();\n\n\t\tif (room.usernames.indexOf(user.username) === -1 && !RocketChat.authz.hasRole(Meteor.userId(), 'livechat-manager')) {\n\t\t\tthrow new Meteor.Error('error-not-authorized', 'Not authorized', { method: 'livechat:transfer' });\n\t\t}\n\n\t\treturn RocketChat.Livechat.transfer(room, guest, transferData);\n\t}\n});\n","/* globals HTTP */\nconst postCatchError = Meteor.wrapAsync(function(url, options, resolve) {\n\tHTTP.post(url, options, function(err, res) {\n\t\tif (err) {\n\t\t\tresolve(null, err.response);\n\t\t} else {\n\t\t\tresolve(null, res);\n\t\t}\n\t});\n});\n\nMeteor.methods({\n\t'livechat:webhookTest'() {\n\t\tthis.unblock();\n\n\t\tconst sampleData = {\n\t\t\ttype: 'LivechatSession',\n\t\t\t_id: 'fasd6f5a4sd6f8a4sdf',\n\t\t\tlabel: 'title',\n\t\t\ttopic: 'asiodojf',\n\t\t\tcode: 123123,\n\t\t\tcreatedAt: new Date(),\n\t\t\tlastMessageAt: new Date(),\n\t\t\ttags: [\n\t\t\t\t'tag1',\n\t\t\t\t'tag2',\n\t\t\t\t'tag3'\n\t\t\t],\n\t\t\tcustomFields: {\n\t\t\t\tproductId: '123456'\n\t\t\t},\n\t\t\tvisitor: {\n\t\t\t\t_id: '',\n\t\t\t\tname: 'visitor name',\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tdepartment: 'department',\n\t\t\t\temail: 'email@address.com',\n\t\t\t\tphone: '192873192873',\n\t\t\t\tip: '123.456.7.89',\n\t\t\t\tbrowser: 'Chrome',\n\t\t\t\tos: 'Linux',\n\t\t\t\tcustomFields: {\n\t\t\t\t\tcustomerId: '123456'\n\t\t\t\t}\n\t\t\t},\n\t\t\tagent: {\n\t\t\t\t_id: 'asdf89as6df8',\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tname: 'Agent Name',\n\t\t\t\temail: 'agent@email.com'\n\t\t\t},\n\t\t\tmessages: [{\n\t\t\t\tusername: 'visitor-username',\n\t\t\t\tmsg: 'message content',\n\t\t\t\tts: new Date()\n\t\t\t}, {\n\t\t\t\tusername: 'agent.username',\n\t\t\t\tagentId: 'asdf89as6df8',\n\t\t\t\tmsg: 'message content from agent',\n\t\t\t\tts: new Date()\n\t\t\t}]\n\t\t};\n\n\t\tconst options = {\n\t\t\theaders: {\n\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t},\n\t\t\tdata: sampleData\n\t\t};\n\n\t\tconst response = postCatchError(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\n\t\tconsole.log('response ->', response);\n\n\t\tif (response && response.statusCode && response.statusCode === 200) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\tthrow new Meteor.Error('error-invalid-webhook-response');\n\t\t}\n\t}\n});\n\n","Meteor.methods({\n\t'livechat:takeInquiry'(inquiryId) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOneById(inquiryId);\n\n\t\tif (!inquiry || inquiry.status === 'taken') {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Inquiry already taken', { method: 'livechat:takeInquiry' });\n\t\t}\n\n\t\tconst user = RocketChat.models.Users.findOneById(Meteor.userId());\n\n\t\tconst agent = {\n\t\t\tagentId: user._id,\n\t\t\tusername: user.username\n\t\t};\n\n\t\t// add subscription\n\t\tconst subscriptionData = {\n\t\t\trid: inquiry.rid,\n\t\t\tname: inquiry.name,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tcode: inquiry.code,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t// update room\n\t\tconst room = RocketChat.models.Rooms.findOneById(inquiry.rid);\n\n\t\tRocketChat.models.Rooms.changeAgentByRoomId(inquiry.rid, agent);\n\n\t\troom.servedBy = {\n\t\t\t_id: agent.agentId,\n\t\t\tusername: agent.username\n\t\t};\n\n\t\t// mark inquiry as taken\n\t\tRocketChat.models.LivechatInquiry.takeInquiry(inquiry._id);\n\n\t\t// remove sending message from guest widget\n\t\t// dont check if setting is true, because if settingwas switched off inbetween  guest entered pool,\n\t\t// and inquiry being taken, message would not be switched off.\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('connected', room._id, user);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t});\n\n\t\t// return room corresponding to inquiry (for redirecting agent to the room route)\n\t\treturn room;\n\t}\n});\n","Meteor.methods({\n\t'livechat:returnAsInquiry'(rid) {\n\t\tif (!Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'view-l-room')) {\n\t\t\tthrow new Meteor.Error('error-not-allowed', 'Not allowed', { method: 'livechat:saveDepartment' });\n\t\t}\n\n\t\t// //delete agent and room subscription\n\t\tRocketChat.models.Subscriptions.removeByRoomId(rid);\n\n\t\t// remove user from room\n\t\tconst username = Meteor.user().username;\n\n\t\tRocketChat.models.Rooms.removeUsernameById(rid, username);\n\n\t\t// find inquiry corresponding to room\n\t\tconst inquiry = RocketChat.models.LivechatInquiry.findOne({rid});\n\n\t\t// mark inquiry as open\n\t\treturn RocketChat.models.LivechatInquiry.openInquiry(inquiry._id);\n\t}\n});\n","Meteor.methods({\n\t'livechat:saveOfficeHours'(day, start, finish, open) {\n\t\tRocketChat.models.LivechatOfficeHour.updateHours(day, start, finish, open);\n\t}\n});\n","/* globals emailSettings, DDPRateLimiter */\n/* Send a transcript of the room converstation to the given email */\nimport moment from 'moment';\n\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.methods({\n\t'livechat:sendTranscript'(token, rid, email) {\n\t\tcheck(rid, String);\n\t\tcheck(email, String);\n\n\t\tconst room = RocketChat.models.Rooms.findOneById(rid);\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(token);\n\t\tconst userLanguage = (visitor && visitor.language) || RocketChat.settings.get('language') || 'en';\n\n\t\t// allow to only user to send transcripts from their own chats\n\t\tif (!room || room.t !== 'l' || !room.v || room.v.token !== token) {\n\t\t\tthrow new Meteor.Error('error-invalid-room', 'Invalid room');\n\t\t}\n\n\t\tconst messages = RocketChat.models.Messages.findVisibleByRoomId(rid, { sort: { 'ts' : 1 }});\n\t\tconst header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');\n\t\tconst footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');\n\n\t\tlet html = '<div> <hr>';\n\t\tmessages.forEach(message => {\n\t\t\tif (message.t && ['command', 'livechat-close', 'livechat_video_call'].indexOf(message.t) !== -1) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet author;\n\t\t\tif (message.u._id === visitor._id) {\n\t\t\t\tauthor = TAPi18n.__('You', { lng: userLanguage });\n\t\t\t} else {\n\t\t\t\tauthor = message.u.username;\n\t\t\t}\n\n\t\t\tconst datetime = moment(message.ts).locale(userLanguage).format('LLL');\n\t\t\tconst singleMessage = `\n\t\t\t\t<p><strong>${ author }</strong>  <em>${ datetime }</em></p>\n\t\t\t\t<p>${ message.msg }</p>\n\t\t\t`;\n\t\t\thtml = html + singleMessage;\n\t\t});\n\n\t\thtml = `${ html }</div>`;\n\n\t\tlet fromEmail = RocketChat.settings.get('From_Email').match(/\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\.)+[A-Z]{2,4}\\b/i);\n\n\t\tif (fromEmail) {\n\t\t\tfromEmail = fromEmail[0];\n\t\t} else {\n\t\t\tfromEmail = RocketChat.settings.get('From_Email');\n\t\t}\n\n\t\temailSettings = {\n\t\t\tto: email,\n\t\t\tfrom: fromEmail,\n\t\t\treplyTo: fromEmail,\n\t\t\tsubject: TAPi18n.__('Transcript_of_your_livechat_conversation', { lng: userLanguage }),\n\t\t\thtml: header + html + footer\n\t\t};\n\n\t\tMeteor.defer(() => {\n\t\t\tEmail.send(emailSettings);\n\t\t});\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.sendTranscript', messages, email);\n\t\t});\n\n\t\treturn true;\n\t}\n});\n\nDDPRateLimiter.addRule({\n\ttype: 'method',\n\tname: 'livechat:sendTranscript',\n\tconnectionId() {\n\t\treturn true;\n\t}\n}, 1, 5000);\n","/**\n * Sets an user as (non)operator\n * @param {string} _id - User's _id\n * @param {boolean} operator - Flag to set as operator or not\n */\nRocketChat.models.Users.setOperator = function(_id, operator) {\n\tconst update = {\n\t\t$set: {\n\t\t\toperator\n\t\t}\n\t};\n\n\treturn this.update(_id, update);\n};\n\n/**\n * Gets all online agents\n * @return\n */\nRocketChat.models.Users.findOnlineAgents = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find an online agent by his username\n * @return\n */\nRocketChat.models.Users.findOneOnlineAgentByUsername = function(username) {\n\tconst query = {\n\t\tusername,\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.findOne(query);\n};\n\n/**\n * Gets all agents\n * @return\n */\nRocketChat.models.Users.findAgents = function() {\n\tconst query = {\n\t\troles: 'livechat-agent'\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Find online users from a list\n * @param {array} userList - array of usernames\n * @return\n */\nRocketChat.models.Users.findOnlineUserFromList = function(userList) {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent',\n\t\tusername: {\n\t\t\t$in: [].concat(userList)\n\t\t}\n\t};\n\n\treturn this.find(query);\n};\n\n/**\n * Get next user agent in order\n * @return {object} User from db\n */\nRocketChat.models.Users.getNextAgent = function() {\n\tconst query = {\n\t\tstatus: {\n\t\t\t$exists: true,\n\t\t\t$ne: 'offline'\n\t\t},\n\t\tstatusLivechat: 'available',\n\t\troles: 'livechat-agent'\n\t};\n\n\tconst collectionObj = this.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\tconst sort = {\n\t\tlivechatCount: 1,\n\t\tusername: 1\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tlivechatCount: 1\n\t\t}\n\t};\n\n\tconst user = findAndModify(query, sort, update);\n\tif (user && user.value) {\n\t\treturn {\n\t\t\tagentId: user.value._id,\n\t\t\tusername: user.value.username\n\t\t};\n\t} else {\n\t\treturn null;\n\t}\n};\n\n/**\n * Change user's livechat status\n * @param {string} token - Visitor token\n */\nRocketChat.models.Users.setLivechatStatus = function(userId, status) {\n\tconst query = {\n\t\t'_id': userId\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t'statusLivechat': status\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\n/**\n * change all livechat agents livechat status to \"not-available\"\n */\nRocketChat.models.Users.closeOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'not-available');\n\t});\n};\n\n/**\n * change all livechat agents livechat status to \"available\"\n */\nRocketChat.models.Users.openOffice = function() {\n\tself = this;\n\tself.findAgents().forEach(function(agent) {\n\t\tself.setLivechatStatus(agent._id, 'available');\n\t});\n};\n\nRocketChat.models.Users.getAgentInfo = function(agentId) {\n\tconst query = {\n\t\t_id: agentId\n\t};\n\n\tconst options = {\n\t\tfields: {\n\t\t\tname: 1,\n\t\t\tusername: 1,\n\t\t\tphone: 1,\n\t\t\tcustomFields: 1\n\t\t}\n\t};\n\n\tif (RocketChat.settings.get('Livechat_show_agent_email')) {\n\t\toptions.fields.emails = 1;\n\t}\n\n\treturn this.findOne(query, options);\n};\n","import _ from 'underscore';\n\n/**\n * Gets visitor by token\n * @param {string} token - Visitor token\n */\nRocketChat.models.Rooms.updateSurveyFeedbackById = function(_id, surveyFeedback) {\n\tconst query = {\n\t\t_id\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\tsurveyFeedback\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateLivechatDataByToken = function(token, key, value, overwrite = true) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true\n\t};\n\n\tif (!overwrite) {\n\t\tconst room = this.findOne(query, { fields: { livechatData: 1 } });\n\t\tif (room.livechatData && typeof room.livechatData[key] !== 'undefined') {\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tconst update = {\n\t\t$set: {\n\t\t\t[`livechatData.${ key }`]: value\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.findLivechat = function(filter = {}, offset = 0, limit = 20) {\n\tconst query = _.extend(filter, {\n\t\tt: 'l'\n\t});\n\n\treturn this.find(query, { sort: { ts: - 1 }, offset, limit });\n};\n\nRocketChat.models.Rooms.findLivechatByCode = function(code, fields) {\n\tcode = parseInt(code);\n\n\tconst options = {};\n\n\tif (fields) {\n\t\toptions.fields = fields;\n\t}\n\n\t// if (this.useCache) {\n\t// \treturn this.cache.findByIndex('t,code', ['l', code], options).fetch();\n\t// }\n\n\tconst query = {\n\t\tt: 'l',\n\t\tcode\n\t};\n\n\treturn this.findOne(query, options);\n};\n\n/**\n * Get the next visitor name\n * @return {string} The next visitor name\n */\nRocketChat.models.Rooms.getNextLivechatRoomCode = function() {\n\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\tconst query = {\n\t\t_id: 'Livechat_Room_Count'\n\t};\n\n\tconst update = {\n\t\t$inc: {\n\t\t\tvalue: 1\n\t\t}\n\t};\n\n\tconst livechatCount = findAndModify(query, null, update);\n\n\treturn livechatCount.value.value;\n};\n\nRocketChat.models.Rooms.findOpenByVisitorToken = function(visitorToken, options) {\n\tconst query = {\n\t\topen: true,\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query, options);\n};\n\nRocketChat.models.Rooms.findByVisitorToken = function(visitorToken) {\n\tconst query = {\n\t\t'v.token': visitorToken\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findByVisitorId = function(visitorId) {\n\tconst query = {\n\t\t'v._id': visitorId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.findOneOpenByVisitorToken = function(token, roomId) {\n\tconst query = {\n\t\t_id: roomId,\n\t\topen: true,\n\t\t'v.token': token\n\t};\n\n\treturn this.findOne(query);\n};\n\nRocketChat.models.Rooms.setResponseByRoomId = function(roomId, response) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tresponseBy: {\n\t\t\t\t_id: response.user._id,\n\t\t\t\tusername: response.user.username\n\t\t\t},\n\t\t\tresponseDate: response.responseDate,\n\t\t\tresponseTime: response.responseTime\n\t\t},\n\t\t$unset: {\n\t\t\twaitingResponse: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.closeByRoomId = function(roomId, closeInfo) {\n\treturn this.update({\n\t\t_id: roomId\n\t}, {\n\t\t$set: {\n\t\t\tcloser: closeInfo.closer,\n\t\t\tclosedBy: closeInfo.closedBy,\n\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\tchatDuration: closeInfo.chatDuration,\n\t\t\t'v.status': 'offline'\n\t\t},\n\t\t$unset: {\n\t\t\topen: 1\n\t\t}\n\t});\n};\n\nRocketChat.models.Rooms.setLabelByRoomId = function(roomId, label) {\n\treturn this.update({ _id: roomId }, { $set: { label } });\n};\n\nRocketChat.models.Rooms.findOpenByAgent = function(userId) {\n\tconst query = {\n\t\topen: true,\n\t\t'servedBy._id': userId\n\t};\n\n\treturn this.find(query);\n};\n\nRocketChat.models.Rooms.changeAgentByRoomId = function(roomId, newAgent) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tservedBy: {\n\t\t\t\t_id: newAgent.agentId,\n\t\t\t\tusername: newAgent.username\n\t\t\t}\n\t\t}\n\t};\n\n\tthis.update(query, update);\n};\n\nRocketChat.models.Rooms.saveCRMDataByRoomId = function(roomId, crmData) {\n\tconst query = {\n\t\t_id: roomId\n\t};\n\tconst update = {\n\t\t$set: {\n\t\t\tcrmData\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n\nRocketChat.models.Rooms.updateVisitorStatus = function(token, status) {\n\tconst query = {\n\t\t'v.token': token,\n\t\topen: true\n\t};\n\n\tconst update = {\n\t\t$set: {\n\t\t\t'v.status': status\n\t\t}\n\t};\n\n\treturn this.update(query, update);\n};\n","class LivechatExternalMessage extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_external_message');\n\n\t\tif (Meteor.isClient) {\n\t\t\tthis._initModel('livechat_external_message');\n\t\t}\n\t}\n\n\t// FIND\n\tfindByRoomId(roomId, sort = { ts: -1 }) {\n\t\tconst query = { rid: roomId };\n\n\t\treturn this.find(query, { sort });\n\t}\n}\n\nRocketChat.models.LivechatExternalMessage = new LivechatExternalMessage();\n","import _ from 'underscore';\n\n/**\n * Livechat Custom Fields model\n */\nclass LivechatCustomField extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_custom_field');\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tcreateOrUpdateCustomField(_id, field, label, scope, visibility, extraData) {\n\t\tconst record = {\n\t\t\tlabel,\n\t\t\tscope,\n\t\t\tvisibility\n\t\t};\n\n\t\t_.extend(record, extraData);\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\trecord._id = field;\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\treturn record;\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n}\n\nRocketChat.models.LivechatCustomField = new LivechatCustomField();\n","import _ from 'underscore';\n\n/**\n * Livechat Department model\n */\nclass LivechatDepartment extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department');\n\n\t\tthis.tryEnsureIndex({\n\t\t\tnumAgents: 1,\n\t\t\tenabled: 1\n\t\t});\n\t}\n\n\t// FIND\n\tfindOneById(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\tfindByDepartmentId(_id, options) {\n\t\tconst query = { _id };\n\n\t\treturn this.find(query, options);\n\t}\n\n\tcreateOrUpdateDepartment(_id, { enabled, name, description, showOnRegistration }, agents) {\n\t\tagents = [].concat(agents);\n\n\t\tconst record = {\n\t\t\tenabled,\n\t\t\tname,\n\t\t\tdescription,\n\t\t\tnumAgents: agents.length,\n\t\t\tshowOnRegistration\n\t\t};\n\n\t\tif (_id) {\n\t\t\tthis.update({ _id }, { $set: record });\n\t\t} else {\n\t\t\t_id = this.insert(record);\n\t\t}\n\n\t\tconst savedAgents = _.pluck(RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(_id).fetch(), 'agentId');\n\t\tconst agentsToSave = _.pluck(agents, 'agentId');\n\n\t\t// remove other agents\n\t\t_.difference(savedAgents, agentsToSave).forEach((agentId) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.removeByDepartmentIdAndAgentId(_id, agentId);\n\t\t});\n\n\t\tagents.forEach((agent) => {\n\t\t\tRocketChat.models.LivechatDepartmentAgents.saveAgent({\n\t\t\t\tagentId: agent.agentId,\n\t\t\t\tdepartmentId: _id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: agent.count ? parseInt(agent.count) : 0,\n\t\t\t\torder: agent.order ? parseInt(agent.order) : 0\n\t\t\t});\n\t\t});\n\n\t\treturn _.extend(record, { _id });\n\t}\n\n\t// REMOVE\n\tremoveById(_id) {\n\t\tconst query = { _id };\n\n\t\treturn this.remove(query);\n\t}\n\n\tfindEnabledWithAgents() {\n\t\tconst query = {\n\t\t\tnumAgents: { $gt: 0 },\n\t\t\tenabled: true\n\t\t};\n\t\treturn this.find(query);\n\t}\n}\n\nRocketChat.models.LivechatDepartment = new LivechatDepartment();\n","import _ from 'underscore';\n/**\n * Livechat Department model\n */\nclass LivechatDepartmentAgents extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_department_agents');\n\t}\n\n\tfindByDepartmentId(departmentId) {\n\t\treturn this.find({ departmentId });\n\t}\n\n\tsaveAgent(agent) {\n\t\treturn this.upsert({\n\t\t\tagentId: agent.agentId,\n\t\t\tdepartmentId: agent.departmentId\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tusername: agent.username,\n\t\t\t\tcount: parseInt(agent.count),\n\t\t\t\torder: parseInt(agent.order)\n\t\t\t}\n\t\t});\n\t}\n\n\tremoveByDepartmentIdAndAgentId(departmentId, agentId) {\n\t\tthis.remove({ departmentId, agentId });\n\t}\n\n\tgetNextAgentForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tconst sort = {\n\t\t\tcount: 1,\n\t\t\torder: 1,\n\t\t\tusername: 1\n\t\t};\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tcount: 1\n\t\t\t}\n\t\t};\n\n\t\tconst collectionObj = this.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(collectionObj.findAndModify, collectionObj);\n\n\t\tconst agent = findAndModify(query, sort, update);\n\t\tif (agent && agent.value) {\n\t\t\treturn {\n\t\t\t\tagentId: agent.value.agentId,\n\t\t\t\tusername: agent.value.username\n\t\t\t};\n\t\t} else {\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tgetOnlineForDepartment(departmentId) {\n\t\tconst agents = this.findByDepartmentId(departmentId).fetch();\n\n\t\tif (agents.length === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\tconst onlineUsers = RocketChat.models.Users.findOnlineUserFromList(_.pluck(agents, 'username'));\n\n\t\tconst onlineUsernames = _.pluck(onlineUsers.fetch(), 'username');\n\n\t\tconst query = {\n\t\t\tdepartmentId,\n\t\t\tusername: {\n\t\t\t\t$in: onlineUsernames\n\t\t\t}\n\t\t};\n\n\t\tconst depAgents = this.find(query);\n\n\t\tif (depAgents) {\n\t\t\treturn depAgents;\n\t\t} else {\n\t\t\treturn [];\n\t\t}\n\t}\n\n\tfindUsersInQueue(usersList) {\n\t\tconst query = {};\n\n\t\tif (!_.isEmpty(usersList)) {\n\t\t\tquery.username = {\n\t\t\t\t$in: usersList\n\t\t\t};\n\t\t}\n\n\t\tconst options = {\n\t\t\tsort: {\n\t\t\t\tdepartmentId: 1,\n\t\t\t\tcount: 1,\n\t\t\t\torder: 1,\n\t\t\t\tusername: 1\n\t\t\t}\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\treplaceUsernameOfAgentByUserId(userId, username) {\n\t\tconst query = {'agentId': userId};\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\tusername\n\t\t\t}\n\t\t};\n\n\t\treturn this.update(query, update, { multi: true });\n\t}\n}\n\nRocketChat.models.LivechatDepartmentAgents = new LivechatDepartmentAgents();\n","/**\n * Livechat Page Visited model\n */\nclass LivechatPageVisited extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_page_visited');\n\n\t\tthis.tryEnsureIndex({ 'token': 1 });\n\t\tthis.tryEnsureIndex({ 'ts': 1 });\n\n\t\t// keep history for 1 month if the visitor does not register\n\t\tthis.tryEnsureIndex({ 'expireAt': 1 }, { sparse: 1, expireAfterSeconds: 0 });\n\t}\n\n\tsaveByToken(token, pageInfo) {\n\t\t// keep history of unregistered visitors for 1 month\n\t\tconst keepHistoryMiliseconds = 2592000000;\n\n\t\treturn this.insert({\n\t\t\ttoken,\n\t\t\tpage: pageInfo,\n\t\t\tts: new Date(),\n\t\t\texpireAt: new Date().getTime() + keepHistoryMiliseconds\n\t\t});\n\t}\n\n\tfindByToken(token) {\n\t\treturn this.find({ token }, { sort : { ts: -1 }, limit: 20 });\n\t}\n\n\tkeepHistoryForToken(token) {\n\t\treturn this.update({\n\t\t\ttoken,\n\t\t\texpireAt: {\n\t\t\t\t$exists: true\n\t\t\t}\n\t\t}, {\n\t\t\t$unset: {\n\t\t\t\texpireAt: 1\n\t\t\t}\n\t\t}, {\n\t\t\tmulti: true\n\t\t});\n\t}\n}\n\nRocketChat.models.LivechatPageVisited = new LivechatPageVisited();\n","/**\n * Livechat Trigger model\n */\nclass LivechatTrigger extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_trigger');\n\t}\n\n\tupdateById(_id, data) {\n\t\treturn this.update({ _id }, { $set: data });\n\t}\n\n\tremoveAll() {\n\t\treturn this.remove({});\n\t}\n\n\tfindById(_id) {\n\t\treturn this.find({ _id });\n\t}\n\n\tremoveById(_id) {\n\t\treturn this.remove({ _id });\n\t}\n\n\tfindEnabled() {\n\t\treturn this.find({ enabled: true });\n\t}\n}\n\nRocketChat.models.LivechatTrigger = new LivechatTrigger();\n","Meteor.startup(function() {\n\tRocketChat.models.Rooms.tryEnsureIndex({ code: 1 });\n\tRocketChat.models.Rooms.tryEnsureIndex({ open: 1 }, { sparse: 1 });\n\tRocketChat.models.Users.tryEnsureIndex({ 'visitorEmails.address': 1 });\n});\n","class LivechatInquiry extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_inquiry');\n\n\t\tthis.tryEnsureIndex({ 'rid': 1 }); // room id corresponding to this inquiry\n\t\tthis.tryEnsureIndex({ 'name': 1 }); // name of the inquiry (client name for now)\n\t\tthis.tryEnsureIndex({ 'message': 1 }); // message sent by the client\n\t\tthis.tryEnsureIndex({ 'ts': 1 }); // timestamp\n\t\tthis.tryEnsureIndex({ 'code': 1 }); // (for routing)\n\t\tthis.tryEnsureIndex({ 'agents': 1}); // Id's of the agents who can see the inquiry (handle departments)\n\t\tthis.tryEnsureIndex({ 'status': 1}); // 'open', 'taken'\n\t}\n\n\tfindOneById(inquiryId) {\n\t\treturn this.findOne({ _id: inquiryId });\n\t}\n\n\t/*\n\t * mark the inquiry as taken\n\t */\n\ttakeInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'taken' }\n\t\t});\n\t}\n\n\t/*\n\t * mark the inquiry as closed\n\t */\n\tcloseByRoomId(roomId, closeInfo) {\n\t\treturn this.update({\n\t\t\trid: roomId\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'closed',\n\t\t\t\tcloser: closeInfo.closer,\n\t\t\t\tclosedBy: closeInfo.closedBy,\n\t\t\t\tclosedAt: closeInfo.closedAt,\n\t\t\t\tchatDuration: closeInfo.chatDuration\n\t\t\t}\n\t\t});\n\t}\n\n\t/*\n\t * mark inquiry as open\n\t */\n\topenInquiry(inquiryId) {\n\t\tthis.update({\n\t\t\t'_id': inquiryId\n\t\t}, {\n\t\t\t$set: { status: 'open' }\n\t\t});\n\t}\n\n\t/*\n\t * return the status of the inquiry (open or taken)\n\t */\n\tgetStatus(inquiryId) {\n\t\treturn this.findOne({'_id': inquiryId}).status;\n\t}\n\n\tupdateVisitorStatus(token, status) {\n\t\tconst query = {\n\t\t\t'v.token': token,\n\t\t\tstatus: 'open'\n\t\t};\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\t'v.status': status\n\t\t\t}\n\t\t};\n\n\t\treturn this.update(query, update);\n\t}\n}\n\nRocketChat.models.LivechatInquiry = new LivechatInquiry();\n","import moment from 'moment';\n\nclass LivechatOfficeHour extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_office_hour');\n\n\t\tthis.tryEnsureIndex({ 'day': 1 }); // the day of the week monday - sunday\n\t\tthis.tryEnsureIndex({ 'start': 1 }); // the opening hours of the office\n\t\tthis.tryEnsureIndex({ 'finish': 1 }); // the closing hours of the office\n\t\tthis.tryEnsureIndex({ 'open': 1 }); // whether or not the offices are open on this day\n\n\t\t// if there is nothing in the collection, add defaults\n\t\tif (this.find().count() === 0) {\n\t\t\tthis.insert({'day' : 'Monday', 'start' : '08:00', 'finish' : '20:00', 'code' : 1, 'open' : true });\n\t\t\tthis.insert({'day' : 'Tuesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 2, 'open' : true });\n\t\t\tthis.insert({'day' : 'Wednesday', 'start' : '08:00', 'finish' : '20:00', 'code' : 3, 'open' : true });\n\t\t\tthis.insert({'day' : 'Thursday', 'start' : '08:00', 'finish' : '20:00', 'code' : 4, 'open' : true });\n\t\t\tthis.insert({'day' : 'Friday', 'start' : '08:00', 'finish' : '20:00', 'code' : 5, 'open' : true });\n\t\t\tthis.insert({'day' : 'Saturday', 'start' : '08:00', 'finish' : '20:00', 'code' : 6, 'open' : false });\n\t\t\tthis.insert({'day' : 'Sunday', 'start' : '08:00', 'finish' : '20:00', 'code' : 0, 'open' : false });\n\t\t}\n\t}\n\n\t/*\n\t * update the given days start and finish times and whether the office is open on that day\n\t */\n\tupdateHours(day, newStart, newFinish, newOpen) {\n\t\tthis.update({\n\t\t\tday\n\t\t}, {\n\t\t\t$set: {\n\t\t\t\tstart: newStart,\n\t\t\t\tfinish: newFinish,\n\t\t\t\topen: newOpen\n\t\t\t}\n\t\t});\n\t}\n\n\t/*\n\t * Check if the current server time (utc) is within the office hours of that day\n\t * returns true or false\n\t */\n\tisNowWithinHours() {\n\t\t// get current time on server in utc\n\t\t// var ct = moment().utc();\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\t// console.log(finish.isBefore(start));\n\t\tif (finish.isBefore(start)) {\n\t\t\t// finish.day(finish.day()+1);\n\t\t\tfinish.add(1, 'days');\n\t\t}\n\n\t\tconst result = currentTime.isBetween(start, finish);\n\n\t\t// inBetween  check\n\t\treturn result;\n\t}\n\n\tisOpeningTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// check if offices are open today\n\t\tif (todaysOfficeHours.open === false) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst start = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.start }`, 'dddd:HH:mm');\n\n\t\treturn start.isSame(currentTime, 'minute');\n\t}\n\n\tisClosingTime() {\n\t\t// get current time on server in utc\n\t\tconst currentTime = moment.utc(moment().utc().format('dddd:HH:mm'), 'dddd:HH:mm');\n\n\t\t// get todays office hours from db\n\t\tconst todaysOfficeHours = this.findOne({day: currentTime.format('dddd')});\n\t\tif (!todaysOfficeHours) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst finish = moment.utc(`${ todaysOfficeHours.day }:${ todaysOfficeHours.finish }`, 'dddd:HH:mm');\n\n\t\treturn finish.isSame(currentTime, 'minute');\n\t}\n}\n\nRocketChat.models.LivechatOfficeHour = new LivechatOfficeHour();\n","import _ from 'underscore';\nimport s from 'underscore.string';\n\nclass LivechatVisitors extends RocketChat.models._Base {\n\tconstructor() {\n\t\tsuper('livechat_visitor');\n\t}\n\n\t/**\n\t * Gets visitor by token\n\t * @param {string} token - Visitor token\n\t */\n\tgetVisitorByToken(token, options) {\n\t\tconst query = {\n\t\t\ttoken\n\t\t};\n\n\t\treturn this.findOne(query, options);\n\t}\n\n\t/**\n\t * Find visitors by _id\n\t * @param {string} token - Visitor token\n\t */\n\tfindById(_id, options) {\n\t\tconst query = {\n\t\t\t_id\n\t\t};\n\n\t\treturn this.find(query, options);\n\t}\n\n\t/**\n\t * Gets visitor by token\n\t * @param {string} token - Visitor token\n\t */\n\tfindVisitorByToken(token) {\n\t\tconst query = {\n\t\t\ttoken\n\t\t};\n\n\t\treturn this.find(query);\n\t}\n\n\tupdateLivechatDataByToken(token, key, value, overwrite = true) {\n\t\tconst query = {\n\t\t\ttoken\n\t\t};\n\n\t\tif (!overwrite) {\n\t\t\tconst user = this.findOne(query, { fields: { livechatData: 1 } });\n\t\t\tif (user.livechatData && typeof user.livechatData[key] !== 'undefined') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\tconst update = {\n\t\t\t$set: {\n\t\t\t\t[`livechatData.${ key }`]: value\n\t\t\t}\n\t\t};\n\n\t\treturn this.update(query, update);\n\t}\n\n\t/**\n\t * Find a visitor by their phone number\n\t * @return {object} User from db\n\t */\n\tfindOneVisitorByPhone(phone) {\n\t\tconst query = {\n\t\t\t'phone.phoneNumber': phone\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n\n\t/**\n\t * Get the next visitor name\n\t * @return {string} The next visitor name\n\t */\n\tgetNextVisitorUsername() {\n\t\tconst settingsRaw = RocketChat.models.Settings.model.rawCollection();\n\t\tconst findAndModify = Meteor.wrapAsync(settingsRaw.findAndModify, settingsRaw);\n\n\t\tconst query = {\n\t\t\t_id: 'Livechat_guest_count'\n\t\t};\n\n\t\tconst update = {\n\t\t\t$inc: {\n\t\t\t\tvalue: 1\n\t\t\t}\n\t\t};\n\n\t\tconst livechatCount = findAndModify(query, null, update);\n\n\t\treturn `guest-${ livechatCount.value.value + 1 }`;\n\t}\n\n\tupdateById(_id, update) {\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tsaveGuestById(_id, data) {\n\t\tconst setData = {};\n\t\tconst unsetData = {};\n\n\t\tif (data.name) {\n\t\t\tif (!_.isEmpty(s.trim(data.name))) {\n\t\t\t\tsetData.name = s.trim(data.name);\n\t\t\t} else {\n\t\t\t\tunsetData.name = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (data.email) {\n\t\t\tif (!_.isEmpty(s.trim(data.email))) {\n\t\t\t\tsetData.visitorEmails = [\n\t\t\t\t\t{ address: s.trim(data.email) }\n\t\t\t\t];\n\t\t\t} else {\n\t\t\t\tunsetData.visitorEmails = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (data.phone) {\n\t\t\tif (!_.isEmpty(s.trim(data.phone))) {\n\t\t\t\tsetData.phone = [\n\t\t\t\t\t{ phoneNumber: s.trim(data.phone) }\n\t\t\t\t];\n\t\t\t} else {\n\t\t\t\tunsetData.phone = 1;\n\t\t\t}\n\t\t}\n\n\t\tconst update = {};\n\n\t\tif (!_.isEmpty(setData)) {\n\t\t\tupdate.$set = setData;\n\t\t}\n\n\t\tif (!_.isEmpty(unsetData)) {\n\t\t\tupdate.$unset = unsetData;\n\t\t}\n\n\t\tif (_.isEmpty(update)) {\n\t\t\treturn true;\n\t\t}\n\n\t\treturn this.update({ _id }, update);\n\t}\n\n\tfindOneGuestByEmailAddress(emailAddress) {\n\t\tconst query = {\n\t\t\t'visitorEmails.address': new RegExp(`^${ s.escapeRegExp(emailAddress) }$`, 'i')\n\t\t};\n\n\t\treturn this.findOne(query);\n\t}\n\n\tsaveGuestEmailPhoneById(_id, emails, phones) {\n\t\tconst update = {\n\t\t\t$addToSet: {}\n\t\t};\n\n\t\tconst saveEmail = [].concat(emails)\n\t\t\t.filter(email => email && email.trim())\n\t\t\t.map(email => {\n\t\t\t\treturn { address: email };\n\t\t\t});\n\n\t\tif (saveEmail.length > 0) {\n\t\t\tupdate.$addToSet.visitorEmails = { $each: saveEmail };\n\t\t}\n\n\t\tconst savePhone = [].concat(phones)\n\t\t\t.filter(phone => phone && phone.trim().replace(/[^\\d]/g, ''))\n\t\t\t.map(phone => {\n\t\t\t\treturn { phoneNumber: phone };\n\t\t\t});\n\n\t\tif (savePhone.length > 0) {\n\t\t\tupdate.$addToSet.phone = { $each: savePhone };\n\t\t}\n\n\t\tif (!update.$addToSet.visitorEmails && !update.$addToSet.phone) {\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.update({ _id }, update);\n\t}\n}\n\nexport default new LivechatVisitors();\n","/* globals HTTP */\nimport _ from 'underscore';\nimport s from 'underscore.string';\nimport UAParser from 'ua-parser-js';\nimport LivechatVisitors from '../models/LivechatVisitors';\n\nRocketChat.Livechat = {\n\thistoryMonitorType: 'url',\n\n\tlogger: new Logger('Livechat', {\n\t\tsections: {\n\t\t\twebhook: 'Webhook'\n\t\t}\n\t}),\n\n\tgetNextAgent(department) {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'External') {\n\t\t\tfor (let i = 0; i < 10; i++) {\n\t\t\t\ttry {\n\t\t\t\t\tconst queryString = department ? `?departmentId=${ department }` : '';\n\t\t\t\t\tconst result = HTTP.call('GET', `${ RocketChat.settings.get('Livechat_External_Queue_URL') }${ queryString }`, {\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'User-Agent': 'RocketChat Server',\n\t\t\t\t\t\t\t'Accept': 'application/json',\n\t\t\t\t\t\t\t'X-RocketChat-Secret-Token': RocketChat.settings.get('Livechat_External_Queue_Token')\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\t\tif (result && result.data && result.data.username) {\n\t\t\t\t\t\tconst agent = RocketChat.models.Users.findOneOnlineAgentByUsername(result.data.username);\n\n\t\t\t\t\t\tif (agent) {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tagentId: agent._id,\n\t\t\t\t\t\t\t\tusername: agent.username\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error('Error requesting agent from external queue.', e);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t} else if (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getNextAgentForDepartment(department);\n\t\t}\n\t\treturn RocketChat.models.Users.getNextAgent();\n\t},\n\tgetAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.findByDepartmentId(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findAgents();\n\t\t}\n\t},\n\tgetOnlineAgents(department) {\n\t\tif (department) {\n\t\t\treturn RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(department);\n\t\t} else {\n\t\t\treturn RocketChat.models.Users.findOnlineAgents();\n\t\t}\n\t},\n\tgetRequiredDepartment(onlineRequired = true) {\n\t\tconst departments = RocketChat.models.LivechatDepartment.findEnabledWithAgents();\n\n\t\treturn departments.fetch().find((dept) => {\n\t\t\tif (!dept.showOnRegistration) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif (!onlineRequired) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tconst onlineAgents = RocketChat.models.LivechatDepartmentAgents.getOnlineForDepartment(dept._id);\n\t\t\treturn onlineAgents.count() > 0;\n\t\t});\n\t},\n\tgetRoom(guest, message, roomInfo, agent) {\n\t\tlet room = RocketChat.models.Rooms.findOneById(message.rid);\n\t\tlet newRoom = false;\n\n\t\tif (room && !room.open) {\n\t\t\tmessage.rid = Random.id();\n\t\t\troom = null;\n\t\t}\n\n\t\tif (room == null) {\n\t\t\t// if no department selected verify if there is at least one active and pick the first\n\t\t\tif (!agent && !guest.department) {\n\t\t\t\tconst department = this.getRequiredDepartment();\n\n\t\t\t\tif (department) {\n\t\t\t\t\tguest.department = department._id;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// delegate room creation to QueueMethods\n\t\t\tconst routingMethod = RocketChat.settings.get('Livechat_Routing_Method');\n\t\t\troom = RocketChat.QueueMethods[routingMethod](guest, message, roomInfo, agent);\n\n\t\t\tnewRoom = true;\n\t\t}\n\n\t\tif (!room || room.v.token !== guest.token) {\n\t\t\tthrow new Meteor.Error('cannot-access-room');\n\t\t}\n\n\t\treturn { room, newRoom };\n\t},\n\tsendMessage({ guest, message, roomInfo, agent }) {\n\t\tconst { room, newRoom } = this.getRoom(guest, message, roomInfo, agent);\n\t\tif (guest.name) {\n\t\t\tmessage.alias = guest.name;\n\t\t}\n\n\t\t// return messages;\n\t\treturn _.extend(RocketChat.sendMessage(guest, message, room), { newRoom, showConnecting: this.showConnecting() });\n\t},\n\tregisterGuest({ token, name, email, department, phone, username } = {}) {\n\t\tcheck(token, String);\n\n\t\tlet userId;\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\ttoken\n\t\t\t}\n\t\t};\n\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\n\t\tif (user) {\n\t\t\tuserId = user._id;\n\t\t} else {\n\t\t\tif (!username) {\n\t\t\t\tusername = LivechatVisitors.getNextVisitorUsername();\n\t\t\t}\n\n\t\t\tlet existingUser = null;\n\n\t\t\tif (s.trim(email) !== '' && (existingUser = LivechatVisitors.findOneGuestByEmailAddress(email))) {\n\t\t\t\tuserId = existingUser._id;\n\t\t\t} else {\n\t\t\t\tconst userData = {\n\t\t\t\t\tusername,\n\t\t\t\t\tdepartment\n\t\t\t\t};\n\n\t\t\t\tif (this.connection) {\n\t\t\t\t\tuserData.userAgent = this.connection.httpHeaders['user-agent'];\n\t\t\t\t\tuserData.ip = this.connection.httpHeaders['x-real-ip'] || this.connection.httpHeaders['x-forwarded-for'] || this.connection.clientAddress;\n\t\t\t\t\tuserData.host = this.connection.httpHeaders.host;\n\t\t\t\t}\n\n\t\t\t\tuserId = LivechatVisitors.insert(userData);\n\t\t\t}\n\t\t}\n\n\t\tif (phone) {\n\t\t\tupdateUser.$set.phone = [\n\t\t\t\t{ phoneNumber: phone.number }\n\t\t\t];\n\t\t}\n\n\t\tif (email && email.trim() !== '') {\n\t\t\tupdateUser.$set.visitorEmails = [\n\t\t\t\t{ address: email }\n\t\t\t];\n\t\t}\n\n\t\tif (name) {\n\t\t\tupdateUser.$set.name = name;\n\t\t}\n\n\t\tLivechatVisitors.updateById(userId, updateUser);\n\n\t\treturn userId;\n\t},\n\tsetDepartmentForGuest({ token, department } = {}) {\n\t\tcheck(token, String);\n\n\t\tconst updateUser = {\n\t\t\t$set: {\n\t\t\t\tdepartment\n\t\t\t}\n\t\t};\n\n\t\tconst user = LivechatVisitors.getVisitorByToken(token, { fields: { _id: 1 } });\n\t\tif (user) {\n\t\t\treturn Meteor.users.update(user._id, updateUser);\n\t\t}\n\t\treturn false;\n\t},\n\tsaveGuest({ _id, name, email, phone }) {\n\t\tconst updateData = {};\n\n\t\tif (name) {\n\t\t\tupdateData.name = name;\n\t\t}\n\t\tif (email) {\n\t\t\tupdateData.email = email;\n\t\t}\n\t\tif (phone) {\n\t\t\tupdateData.phone = phone;\n\t\t}\n\t\tconst ret = LivechatVisitors.saveGuestById(_id, updateData);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveGuest', updateData);\n\t\t});\n\n\t\treturn ret;\n\t},\n\n\tcloseRoom({ user, visitor, room, comment }) {\n\t\tconst now = new Date();\n\n\t\tconst closeData = {\n\t\t\tclosedAt: now,\n\t\t\tchatDuration: (now.getTime() - room.ts) / 1000\n\t\t};\n\n\t\tif (user) {\n\t\t\tcloseData.closer = 'user';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: user._id,\n\t\t\t\tusername: user.username\n\t\t\t};\n\t\t} else if (visitor) {\n\t\t\tcloseData.closer = 'visitor';\n\t\t\tcloseData.closedBy = {\n\t\t\t\t_id: visitor._id,\n\t\t\t\tusername: visitor.username\n\t\t\t};\n\t\t}\n\n\t\tRocketChat.models.Rooms.closeByRoomId(room._id, closeData);\n\t\tRocketChat.models.LivechatInquiry.closeByRoomId(room._id, closeData);\n\n\t\tconst message = {\n\t\t\tt: 'livechat-close',\n\t\t\tmsg: comment,\n\t\t\tgroupable: false\n\t\t};\n\n\t\tRocketChat.sendMessage(user, message, room);\n\n\t\tif (room.servedBy) {\n\t\t\tRocketChat.models.Subscriptions.hideByRoomIdAndUserId(room._id, room.servedBy._id);\n\t\t}\n\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser('promptTranscript', room._id, closeData.closedBy);\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.closeRoom', room);\n\t\t});\n\n\t\treturn true;\n\t},\n\n\tgetInitSettings() {\n\t\tconst settings = {};\n\n\t\tRocketChat.models.Settings.findNotHiddenPublic([\n\t\t\t'Livechat_title',\n\t\t\t'Livechat_title_color',\n\t\t\t'Livechat_enabled',\n\t\t\t'Livechat_registration_form',\n\t\t\t'Livechat_allow_switching_departments',\n\t\t\t'Livechat_offline_title',\n\t\t\t'Livechat_offline_title_color',\n\t\t\t'Livechat_offline_message',\n\t\t\t'Livechat_offline_success_message',\n\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t'Livechat_display_offline_form',\n\t\t\t'Livechat_videocall_enabled',\n\t\t\t'Jitsi_Enabled',\n\t\t\t'Language',\n\t\t\t'Livechat_enable_transcript',\n\t\t\t'Livechat_transcript_message',\n\t\t\t'Livechat_conversation_finished_message'\n\t\t]).forEach((setting) => {\n\t\t\tsettings[setting._id] = setting.value;\n\t\t});\n\n\t\treturn settings;\n\t},\n\n\tsaveRoomInfo(roomData, guestData) {\n\t\tif ((roomData.topic != null || roomData.tags != null) && !RocketChat.models.Rooms.setTopicAndTagsById(roomData._id, roomData.topic, roomData.tags)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.callbacks.run('livechat.saveRoom', roomData);\n\t\t});\n\n\t\tif (!_.isEmpty(guestData.name)) {\n\t\t\treturn RocketChat.models.Rooms.setLabelByRoomId(roomData._id, guestData.name) && RocketChat.models.Subscriptions.updateNameByRoomId(roomData._id, guestData.name);\n\t\t}\n\t},\n\n\tcloseOpenChats(userId, comment) {\n\t\tconst user = RocketChat.models.Users.findOneById(userId);\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tthis.closeRoom({ user, room, comment});\n\t\t});\n\t},\n\n\tforwardOpenChats(userId) {\n\t\tRocketChat.models.Rooms.findOpenByAgent(userId).forEach((room) => {\n\t\t\tconst guest = RocketChat.models.Users.findOneById(room.v._id);\n\t\t\tthis.transfer(room, guest, { departmentId: guest.department });\n\t\t});\n\t},\n\n\tsavePageHistory(token, pageInfo) {\n\t\tif (pageInfo.change === RocketChat.Livechat.historyMonitorType) {\n\t\t\treturn RocketChat.models.LivechatPageVisited.saveByToken(token, pageInfo);\n\t\t}\n\n\t\treturn;\n\t},\n\n\ttransfer(room, guest, transferData) {\n\t\tlet agent;\n\n\t\tif (transferData.userId) {\n\t\t\tconst user = RocketChat.models.Users.findOneById(transferData.userId);\n\t\t\tagent = {\n\t\t\t\tagentId: user._id,\n\t\t\t\tusername: user.username\n\t\t\t};\n\t\t} else {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(transferData.departmentId);\n\t\t}\n\n\t\tconst servedBy = room.servedBy;\n\n\t\tif (agent && agent.agentId !== servedBy._id) {\n\t\t\troom.usernames = _.without(room.usernames, servedBy.username).concat(agent.username);\n\n\t\t\tRocketChat.models.Rooms.changeAgentByRoomId(room._id, agent);\n\n\t\t\tconst subscriptionData = {\n\t\t\t\trid: room._id,\n\t\t\t\tname: guest.name || guest.username,\n\t\t\t\talert: true,\n\t\t\t\topen: true,\n\t\t\t\tunread: 1,\n\t\t\t\tuserMentions: 1,\n\t\t\t\tgroupMentions: 0,\n\t\t\t\tcode: room.code,\n\t\t\t\tu: {\n\t\t\t\t\t_id: agent.agentId,\n\t\t\t\t\tusername: agent.username\n\t\t\t\t},\n\t\t\t\tt: 'l',\n\t\t\t\tdesktopNotifications: 'all',\n\t\t\t\tmobilePushNotifications: 'all',\n\t\t\t\temailNotifications: 'all'\n\t\t\t};\n\t\t\tRocketChat.models.Subscriptions.removeByRoomIdAndUserId(room._id, servedBy._id);\n\n\t\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(room._id, { _id: servedBy._id, username: servedBy.username });\n\t\t\tRocketChat.models.Messages.createUserJoinWithRoomIdAndUser(room._id, { _id: agent.agentId, username: agent.username });\n\n\t\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\t\ttype: 'agentData',\n\t\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t\t});\n\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tsendRequest(postData, callback, trying = 1) {\n\t\ttry {\n\t\t\tconst options = {\n\t\t\t\theaders: {\n\t\t\t\t\t'X-RocketChat-Livechat-Token': RocketChat.settings.get('Livechat_secret_token')\n\t\t\t\t},\n\t\t\t\tdata: postData\n\t\t\t};\n\t\t\treturn HTTP.post(RocketChat.settings.get('Livechat_webhookUrl'), options);\n\t\t} catch (e) {\n\t\t\tRocketChat.Livechat.logger.webhook.error(`Response error on ${ trying } try ->`, e);\n\t\t\t// try 10 times after 10 seconds each\n\t\t\tif (trying < 10) {\n\t\t\t\tRocketChat.Livechat.logger.webhook.warn('Will try again in 10 seconds ...');\n\t\t\t\ttrying++;\n\t\t\t\tsetTimeout(Meteor.bindEnvironment(() => {\n\t\t\t\t\tRocketChat.Livechat.sendRequest(postData, callback, trying);\n\t\t\t\t}), 10000);\n\t\t\t}\n\t\t}\n\t},\n\n\tgetLivechatRoomGuestInfo(room) {\n\t\tconst visitor = LivechatVisitors.findOneById(room.v._id);\n\t\tconst agent = RocketChat.models.Users.findOneById(room.servedBy && room.servedBy._id);\n\n\t\tconst ua = new UAParser();\n\t\tua.setUA(visitor.userAgent);\n\n\t\tconst postData = {\n\t\t\t_id: room._id,\n\t\t\tlabel: room.label,\n\t\t\ttopic: room.topic,\n\t\t\tcode: room.code,\n\t\t\tcreatedAt: room.ts,\n\t\t\tlastMessageAt: room.lm,\n\t\t\ttags: room.tags,\n\t\t\tcustomFields: room.livechatData,\n\t\t\tvisitor: {\n\t\t\t\t_id: visitor._id,\n\t\t\t\ttoken: visitor.token,\n\t\t\t\tname: visitor.name,\n\t\t\t\tusername: visitor.username,\n\t\t\t\temail: null,\n\t\t\t\tphone: null,\n\t\t\t\tdepartment: visitor.department,\n\t\t\t\tip: visitor.ip,\n\t\t\t\tos: ua.getOS().name && (`${ ua.getOS().name } ${ ua.getOS().version }`),\n\t\t\t\tbrowser: ua.getBrowser().name && (`${ ua.getBrowser().name } ${ ua.getBrowser().version }`),\n\t\t\t\tcustomFields: visitor.livechatData\n\t\t\t}\n\t\t};\n\n\t\tif (agent) {\n\t\t\tpostData.agent = {\n\t\t\t\t_id: agent._id,\n\t\t\t\tusername: agent.username,\n\t\t\t\tname: agent.name,\n\t\t\t\temail: null\n\t\t\t};\n\n\t\t\tif (agent.emails && agent.emails.length > 0) {\n\t\t\t\tpostData.agent.email = agent.emails[0].address;\n\t\t\t}\n\t\t}\n\n\t\tif (room.crmData) {\n\t\t\tpostData.crmData = room.crmData;\n\t\t}\n\n\t\tif (visitor.visitorEmails && visitor.visitorEmails.length > 0) {\n\t\t\tpostData.visitor.email = visitor.visitorEmails;\n\t\t}\n\t\tif (visitor.phone && visitor.phone.length > 0) {\n\t\t\tpostData.visitor.phone = visitor.phone;\n\t\t}\n\n\t\treturn postData;\n\t},\n\n\taddAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, true);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'available');\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\taddManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1, username: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:addManager' });\n\t\t}\n\n\t\tif (RocketChat.authz.addUserRoles(user._id, 'livechat-manager')) {\n\t\t\treturn user;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveAgent(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeAgent' });\n\t\t}\n\n\t\tif (RocketChat.authz.removeUserFromRoles(user._id, 'livechat-agent')) {\n\t\t\tRocketChat.models.Users.setOperator(user._id, false);\n\t\t\tRocketChat.models.Users.setLivechatStatus(user._id, 'not-available');\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tremoveManager(username) {\n\t\tcheck(username, String);\n\n\t\tconst user = RocketChat.models.Users.findOneByUsername(username, { fields: { _id: 1 } });\n\n\t\tif (!user) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'livechat:removeManager' });\n\t\t}\n\n\t\treturn RocketChat.authz.removeUserFromRoles(user._id, 'livechat-manager');\n\t},\n\n\tsaveDepartment(_id, departmentData, departmentAgents) {\n\t\tcheck(_id, Match.Maybe(String));\n\n\t\tcheck(departmentData, {\n\t\t\tenabled: Boolean,\n\t\t\tname: String,\n\t\t\tdescription: Match.Optional(String),\n\t\t\tshowOnRegistration: Boolean\n\t\t});\n\n\t\tcheck(departmentAgents, [\n\t\t\tMatch.ObjectIncluding({\n\t\t\t\tagentId: String,\n\t\t\t\tusername: String\n\t\t\t})\n\t\t]);\n\n\t\tif (_id) {\n\t\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id);\n\t\t\tif (!department) {\n\t\t\t\tthrow new Meteor.Error('error-department-not-found', 'Department not found', { method: 'livechat:saveDepartment' });\n\t\t\t}\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.createOrUpdateDepartment(_id, departmentData, departmentAgents);\n\t},\n\n\tremoveDepartment(_id) {\n\t\tcheck(_id, String);\n\n\t\tconst department = RocketChat.models.LivechatDepartment.findOneById(_id, { fields: { _id: 1 } });\n\n\t\tif (!department) {\n\t\t\tthrow new Meteor.Error('department-not-found', 'Department not found', { method: 'livechat:removeDepartment' });\n\t\t}\n\n\t\treturn RocketChat.models.LivechatDepartment.removeById(_id);\n\t},\n\n\tshowConnecting() {\n\t\tif (RocketChat.settings.get('Livechat_Routing_Method') === 'Guest_Pool') {\n\t\t\treturn RocketChat.settings.get('Livechat_open_inquiery_show_connecting');\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n};\n\nRocketChat.Livechat.stream = new Meteor.Streamer('livechat-room');\n\nRocketChat.Livechat.stream.allowRead((roomId, extraData) => {\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\tif (!room) {\n\t\tconsole.warn(`Invalid eventName: \"${ roomId }\"`);\n\t\treturn false;\n\t}\n\tif (room.t === 'l' && extraData && extraData.token && room.v.token === extraData.token) {\n\t\treturn true;\n\t}\n\treturn false;\n});\n\nRocketChat.settings.get('Livechat_history_monitor_type', (key, value) => {\n\tRocketChat.Livechat.historyMonitorType = value;\n});\n","import _ from 'underscore';\n\nRocketChat.QueueMethods = {\n\t/* Least Amount Queuing method:\n\t *\n\t * default method where the agent with the least number\n\t * of open chats is paired with the incoming livechat\n\t */\n\t'Least_Amount'(guest, message, roomInfo, agent) {\n\t\tif (!agent) {\n\t\t\tagent = RocketChat.Livechat.getNextAgent(guest.department);\n\t\t\tif (!agent) {\n\t\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t\t}\n\t\t}\n\n\t\tconst roomCode = RocketChat.models.Rooms.getNextLivechatRoomCode();\n\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tlabel: guest.name || guest.username,\n\t\t\t// usernames: [agent.username, guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status || 'online'\n\t\t\t},\n\t\t\tservedBy: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tconst subscriptionData = {\n\t\t\trid: message.rid,\n\t\t\tname: guest.name || guest.username,\n\t\t\talert: true,\n\t\t\topen: true,\n\t\t\tunread: 1,\n\t\t\tuserMentions: 1,\n\t\t\tgroupMentions: 0,\n\t\t\tcode: roomCode,\n\t\t\tu: {\n\t\t\t\t_id: agent.agentId,\n\t\t\t\tusername: agent.username\n\t\t\t},\n\t\t\tt: 'l',\n\t\t\tdesktopNotifications: 'all',\n\t\t\tmobilePushNotifications: 'all',\n\t\t\temailNotifications: 'all'\n\t\t};\n\n\t\tRocketChat.models.Rooms.insert(room);\n\t\tRocketChat.models.Subscriptions.insert(subscriptionData);\n\n\t\tRocketChat.Livechat.stream.emit(room._id, {\n\t\t\ttype: 'agentData',\n\t\t\tdata: RocketChat.models.Users.getAgentInfo(agent.agentId)\n\t\t});\n\n\t\treturn room;\n\t},\n\t/* Guest Pool Queuing Method:\n\t *\n\t * An incomming livechat is created as an Inquiry\n\t * which is picked up from an agent.\n\t * An Inquiry is visible to all agents (TODO: in the correct department)\n     *\n\t * A room is still created with the initial message, but it is occupied by\n\t * only the client until paired with an agent\n\t */\n\t'Guest_Pool'(guest, message, roomInfo) {\n\t\tlet agents = RocketChat.Livechat.getOnlineAgents(guest.department);\n\n\t\tif (agents.count() === 0 && RocketChat.settings.get('Livechat_guest_pool_with_no_agents')) {\n\t\t\tagents = RocketChat.Livechat.getAgents(guest.department);\n\t\t}\n\n\t\tif (agents.count() === 0) {\n\t\t\tthrow new Meteor.Error('no-agent-online', 'Sorry, no online agents');\n\t\t}\n\n\t\tconst roomCode = RocketChat.models.Rooms.getNextLivechatRoomCode();\n\n\t\tconst agentIds = [];\n\n\t\tagents.forEach((agent) => {\n\t\t\tif (guest.department) {\n\t\t\t\tagentIds.push(agent.agentId);\n\t\t\t} else {\n\t\t\t\tagentIds.push(agent._id);\n\t\t\t}\n\t\t});\n\n\t\tconst inquiry = {\n\t\t\trid: message.rid,\n\t\t\tmessage: message.msg,\n\t\t\tname: guest.name || guest.username,\n\t\t\tts: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tdepartment: guest.department,\n\t\t\tagents: agentIds,\n\t\t\tstatus: 'open',\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status || 'online'\n\t\t\t},\n\t\t\tt: 'l'\n\t\t};\n\t\tconst room = _.extend({\n\t\t\t_id: message.rid,\n\t\t\tmsgs: 1,\n\t\t\tlm: new Date(),\n\t\t\tcode: roomCode,\n\t\t\tlabel: guest.name || guest.username,\n\t\t\t// usernames: [guest.username],\n\t\t\tt: 'l',\n\t\t\tts: new Date(),\n\t\t\tv: {\n\t\t\t\t_id: guest._id,\n\t\t\t\tusername: guest.username,\n\t\t\t\ttoken: message.token,\n\t\t\t\tstatus: guest.status\n\t\t\t},\n\t\t\tcl: false,\n\t\t\topen: true,\n\t\t\twaitingResponse: true\n\t\t}, roomInfo);\n\t\tRocketChat.models.LivechatInquiry.insert(inquiry);\n\t\tRocketChat.models.Rooms.insert(room);\n\n\t\treturn room;\n\t},\n\t'External'(guest, message, roomInfo, agent) {\n\t\treturn this['Least_Amount'](guest, message, roomInfo, agent); // eslint-disable-line\n\t}\n};\n","// Every minute check if office closed\nMeteor.setInterval(function() {\n\tif (RocketChat.settings.get('Livechat_enable_office_hours')) {\n\t\tif (RocketChat.models.LivechatOfficeHour.isOpeningTime()) {\n\t\t\tRocketChat.models.Users.openOffice();\n\t\t} else if (RocketChat.models.LivechatOfficeHour.isClosingTime()) {\n\t\t\tRocketChat.models.Users.closeOffice();\n\t\t}\n\t}\n}, 60000);\n","const gatewayURL = 'https://omni.rocket.chat';\n\nexport default {\n\tenable() {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json'\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\turl: RocketChat.settings.get('Site_Url')\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tdisable() {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/enable`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`,\n\t\t\t\t'content-type': 'application/json'\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tlistPages() {\n\t\tconst result = HTTP.call('GET', `${ gatewayURL }/facebook/pages`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tsubscribe(pageId) {\n\t\tconst result = HTTP.call('POST', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\tunsubscribe(pageId) {\n\t\tconst result = HTTP.call('DELETE', `${ gatewayURL }/facebook/page/${ pageId }/subscribe`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t}\n\t\t});\n\t\treturn result.data;\n\t},\n\n\treply({ page, token, text }) {\n\t\treturn HTTP.call('POST', `${ gatewayURL }/facebook/reply`, {\n\t\t\theaders: {\n\t\t\t\t'authorization': `Bearer ${ RocketChat.settings.get('Livechat_Facebook_API_Key') }`\n\t\t\t},\n\t\t\tdata: {\n\t\t\t\tpage,\n\t\t\t\ttoken,\n\t\t\t\ttext\n\t\t\t}\n\t\t});\n\t}\n};\n","import LivechatVisitors from './models/LivechatVisitors';\n\nRocketChat.callbacks.add('afterSaveMessage', function(message, room) {\n\t// skips this callback if the message was edited\n\tif (message.editedAt) {\n\t\treturn message;\n\t}\n\n\tif (!RocketChat.SMS.enabled) {\n\t\treturn message;\n\t}\n\n\t// only send the sms by SMS if it is a livechat room with SMS set to true\n\tif (!(typeof room.t !== 'undefined' && room.t === 'l' && room.sms && room.v && room.v.token)) {\n\t\treturn message;\n\t}\n\n\t// if the message has a token, it was sent from the visitor, so ignore it\n\tif (message.token) {\n\t\treturn message;\n\t}\n\n\t// if the message has a type means it is a special message (like the closing comment), so skips\n\tif (message.t) {\n\t\treturn message;\n\t}\n\n\tconst SMSService = RocketChat.SMS.getService(RocketChat.settings.get('SMS_Service'));\n\n\tif (!SMSService) {\n\t\treturn message;\n\t}\n\n\tconst visitor = LivechatVisitors.getVisitorByToken(room.v.token);\n\n\tif (!visitor || !visitor.phone || visitor.phone.length === 0) {\n\t\treturn message;\n\t}\n\n\tSMSService.send(room.sms.from, visitor.phone[0].phoneNumber, message.msg);\n\n\treturn message;\n\n}, RocketChat.callbacks.priority.LOW, 'sendMessageBySms');\n","/* globals UserPresenceMonitor */\n\nlet agentsHandler;\nlet monitorAgents = false;\nlet actionTimeout = 60000;\n\nconst onlineAgents = {\n\tusers: {},\n\tqueue: {},\n\n\tadd(userId) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t\tdelete this.queue[userId];\n\t\t}\n\t\tthis.users[userId] = 1;\n\t},\n\n\tremove(userId, callback) {\n\t\tif (this.queue[userId]) {\n\t\t\tclearTimeout(this.queue[userId]);\n\t\t}\n\t\tthis.queue[userId] = setTimeout(Meteor.bindEnvironment(() => {\n\t\t\tcallback();\n\n\t\t\tdelete this.users[userId];\n\t\t\tdelete this.queue[userId];\n\t\t}), actionTimeout);\n\t},\n\n\texists(userId) {\n\t\treturn !!this.users[userId];\n\t}\n};\n\nfunction runAgentLeaveAction(userId) {\n\tconst action = RocketChat.settings.get('Livechat_agent_leave_action');\n\tif (action === 'close') {\n\t\treturn RocketChat.Livechat.closeOpenChats(userId, RocketChat.settings.get('Livechat_agent_leave_comment'));\n\t} else if (action === 'forward') {\n\t\treturn RocketChat.Livechat.forwardOpenChats(userId);\n\t}\n}\n\nRocketChat.settings.get('Livechat_agent_leave_action_timeout', function(key, value) {\n\tactionTimeout = value * 1000;\n});\n\nRocketChat.settings.get('Livechat_agent_leave_action', function(key, value) {\n\tmonitorAgents = value;\n\tif (value !== 'none') {\n\t\tif (!agentsHandler) {\n\t\t\tagentsHandler = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t\t\t\tadded(id) {\n\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t},\n\t\t\t\tchanged(id, fields) {\n\t\t\t\t\tif (fields.statusLivechat && fields.statusLivechat === 'not-available') {\n\t\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tonlineAgents.add(id);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tremoved(id) {\n\t\t\t\t\tonlineAgents.remove(id, () => {\n\t\t\t\t\t\trunAgentLeaveAction(id);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t} else if (agentsHandler) {\n\t\tagentsHandler.stop();\n\t\tagentsHandler = null;\n\t}\n});\n\nUserPresenceMonitor.onSetUserStatus((user, status/*, statusConnection*/) => {\n\tif (!monitorAgents) {\n\t\treturn;\n\t}\n\tif (onlineAgents.exists(user._id)) {\n\t\tif (status === 'offline' || user.statusLivechat === 'not-available') {\n\t\t\tonlineAgents.remove(user._id, () => {\n\t\t\t\trunAgentLeaveAction(user._id);\n\t\t\t});\n\t\t}\n\t}\n});\n","import s from 'underscore.string';\n\nMeteor.publish('livechat:customFields', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:customFields' }));\n\t}\n\n\tif (s.trim(_id)) {\n\t\treturn RocketChat.models.LivechatCustomField.find({ _id });\n\t}\n\n\treturn RocketChat.models.LivechatCustomField.find();\n\n});\n","Meteor.publish('livechat:departmentAgents', function(departmentId) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:departmentAgents' }));\n\t}\n\n\treturn RocketChat.models.LivechatDepartmentAgents.find({ departmentId });\n});\n","Meteor.publish('livechat:externalMessages', function(roomId) {\n\treturn RocketChat.models.LivechatExternalMessage.findByRoomId(roomId);\n});\n","Meteor.publish('livechat:agents', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-agent').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('agentUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('agentUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('agentUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:appearance', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:appearance' }));\n\t}\n\n\tconst query = {\n\t\t_id: {\n\t\t\t$in: [\n\t\t\t\t'Livechat_title',\n\t\t\t\t'Livechat_title_color',\n\t\t\t\t'Livechat_show_agent_email',\n\t\t\t\t'Livechat_display_offline_form',\n\t\t\t\t'Livechat_offline_form_unavailable',\n\t\t\t\t'Livechat_offline_message',\n\t\t\t\t'Livechat_offline_success_message',\n\t\t\t\t'Livechat_offline_title',\n\t\t\t\t'Livechat_offline_title_color',\n\t\t\t\t'Livechat_offline_email',\n\t\t\t\t'Livechat_conversation_finished_message'\n\t\t\t]\n\t\t}\n\t};\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.find(query).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatAppearance', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatAppearance', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatAppearance', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:departments', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatDepartment.findByDepartmentId(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatDepartment.find();\n\t}\n\n});\n","Meteor.publish('livechat:integration', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:integration' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Settings.findByIds(['Livechat_webhookUrl', 'Livechat_secret_token', 'Livechat_webhook_on_close', 'Livechat_webhook_on_offline_msg', 'Livechat_webhook_on_visitor_message', 'Livechat_webhook_on_agent_message']).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatIntegration', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatIntegration', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatIntegration', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:managers', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:managers' }));\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.authz.getUsersInRole('livechat-manager').observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('managerUsers', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('managerUsers', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('managerUsers', id);\n\t\t}\n\t});\n\n\tself.ready();\n\n\tself.onStop(function() {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:rooms', function(filter = {}, offset = 0, limit = 20) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-rooms')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:rooms' }));\n\t}\n\n\tcheck(filter, {\n\t\tname: Match.Maybe(String), // room name to filter\n\t\tagent: Match.Maybe(String), // agent _id who is serving\n\t\tstatus: Match.Maybe(String), // either 'opened' or 'closed'\n\t\tfrom: Match.Maybe(Date),\n\t\tto: Match.Maybe(Date)\n\t});\n\n\tconst query = {};\n\tif (filter.name) {\n\t\tquery.label = new RegExp(filter.name, 'i');\n\t}\n\tif (filter.agent) {\n\t\tquery['servedBy._id'] = filter.agent;\n\t}\n\tif (filter.status) {\n\t\tif (filter.status === 'opened') {\n\t\t\tquery.open = true;\n\t\t} else {\n\t\t\tquery.open = { $exists: false };\n\t\t}\n\t}\n\tif (filter.from) {\n\t\tquery.ts = {\n\t\t\t$gte: filter.from\n\t\t};\n\t}\n\tif (filter.to) {\n\t\tfilter.to.setDate(filter.to.getDate() + 1);\n\t\tfilter.to.setSeconds(filter.to.getSeconds() - 1);\n\n\t\tif (!query.ts) {\n\t\t\tquery.ts = {};\n\t\t}\n\t\tquery.ts.$lte = filter.to;\n\t}\n\n\tconst self = this;\n\n\tconst handle = RocketChat.models.Rooms.findLivechat(query, offset, limit).observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatRoom', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatRoom', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatRoom', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\thandle.stop();\n\t});\n});\n","Meteor.publish('livechat:queue', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:queue' }));\n\t}\n\n\t// let sort = { count: 1, sort: 1, username: 1 };\n\t// let onlineUsers = {};\n\n\t// let handleUsers = RocketChat.models.Users.findOnlineAgents().observeChanges({\n\t// \tadded(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.added('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tchanged(id, fields) {\n\t// \t\tonlineUsers[fields.username] = 1;\n\t// \t\t// this.changed('livechatQueueUser', id, fields);\n\t// \t},\n\t// \tremoved(id) {\n\t// \t\tthis.removed('livechatQueueUser', id);\n\t// \t}\n\t// });\n\n\tconst self = this;\n\n\tconst handleDepts = RocketChat.models.LivechatDepartmentAgents.findUsersInQueue().observeChanges({\n\t\tadded(id, fields) {\n\t\t\tself.added('livechatQueueUser', id, fields);\n\t\t},\n\t\tchanged(id, fields) {\n\t\t\tself.changed('livechatQueueUser', id, fields);\n\t\t},\n\t\tremoved(id) {\n\t\t\tself.removed('livechatQueueUser', id);\n\t\t}\n\t});\n\n\tthis.ready();\n\n\tthis.onStop(() => {\n\t\t// handleUsers.stop();\n\t\thandleDepts.stop();\n\t});\n});\n","Meteor.publish('livechat:triggers', function(_id) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:triggers' }));\n\t}\n\n\tif (_id !== undefined) {\n\t\treturn RocketChat.models.LivechatTrigger.findById(_id);\n\t} else {\n\t\treturn RocketChat.models.LivechatTrigger.find();\n\t}\n});\n","Meteor.publish('livechat:visitorHistory', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tconst user = RocketChat.models.Users.findOneById(this.userId);\n\n\tif (room.usernames.indexOf(user.username) === -1) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorHistory' }));\n\t}\n\n\tif (room && room.v && room.v._id) {\n\t\t// CACHE: can we stop using publications here?\n\t\treturn RocketChat.models.Rooms.findByVisitorId(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","import LivechatVisitors from '../models/LivechatVisitors';\n\nMeteor.publish('livechat:visitorInfo', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorInfo' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v._id) {\n\t\treturn LivechatVisitors.findById(room.v._id);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:visitorPageVisited', function({ rid: roomId }) {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:visitorPageVisited' }));\n\t}\n\n\tconst room = RocketChat.models.Rooms.findOneById(roomId);\n\n\tif (room && room.v && room.v.token) {\n\t\treturn RocketChat.models.LivechatPageVisited.findByToken(room.v.token);\n\t} else {\n\t\treturn this.ready();\n\t}\n});\n","Meteor.publish('livechat:inquiry', function() {\n\tif (!this.userId) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:inquiry' }));\n\t}\n\n\tconst query = {\n\t\tagents: this.userId,\n\t\tstatus: 'open'\n\t};\n\n\treturn RocketChat.models.LivechatInquiry.find(query);\n});\n","Meteor.publish('livechat:officeHour', function() {\n\tif (!RocketChat.authz.hasPermission(this.userId, 'view-l-room')) {\n\t\treturn this.error(new Meteor.Error('error-not-authorized', 'Not authorized', { publish: 'livechat:agents' }));\n\t}\n\n\treturn RocketChat.models.LivechatOfficeHour.find();\n});\n","import '../imports/server/rest/departments.js';\nimport '../imports/server/rest/facebook.js';\nimport '../imports/server/rest/sms.js';\nimport '../imports/server/rest/users.js';\nimport '../imports/server/rest/messages.js';\nimport '../imports/server/rest/visitors.js';\n","import _ from 'underscore';\n\nMeteor.startup(() => {\n\tconst roles = _.pluck(RocketChat.models.Roles.find().fetch(), 'name');\n\tif (roles.indexOf('livechat-agent') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-agent');\n\t}\n\tif (roles.indexOf('livechat-manager') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-manager');\n\t}\n\tif (roles.indexOf('livechat-guest') === -1) {\n\t\tRocketChat.models.Roles.createOrUpdate('livechat-guest');\n\t}\n\tif (RocketChat.models && RocketChat.models.Permissions) {\n\t\tRocketChat.models.Permissions.createOrUpdate('view-l-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-manager', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('view-livechat-rooms', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-livechat-room', ['livechat-agent', 'livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('close-others-livechat-room', ['livechat-manager', 'admin']);\n\t\tRocketChat.models.Permissions.createOrUpdate('save-others-livechat-room-info', ['livechat-manager']);\n\t}\n});\n","RocketChat.MessageTypes.registerType({\n\tid: 'livechat_video_call',\n\tsystem: true,\n\tmessage: 'New_videocall_request'\n});\n\nRocketChat.actionLinks.register('createLivechatCall', function(message, params, instance) {\n\tif (Meteor.isClient) {\n\t\tinstance.tabBar.open('video');\n\t}\n});\n\nRocketChat.actionLinks.register('denyLivechatCall', function(message/*, params*/) {\n\tif (Meteor.isServer) {\n\t\tconst user = Meteor.user();\n\n\t\tRocketChat.models.Messages.createWithTypeRoomIdMessageAndUser('command', message.rid, 'endCall', user);\n\t\tRocketChat.Notifications.notifyRoom(message.rid, 'deleteMessage', { _id: message._id });\n\n\t\tconst language = user.language || RocketChat.settings.get('language') || 'en';\n\n\t\tRocketChat.Livechat.closeRoom({\n\t\t\tuser,\n\t\t\troom: RocketChat.models.Rooms.findOneById(message.rid),\n\t\t\tcomment: TAPi18n.__('Videocall_declined', { lng: language })\n\t\t});\n\t\tMeteor.defer(() => {\n\t\t\tRocketChat.models.Messages.setHiddenById(message._id);\n\t\t});\n\t}\n});\n","/* globals openRoom, LivechatInquiry */\nimport {RoomSettingsEnum, RoomTypeConfig, RoomTypeRouteConfig, UiTextContext} from 'meteor/rocketchat:lib';\n\nclass LivechatRoomRoute extends RoomTypeRouteConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tname: 'live',\n\t\t\tpath: '/live/:code(\\\\d+)'\n\t\t});\n\t}\n\n\taction(params) {\n\t\topenRoom('l', params.code);\n\t}\n\n\tlink(sub) {\n\t\treturn {\n\t\t\tcode: sub.code\n\t\t};\n\t}\n}\n\nclass LivechatRoomType extends RoomTypeConfig {\n\tconstructor() {\n\t\tsuper({\n\t\t\tidentifier: 'l',\n\t\t\torder: 5,\n\t\t\t// icon: 'livechat',\n\t\t\tlabel: 'Livechat',\n\t\t\troute: new LivechatRoomRoute()\n\t\t});\n\n\t\tthis.notSubscribedTpl = {\n\t\t\ttemplate: 'livechatNotSubscribed'\n\t\t};\n\t}\n\n\tfindRoom(identifier) {\n\t\treturn ChatRoom.findOne({code: parseInt(identifier)});\n\t}\n\n\troomName(roomData) {\n\t\tif (!roomData.name) {\n\t\t\treturn roomData.label;\n\t\t} else {\n\t\t\treturn roomData.name;\n\t\t}\n\t}\n\n\tcondition() {\n\t\treturn RocketChat.settings.get('Livechat_enabled') && RocketChat.authz.hasAllPermission('view-l-room');\n\t}\n\n\tcanSendMessage(roomId) {\n\t\tconst room = ChatRoom.findOne({_id: roomId}, {fields: {open: 1}});\n\t\treturn room && room.open === true;\n\t}\n\n\tgetUserStatus(roomId) {\n\t\tconst room = Session.get(`roomData${ roomId }`);\n\t\tif (room) {\n\t\t\treturn room.v && room.v.status;\n\t\t}\n\n\t\tconst inquiry = LivechatInquiry.findOne({ rid: roomId });\n\t\treturn inquiry && inquiry.v && inquiry.v.status;\n\t}\n\n\tallowRoomSettingChange(room, setting) {\n\t\tswitch (setting) {\n\t\t\tcase RoomSettingsEnum.JOIN_CODE:\n\t\t\t\treturn false;\n\t\t\tdefault:\n\t\t\t\treturn true;\n\t\t}\n\t}\n\n\tgetUiText(context) {\n\t\tswitch (context) {\n\t\t\tcase UiTextContext.HIDE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tcase UiTextContext.LEAVE_WARNING:\n\t\t\t\treturn 'Hide_Livechat_Warning';\n\t\t\tdefault:\n\t\t\t\treturn '';\n\t\t}\n\t}\n}\n\nRocketChat.roomTypes.add(new LivechatRoomType());\n","Meteor.startup(function() {\n\tRocketChat.settings.addGroup('Livechat');\n\n\tRocketChat.settings.add('Livechat_enabled', false, { type: 'boolean', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_title', 'Rocket.Chat', { type: 'string', group: 'Livechat', public: true });\n\tRocketChat.settings.add('Livechat_title_color', '#C1272D', { type: 'color', group: 'Livechat', public: true });\n\n\tRocketChat.settings.add('Livechat_display_offline_form', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Display_offline_form'\n\t});\n\n\tRocketChat.settings.add('Livechat_validate_offline_email', true, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Validate_email_address'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_form_unavailable', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_form_unavailable_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_offline_title', 'Leave a message', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Title'\n\t});\n\tRocketChat.settings.add('Livechat_offline_title_color', '#666666', {\n\t\ttype: 'color',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Color'\n\t});\n\tRocketChat.settings.add('Livechat_offline_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Instructions',\n\t\ti18nDescription: 'Instructions_to_your_visitor_fill_the_form_to_send_a_message'\n\t});\n\tRocketChat.settings.add('Livechat_offline_email', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Email_address_to_send_offline_messages',\n\t\tsection: 'Offline'\n\t});\n\tRocketChat.settings.add('Livechat_offline_success_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Offline',\n\t\ti18nLabel: 'Offline_success_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_registration_form', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_preregistration_form' });\n\tRocketChat.settings.add('Livechat_allow_switching_departments', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Allow_switching_departments' });\n\tRocketChat.settings.add('Livechat_show_agent_email', true, { type: 'boolean', group: 'Livechat', public: true, i18nLabel: 'Show_agent_email' });\n\n\tRocketChat.settings.add('Livechat_conversation_finished_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Conversation_finished_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_count', 1, { type: 'int', group: 'Livechat' });\n\n\tRocketChat.settings.add('Livechat_Room_Count', 1, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Livechat_room_count'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action', 'none', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tvalues: [\n\t\t\t{ key: 'none', i18nLabel: 'None' },\n\t\t\t{ key: 'forward', i18nLabel: 'Forward' },\n\t\t\t{ key: 'close', i18nLabel: 'Close' }\n\t\t],\n\t\ti18nLabel: 'How_to_handle_open_sessions_when_agent_goes_offline'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_action_timeout', 60, {\n\t\ttype: 'int',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: { $ne: 'none' } },\n\t\ti18nLabel: 'How_long_to_wait_after_agent_goes_offline',\n\t\ti18nDescription: 'Time_in_seconds'\n\t});\n\n\tRocketChat.settings.add('Livechat_agent_leave_comment', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tenableQuery: { _id: 'Livechat_agent_leave_action', value: 'close' },\n\t\ti18nLabel: 'Comment_to_leave_on_closing_session'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhookUrl', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Webhook_URL'\n\t});\n\n\tRocketChat.settings.add('Livechat_secret_token', false, {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Secret_token'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_close', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_chat_close'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_offline_msg', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_offline_messages'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_visitor_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_visitor_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_agent_message', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_agent_message'\n\t});\n\n\tRocketChat.settings.add('Livechat_webhook_on_capture', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Send_request_on_lead_capture'\n\t});\n\n\tRocketChat.settings.add('Livechat_lead_email_regex', '\\\\b[A-Z0-9._%+-]+@(?:[A-Z0-9-]+\\\\.)+[A-Z]{2,4}\\\\b', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Lead_capture_email_regex'\n\t});\n\n\tRocketChat.settings.add('Livechat_lead_phone_regex', '((?:\\\\([0-9]{1,3}\\\\)|[0-9]{2})[ \\\\-]*?[0-9]{4,5}(?:[\\\\-\\\\s\\\\_]{1,2})?[0-9]{4}(?:(?=[^0-9])|$)|[0-9]{4,5}(?:[\\\\-\\\\s\\\\_]{1,2})?[0-9]{4}(?:(?=[^0-9])|$))', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'CRM_Integration',\n\t\ti18nLabel: 'Lead_capture_phone_regex'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Key'\n\t});\n\n\tRocketChat.settings.add('Livechat_Knowledge_Apiai_Language', 'en', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Knowledge_Base',\n\t\tpublic: true,\n\t\ti18nLabel: 'Apiai_Language'\n\t});\n\n\tRocketChat.settings.add('Livechat_history_monitor_type', 'url', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\ti18nLabel: 'Monitor_history_for_changes_on',\n\t\tvalues: [\n\t\t\t{ key: 'url', i18nLabel: 'Page_URL' },\n\t\t\t{ key: 'title', i18nLabel: 'Page_title' }\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_office_hours', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Office_hours_enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_videocall_enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Videocall_enabled',\n\t\ti18nDescription: 'Beta_feature_Depends_on_Video_Conference_to_be_enabled',\n\t\tenableQuery: { _id: 'Jitsi_Enabled', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_enable_transcript', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_Enabled'\n\t});\n\n\tRocketChat.settings.add('Livechat_transcript_message', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Transcript_message',\n\t\tenableQuery: { _id: 'Livechat_enable_transcript', value: true }\n\t});\n\n\tRocketChat.settings.add('Livechat_open_inquiery_show_connecting', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_open_inquiery_show_connecting',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_AllowedDomainsList', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\ti18nLabel: 'Livechat_AllowedDomainsList',\n\t\ti18nDescription: 'Domains_allowed_to_embed_the_livechat_widget'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_Enabled', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Key', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours'\n\t});\n\n\tRocketChat.settings.add('Livechat_Facebook_API_Secret', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Facebook',\n\t\ti18nDescription: 'If_you_dont_have_one_send_an_email_to_omni_rocketchat_to_get_yours'\n\t});\n\n\tRocketChat.settings.add('Livechat_RDStation_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'RD Station',\n\t\ti18nLabel: 'RDStation_Token'\n\t});\n\n\tRocketChat.settings.add('Livechat_Routing_Method', 'Least_Amount', {\n\t\ttype: 'select',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Routing',\n\t\tvalues: [\n\t\t\t{key: 'External', i18nLabel: 'External_Service'},\n\t\t\t{key: 'Least_Amount', i18nLabel: 'Least_Amount'},\n\t\t\t{key: 'Guest_Pool', i18nLabel: 'Guest_Pool'}\n\t\t]\n\t});\n\n\tRocketChat.settings.add('Livechat_guest_pool_with_no_agents', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Accept_with_no_online_agents',\n\t\ti18nDescription: 'Accept_incoming_livechat_requests_even_if_there_are_no_online_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'Guest_Pool' }\n\t});\n\n\tRocketChat.settings.add('Livechat_show_queue_list_link', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'Livechat',\n\t\tpublic: true,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Show_queue_list_to_all_agents',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: { $ne: 'External' } }\n\t});\n\n\tRocketChat.settings.add('Livechat_External_Queue_URL', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'External_Queue_Service_URL',\n\t\ti18nDescription: 'For_more_details_please_check_our_docs',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'External' }\n\t});\n\n\tRocketChat.settings.add('Livechat_External_Queue_Token', '', {\n\t\ttype: 'string',\n\t\tgroup: 'Livechat',\n\t\tpublic: false,\n\t\tsection: 'Routing',\n\t\ti18nLabel: 'Secret_token',\n\t\tenableQuery: { _id: 'Livechat_Routing_Method', value: 'External' }\n\t});\n});\n","RocketChat.API.v1.addRoute('livechat/department', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tdepartments: RocketChat.models.LivechatDepartment.find().fetch()\n\t\t});\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tconst department = RocketChat.Livechat.saveDepartment(null, this.bodyParams.department, this.bodyParams.agents);\n\n\t\t\tif (department) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment,\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: department._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tRocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/department/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tput() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tdepartment: Object,\n\t\t\t\tagents: Array\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.saveDepartment(this.urlParams._id, this.bodyParams.department, this.bodyParams.agents)) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tdepartment: RocketChat.models.LivechatDepartment.findOneById(this.urlParams._id),\n\t\t\t\t\tagents: RocketChat.models.LivechatDepartmentAgents.find({ departmentId: this.urlParams._id }).fetch()\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tif (RocketChat.Livechat.removeDepartment(this.urlParams._id)) {\n\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n","import crypto from 'crypto';\n\nimport LivechatVisitors from '../../../server/models/LivechatVisitors';\n\n/**\n * @api {post} /livechat/facebook Send Facebook message\n * @apiName Facebook\n * @apiGroup Livechat\n *\n * @apiParam {String} mid Facebook message id\n * @apiParam {String} page Facebook pages id\n * @apiParam {String} token Facebook user's token\n * @apiParam {String} first_name Facebook user's first name\n * @apiParam {String} last_name Facebook user's last name\n * @apiParam {String} [text] Facebook message text\n * @apiParam {String} [attachments] Facebook message attachments\n */\nRocketChat.API.v1.addRoute('livechat/facebook', {\n\tpost() {\n\t\tif (!this.bodyParams.text && !this.bodyParams.attachments) {\n\t\t\treturn {\n\t\t\t\tsuccess: false\n\t\t\t};\n\t\t}\n\n\t\tif (!this.request.headers['x-hub-signature']) {\n\t\t\treturn {\n\t\t\t\tsuccess: false\n\t\t\t};\n\t\t}\n\n\t\tif (!RocketChat.settings.get('Livechat_Facebook_Enabled')) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Integration disabled'\n\t\t\t};\n\t\t}\n\n\t\t// validate if request come from omni\n\t\tconst signature = crypto.createHmac('sha1', RocketChat.settings.get('Livechat_Facebook_API_Secret')).update(JSON.stringify(this.request.body)).digest('hex');\n\t\tif (this.request.headers['x-hub-signature'] !== `sha1=${ signature }`) {\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: 'Invalid signature'\n\t\t\t};\n\t\t}\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: this.bodyParams.mid\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tfacebook: {\n\t\t\t\t\tpage: this.bodyParams.page\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\tlet visitor = LivechatVisitors.getVisitorByToken(this.bodyParams.token);\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.token).fetch();\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = this.bodyParams.token;\n\n\t\t\tconst userId = RocketChat.Livechat.registerGuest({\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tname: `${ this.bodyParams.first_name } ${ this.bodyParams.last_name }`\n\t\t\t});\n\n\t\t\tvisitor = RocketChat.models.Users.findOneById(userId);\n\t\t}\n\n\t\tsendMessage.message.msg = this.bodyParams.text;\n\t\tsendMessage.guest = visitor;\n\n\t\ttry {\n\t\t\treturn {\n\t\t\t\tsucess: true,\n\t\t\t\tmessage: RocketChat.Livechat.sendMessage(sendMessage)\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tconsole.error('Error using Facebook ->', e);\n\t\t}\n\t}\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/messages', { authRequired: true }, {\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tif (!this.bodyParams.visitor) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"visitor\" is required');\n\t\t}\n\t\tif (!this.bodyParams.visitor.token) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"visitor.token\" is required');\n\t\t}\n\t\tif (!this.bodyParams.messages) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is required');\n\t\t}\n\t\tif (!(this.bodyParams.messages instanceof Array)) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is not an array');\n\t\t}\n\t\tif (this.bodyParams.messages.length === 0) {\n\t\t\treturn RocketChat.API.v1.failure('Body param \"messages\" is empty');\n\t\t}\n\n\t\tconst visitorToken = this.bodyParams.visitor.token;\n\n\t\tlet visitor = LivechatVisitors.getVisitorByToken(visitorToken);\n\t\tlet rid;\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitorToken).fetch();\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\trid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\trid = Random.id();\n\t\t\t}\n\t\t} else {\n\t\t\trid = Random.id();\n\t\t\tconst visitorId = RocketChat.Livechat.registerGuest(this.bodyParams.visitor);\n\t\t\tvisitor = LivechatVisitors.findOneById(visitorId);\n\t\t}\n\n\t\tconst sentMessages = this.bodyParams.messages.map((message) => {\n\t\t\tconst sendMessage = {\n\t\t\t\tguest: visitor,\n\t\t\t\tmessage: {\n\t\t\t\t\t_id: Random.id(),\n\t\t\t\t\trid,\n\t\t\t\t\ttoken: visitorToken,\n\t\t\t\t\tmsg: message.msg\n\t\t\t\t}\n\t\t\t};\n\t\t\tconst sentMessage = RocketChat.Livechat.sendMessage(sendMessage);\n\t\t\treturn {\n\t\t\t\tusername: sentMessage.u.username,\n\t\t\t\tmsg: sentMessage.msg,\n\t\t\t\tts: sentMessage.ts\n\t\t\t};\n\t\t});\n\n\t\treturn RocketChat.API.v1.success({\n\t\t\tmessages: sentMessages\n\t\t});\n\t}\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/sms-incoming/:service', {\n\tpost() {\n\t\tconst SMSService = RocketChat.SMS.getService(this.urlParams.service);\n\n\t\tconst sms = SMSService.parse(this.bodyParams);\n\n\t\tlet visitor = LivechatVisitors.findOneVisitorByPhone(sms.from);\n\n\t\tconst sendMessage = {\n\t\t\tmessage: {\n\t\t\t\t_id: Random.id()\n\t\t\t},\n\t\t\troomInfo: {\n\t\t\t\tsms: {\n\t\t\t\t\tfrom: sms.to\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tif (visitor) {\n\t\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(visitor.token).fetch();\n\n\t\t\tif (rooms && rooms.length > 0) {\n\t\t\t\tsendMessage.message.rid = rooms[0]._id;\n\t\t\t} else {\n\t\t\t\tsendMessage.message.rid = Random.id();\n\t\t\t}\n\t\t\tsendMessage.message.token = visitor.token;\n\t\t} else {\n\t\t\tsendMessage.message.rid = Random.id();\n\t\t\tsendMessage.message.token = Random.id();\n\n\t\t\tconst visitorId = RocketChat.Livechat.registerGuest({\n\t\t\t\tusername: sms.from.replace(/[^0-9]/g, ''),\n\t\t\t\ttoken: sendMessage.message.token,\n\t\t\t\tphone: {\n\t\t\t\t\tnumber: sms.from\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tvisitor = LivechatVisitors.findOneById(visitorId);\n\t\t}\n\n\t\tsendMessage.message.msg = sms.body;\n\t\tsendMessage.guest = visitor;\n\n\t\tsendMessage.message.attachments = sms.media.map(curr => {\n\t\t\tconst attachment = {\n\t\t\t\tmessage_link: curr.url\n\t\t\t};\n\n\t\t\tconst contentType = curr.contentType;\n\t\t\tswitch (contentType.substr(0, contentType.indexOf('/'))) {\n\t\t\t\tcase 'image':\n\t\t\t\t\tattachment.image_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'video':\n\t\t\t\t\tattachment.video_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'audio':\n\t\t\t\t\tattachment.audio_url = curr.url;\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\treturn attachment;\n\t\t});\n\n\t\ttry {\n\t\t\tconst message = SMSService.response.call(this, RocketChat.Livechat.sendMessage(sendMessage));\n\n\t\t\tMeteor.defer(() => {\n\t\t\t\tif (sms.extra) {\n\t\t\t\t\tif (sms.extra.fromCountry) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'country', sms.extra.fromCountry);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromState) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'state', sms.extra.fromState);\n\t\t\t\t\t}\n\t\t\t\t\tif (sms.extra.fromCity) {\n\t\t\t\t\t\tMeteor.call('livechat:setCustomField', sendMessage.message.token, 'city', sms.extra.fromCity);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn message;\n\t\t} catch (e) {\n\t\t\treturn SMSService.error.call(this, e);\n\t\t}\n\t}\n});\n","import _ from 'underscore';\n\nRocketChat.API.v1.addRoute('livechat/users/:type', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tlet role;\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tconst users = RocketChat.authz.getUsersInRole(role);\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tusers: users.fetch().map(user => _.pick(user, '_id', 'username', 'name', 'status', 'statusLivechat'))\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tpost() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String\n\t\t\t});\n\n\t\t\tcheck(this.bodyParams, {\n\t\t\t\tusername: String\n\t\t\t});\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tconst user = RocketChat.Livechat.addAgent(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tconst user = RocketChat.Livechat.addManager(this.bodyParams.username);\n\t\t\t\tif (user) {\n\t\t\t\t\treturn RocketChat.API.v1.success({ user });\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/users/:type/:_id', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure('User not found');\n\t\t\t}\n\n\t\t\tlet role;\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\trole = 'livechat-agent';\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\trole = 'livechat-manager';\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\tif (user.roles.indexOf(role) !== -1) {\n\t\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\t\tuser: _.pick(user, '_id', 'username')\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.success({\n\t\t\t\tuser: null\n\t\t\t});\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t},\n\tdelete() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\ttry {\n\t\t\tcheck(this.urlParams, {\n\t\t\t\ttype: String,\n\t\t\t\t_id: String\n\t\t\t});\n\n\t\t\tconst user = RocketChat.models.Users.findOneById(this.urlParams._id);\n\n\t\t\tif (!user) {\n\t\t\t\treturn RocketChat.API.v1.failure();\n\t\t\t}\n\n\t\t\tif (this.urlParams.type === 'agent') {\n\t\t\t\tif (RocketChat.Livechat.removeAgent(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else if (this.urlParams.type === 'manager') {\n\t\t\t\tif (RocketChat.Livechat.removeManager(user.username)) {\n\t\t\t\t\treturn RocketChat.API.v1.success();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tthrow 'Invalid type';\n\t\t\t}\n\n\t\t\treturn RocketChat.API.v1.failure();\n\t\t} catch (e) {\n\t\t\treturn RocketChat.API.v1.failure(e.error);\n\t\t}\n\t}\n});\n","import LivechatVisitors from '../../../server/models/LivechatVisitors';\n\nRocketChat.API.v1.addRoute('livechat/visitor/:visitorToken', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst visitor = LivechatVisitors.getVisitorByToken(this.urlParams.visitorToken);\n\t\treturn RocketChat.API.v1.success(visitor);\n\t}\n});\n\nRocketChat.API.v1.addRoute('livechat/visitor/:visitorToken/room', { authRequired: true }, {\n\tget() {\n\t\tif (!RocketChat.authz.hasPermission(this.userId, 'view-livechat-manager')) {\n\t\t\treturn RocketChat.API.v1.unauthorized();\n\t\t}\n\n\t\tconst rooms = RocketChat.models.Rooms.findOpenByVisitorToken(this.urlParams.visitorToken, {\n\t\t\tfields: {\n\t\t\t\tname: 1,\n\t\t\t\tt: 1,\n\t\t\t\tcl: 1,\n\t\t\t\tu: 1,\n\t\t\t\tusernames: 1,\n\t\t\t\tservedBy: 1\n\t\t\t}\n\t\t}).fetch();\n\t\treturn RocketChat.API.v1.success({ rooms });\n\t}\n});\n"]}