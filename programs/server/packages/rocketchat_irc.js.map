{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:irc/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:irc/server/server.js"],"names":["Meteor","startup","RocketChat","settings","addGroup","add","type","i18nLabel","i18nDescription","alert","section","_","module","watch","require","default","v","net","Lru","IRC_AVAILABILITY","get","MESSAGE_CACHE_SIZE","ircReceiveMessageCache","ircSendMessageCache","IRC_PORT","IRC_HOST","ircClientMap","bind","f","g","bindEnvironment","self","args","apply","async","wrapAsync","IrcClient","constructor","loginReq","user","_id","ircPort","ircHost","msgBuf","isConnected","isDistroyed","socket","Socket","setNoDelay","setEncoding","setKeepAlive","connect","onConnect","onClose","onTimeout","onError","onReceiveRawMessage","on","isJoiningRoom","receiveMemberListBuf","pendingJoinRoomBuf","successLoginMessageRegex","RegExp","failedLoginMessageRegex","receiveMessageRegex","receiveMemberListRegex","endMemberListRegex","addMemberToRoomRegex","removeMemberFromRoomRegex","quitMemberRegex","loginCb","initRoomList","disconnect","destroy","console","log","yellow","username","write","name","messageBuf","forEach","msg","arguments","data","toString","split","line","trim","indexOf","replace","matchResult","exec","onReceiveMessage","onReceiveMemberList","onEndMemberList","onAddMemberToRoom","onRemoveMemberFromRoom","onQuitMember","onSuccessLoginMessage","onFailedLoginMessage","allowed","source","target","content","now","Date","timestamp","getTime","cacheKey","join","set","createUserWhenNotExist","room","models","Rooms","findOneByName","substring","createDirectRoomWhenNotExist","message","ts","sendMessage","roomName","members","concat","newMembers","findOneByNameAndType","oldMembers","usernames","appendMembers","difference","removeMembers","member","removeUsernamesById","addUsernamesById","shift","joinRoom","t","sendRawMessage","slice","push","u","roomsCursor","findByTypeContainingUsername","fields","rooms","fetch","leaveRoom","getMemberList","addUsernameByName","removeUsernameByName","removeUsernameFromAll","users","update","$set","status","findOne","call","email","pass","rid","sort","upsert","$setOnInsert","msgs","Subscriptions","$and","open","unread","userMentions","groupMentions","getByUid","uid","create","login","ircClient","IrcLoginer","IrcSender","findOneById","IrcRoomJoiner","IrcRoomLeaver","IrcLogoutCleanUper","callbacks","priority","LOW"],"mappings":"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","file":"/packages/rocketchat_irc.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.addGroup('IRC', function() {\n\n\t\t// Is this thing on?\n\t\tthis.add('IRC_Enabled', false, {\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Enabled',\n\t\t\ti18nDescription: 'IRC_Enabled',\n\t\t\talert: 'IRC Support is a work in progress. Use on a production system is not recommended at this time.'\n\t\t});\n\n\t\t// The IRC host server to talk to\n\t\tthis.add('IRC_Host', 'irc.freenode.net', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Host',\n\t\t\ti18nDescription: 'IRC_Hostname'\n\t\t});\n\n\t\t// The port to connect on the remote server\n\t\tthis.add('IRC_Port', 6667, {\n\t\t\ttype: 'int',\n\t\t\ti18nLabel: 'Port',\n\t\t\ti18nDescription: 'IRC_Port'\n\t\t});\n\n\t\t// Cache size of the messages we send the host IRC server\n\t\tthis.add('IRC_Message_Cache_Size', 200, {\n\t\t\ttype: 'int',\n\t\t\ti18nLabel: 'Message Cache Size',\n\t\t\ti18nDescription: 'IRC_Message_Cache_Size'\n\t\t});\n\n\t\t// Expandable box for modifying regular expressions for IRC interaction\n\t\tthis.section('Regular_Expressions', function() {\n\t\t\tthis.add('IRC_RegEx_successLogin', 'Welcome to the freenode Internet Relay Chat Network', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Login Successful',\n\t\t\t\ti18nDescription: 'IRC_Login_Success'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_failedLogin', 'You have not registered', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Login Failed',\n\t\t\t\ti18nDescription: 'IRC_Login_Fail'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_receiveMessage', '^:(\\S+)!~\\S+ PRIVMSG (\\S+) :(.+)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Private Message',\n\t\t\t\ti18nDescription: 'IRC_Private_Message'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_receiveMemberList', '^:\\S+ \\d+ \\S+ = #(\\S+) :(.*)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Channel User List Start',\n\t\t\t\ti18nDescription: 'IRC_Channel_Users'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_endMemberList', '^.+#(\\S+) :End of \\/NAMES list.$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Channel User List End',\n\t\t\t\ti18nDescription: 'IRC_Channel_Users_End'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_addMemberToRoom', '^:(\\S+)!~\\S+ JOIN #(\\S+)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Join Channel',\n\t\t\t\ti18nDescription: 'IRC_Channel_Join'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_removeMemberFromRoom', '^:(\\S+)!~\\S+ PART #(\\S+)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Leave Channel',\n\t\t\t\ti18nDescription: 'IRC_Channel_Leave'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_quitMember', '^:(\\S+)!~\\S+ QUIT .*$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Quit IRC Session',\n\t\t\t\ti18nDescription: 'IRC_Quit'\n\t\t\t});\n\t\t});\n\n\t});\n});\n","import _ from 'underscore';\nimport net from 'net';\nimport Lru from 'lru-cache';\n\n///////\n// Assign values\n\n//Package availability\nconst IRC_AVAILABILITY = RocketChat.settings.get('IRC_Enabled');\n\n// Cache prep\nconst MESSAGE_CACHE_SIZE = RocketChat.settings.get('IRC_Message_Cache_Size');\nconst ircReceiveMessageCache = Lru(MESSAGE_CACHE_SIZE);//eslint-disable-line\nconst ircSendMessageCache = Lru(MESSAGE_CACHE_SIZE);//eslint-disable-line\n\n// IRC server\nconst IRC_PORT = RocketChat.settings.get('IRC_Port');\nconst IRC_HOST = RocketChat.settings.get('IRC_Host');\n\nconst ircClientMap = {};\n\n//////\n// Core functionality\n\nconst bind = function(f) {\n\tconst g = Meteor.bindEnvironment((self, ...args) => f.apply(self, args));\n\treturn function(...args) { g(this, ...args); };\n};\n\nconst async = (f, ...args) => Meteor.wrapAsync(f)(...args);\n\nclass IrcClient {\n\tconstructor(loginReq) {\n\t\tthis.loginReq = loginReq;\n\n\t\tthis.user = this.loginReq.user;\n\t\tircClientMap[this.user._id] = this;\n\t\tthis.ircPort = IRC_PORT;\n\t\tthis.ircHost = IRC_HOST;\n\t\tthis.msgBuf = [];\n\n\t\tthis.isConnected = false;\n\t\tthis.isDistroyed = false;\n\t\tthis.socket = new net.Socket;\n\t\tthis.socket.setNoDelay;\n\t\tthis.socket.setEncoding('utf-8');\n\t\tthis.socket.setKeepAlive(true);\n\t\tthis.connect = this.connect.bind(this);\n\t\tthis.onConnect = this.onConnect.bind(this);\n\t\tthis.onConnect = bind(this.onConnect);\n\t\tthis.onClose = bind(this.onClose);\n\t\tthis.onTimeout = bind(this.onTimeout);\n\t\tthis.onError = bind(this.onError);\n\t\tthis.onReceiveRawMessage = this.onReceiveRawMessage.bind(this);\n\t\tthis.onReceiveRawMessage = bind(this.onReceiveRawMessage);\n\t\tthis.socket.on('data', this.onReceiveRawMessage);\n\t\tthis.socket.on('close', this.onClose);\n\t\tthis.socket.on('timeout', this.onTimeout);\n\t\tthis.socket.on('error', this.onError);\n\n\t\tthis.isJoiningRoom = false;\n\t\tthis.receiveMemberListBuf = {};\n\t\tthis.pendingJoinRoomBuf = [];\n\n\t\tthis.successLoginMessageRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_successLogin'));\n\t\tthis.failedLoginMessageRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_failedLogin'));\n\t\tthis.receiveMessageRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_receiveMessage'));\n\t\tthis.receiveMemberListRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_receiveMemberList'));\n\t\tthis.endMemberListRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_endMemberList'));\n\t\tthis.addMemberToRoomRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_addMemberToRoom'));\n\t\tthis.removeMemberFromRoomRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_removeMemberFromRoom'));\n\t\tthis.quitMemberRegex = new RegExp(RocketChat.settings.get('IRC_RegEx_quitMember'));\n\t}\n\n\tconnect(loginCb) {\n\t\tthis.loginCb = loginCb;\n\t\tthis.socket.connect(this.ircPort, this.ircHost, this.onConnect);\n\t\tthis.initRoomList();\n\t}\n\n\tdisconnect() {\n\t\tthis.isDistroyed = true;\n\t\tthis.socket.destroy();\n\t}\n\n\tonConnect() {\n\t\tconsole.log('[irc] onConnect -> '.yellow, this.user.username, 'connect success.');\n\t\tthis.socket.write(`NICK ${ this.user.username }\\r\\n`);\n\t\tthis.socket.write(`USER ${ this.user.username } 0 * :${ this.user.name }\\r\\n`);\n\t\t// message order could not make sure here\n\t\tthis.isConnected = true;\n\t\tconst messageBuf = this.msgBuf;\n\t\tmessageBuf.forEach(msg => this.socket.write(msg));\n\t}\n\n\tonClose() {\n\t\tconsole.log('[irc] onClose -> '.yellow, this.user.username, 'connection close.');\n\t\tthis.isConnected = false;\n\t\tif (this.isDistroyed) {\n\t\t\tdelete ircClientMap[this.user._id];\n\t\t} else {\n\t\t\tthis.connect();\n\t\t}\n\t}\n\n\tonTimeout() {\n\t\tconsole.log('[irc] onTimeout -> '.yellow, this.user.username, 'connection timeout.', arguments);\n\t}\n\n\tonError() {\n\t\tconsole.log('[irc] onError -> '.yellow, this.user.username, 'connection error.', arguments);\n\t}\n\n\tonReceiveRawMessage(data) {\n\t\tdata = data.toString().split('\\n');\n\n\t\tdata.forEach(line => {\n\t\t\tline = line.trim();\n\t\t\tconsole.log(`[${ this.ircHost }:${ this.ircPort }]:`, line);\n\n\t\t\t// Send heartbeat package to irc server\n\t\t\tif (line.indexOf('PING') === 0) {\n\t\t\t\tthis.socket.write(line.replace('PING :', 'PONG '));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet matchResult = this.receiveMessageRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onReceiveMessage(matchResult[1], matchResult[2], matchResult[3]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.receiveMemberListRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onReceiveMemberList(matchResult[1], matchResult[2].split(' '));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.endMemberListRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onEndMemberList(matchResult[1]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.addMemberToRoomRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onAddMemberToRoom(matchResult[1], matchResult[2]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.removeMemberFromRoomRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onRemoveMemberFromRoom(matchResult[1], matchResult[2]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.quitMemberRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onQuitMember(matchResult[1]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.successLoginMessageRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onSuccessLoginMessage();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.failedLoginMessageRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onFailedLoginMessage();\n\t\t\t\treturn;\n\t\t\t}\n\t\t});\n\t}\n\n\tonSuccessLoginMessage() {\n\t\tconsole.log('[irc] onSuccessLoginMessage -> '.yellow);\n\t\tif (this.loginCb) {\n\t\t\tthis.loginCb(null, this.loginReq);\n\t\t}\n\t}\n\n\tonFailedLoginMessage() {\n\t\tconsole.log('[irc] onFailedLoginMessage -> '.yellow);\n\t\tthis.loginReq.allowed = false;\n\t\tthis.disconnect();\n\t\tif (this.loginCb) {\n\t\t\tthis.loginCb(null, this.loginReq);\n\t\t}\n\t}\n\n\tonReceiveMessage(source, target, content) {\n\t\tconst now = new Date;\n\t\tconst timestamp = now.getTime();\n\t\tlet cacheKey = [source, target, content].join(',');\n\t\tconsole.log('[irc] ircSendMessageCache.get -> '.yellow, 'key:', cacheKey, 'value:', ircSendMessageCache.get(cacheKey), 'ts:', timestamp - 1000);\n\t\tif (ircSendMessageCache.get(cacheKey) > (timestamp - 1000)) {\n\t\t\treturn;\n\t\t} else {\n\t\t\tircSendMessageCache.set(cacheKey, timestamp);\n\t\t}\n\t\tconsole.log('[irc] onReceiveMessage -> '.yellow, 'source:', source, 'target:', target, 'content:', content);\n\t\tsource = this.createUserWhenNotExist(source);\n\t\tlet room;\n\t\tif (target[0] === '#') {\n\t\t\troom = RocketChat.models.Rooms.findOneByName(target.substring(1));\n\t\t} else {\n\t\t\troom = this.createDirectRoomWhenNotExist(source, this.user);\n\t\t}\n\t\tconst message = { msg: content, ts: now };\n\t\tcacheKey = `${ source.username }${ timestamp }`;\n\t\tircReceiveMessageCache.set(cacheKey, true);\n\t\tconsole.log('[irc] ircReceiveMessageCache.set -> '.yellow, 'key:', cacheKey);\n\t\tRocketChat.sendMessage(source, message, room);\n\t}\n\n\tonReceiveMemberList(roomName, members) {\n\t\tthis.receiveMemberListBuf[roomName] = this.receiveMemberListBuf[roomName].concat(members);\n\t}\n\n\tonEndMemberList(roomName) {\n\t\tconst newMembers = this.receiveMemberListBuf[roomName];\n\t\tconsole.log('[irc] onEndMemberList -> '.yellow, 'room:', roomName, 'members:', newMembers.join(','));\n\t\tconst room = RocketChat.models.Rooms.findOneByNameAndType(roomName, 'c');\n\t\tif (!room) {\n\t\t\treturn;\n\t\t}\n\t\tconst oldMembers = room.usernames;\n\t\tconst appendMembers = _.difference(newMembers, oldMembers);\n\t\tconst removeMembers = _.difference(oldMembers, newMembers);\n\t\tappendMembers.forEach(member => this.createUserWhenNotExist(member));\n\t\tRocketChat.models.Rooms.removeUsernamesById(room._id, removeMembers);\n\t\tRocketChat.models.Rooms.addUsernamesById(room._id, appendMembers);\n\n\t\tthis.isJoiningRoom = false;\n\t\troomName = this.pendingJoinRoomBuf.shift();\n\t\tif (roomName) {\n\t\t\tthis.joinRoom({\n\t\t\t\tt: 'c',\n\t\t\t\tname: roomName\n\t\t\t});\n\t\t}\n\t}\n\n\tsendRawMessage(msg) {\n\t\tconsole.log('[irc] sendRawMessage -> '.yellow, msg.slice(0, -2));\n\t\tif (this.isConnected) {\n\t\t\tthis.socket.write(msg);\n\t\t} else {\n\t\t\tthis.msgBuf.push(msg);\n\t\t}\n\t}\n\n\tsendMessage(room, message) {\n\t\tconsole.log('[irc] sendMessage -> '.yellow, 'userName:', message.u.username);\n\t\tlet target = '';\n\t\tif (room.t === 'c') {\n\t\t\ttarget = `#${ room.name }`;\n\t\t} else if (room.t === 'd') {\n\t\t\tconst usernames = room.usernames;\n\t\t\tusernames.forEach(name => {\n\t\t\t\tif (message.u.username !== name) {\n\t\t\t\t\ttarget = name;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tconst cacheKey = [this.user.username, target, message.msg].join(',');\n\t\tconsole.log('[irc] ircSendMessageCache.set -> '.yellow, 'key:', cacheKey, 'ts:', message.ts.getTime());\n\t\tircSendMessageCache.set(cacheKey, message.ts.getTime());\n\t\tconst msg = `PRIVMSG ${ target } :${ message.msg }\\r\\n`;\n\t\tthis.sendRawMessage(msg);\n\t}\n\n\tinitRoomList() {\n\t\tconst roomsCursor = RocketChat.models.Rooms.findByTypeContainingUsername('c', this.user.username, { fields: { name: 1, t: 1 }});\n\t\tconst rooms = roomsCursor.fetch();\n\t\trooms.forEach(room => this.joinRoom(room));\n\t}\n\n\tjoinRoom(room) {\n\t\tif (room.t !== 'c' || room.name === 'general') {\n\t\t\treturn;\n\t\t}\n\t\tif (this.isJoiningRoom) {\n\t\t\treturn this.pendingJoinRoomBuf.push(room.name);\n\t\t}\n\t\tconsole.log('[irc] joinRoom -> '.yellow, 'roomName:', room.name, 'pendingJoinRoomBuf:', this.pendingJoinRoomBuf.join(','));\n\t\tconst msg = `JOIN #${ room.name }\\r\\n`;\n\t\tthis.receiveMemberListBuf[room.name] = [];\n\t\tthis.sendRawMessage(msg);\n\t\tthis.isJoiningRoom = true;\n\t}\n\n\tleaveRoom(room) {\n\t\tif (room.t !== 'c') {\n\t\t\treturn;\n\t\t}\n\t\tconst msg = `PART #${ room.name }\\r\\n`;\n\t\tthis.sendRawMessage(msg);\n\t}\n\n\tgetMemberList(room) {\n\t\tif (room.t !== 'c') {\n\t\t\treturn;\n\t\t}\n\t\tconst msg = `NAMES #${ room.name }\\r\\n`;\n\t\tthis.receiveMemberListBuf[room.name] = [];\n\t\tthis.sendRawMessage(msg);\n\t}\n\n\tonAddMemberToRoom(member, roomName) {\n\t\tif (this.user.username === member) {\n\t\t\treturn;\n\t\t}\n\t\tconsole.log('[irc] onAddMemberToRoom -> '.yellow, 'roomName:', roomName, 'member:', member);\n\t\tthis.createUserWhenNotExist(member);\n\t\tRocketChat.models.Rooms.addUsernameByName(roomName, member);\n\t}\n\n\tonRemoveMemberFromRoom(member, roomName) {\n\t\tconsole.log('[irc] onRemoveMemberFromRoom -> '.yellow, 'roomName:', roomName, 'member:', member);\n\t\tRocketChat.models.Rooms.removeUsernameByName(roomName, member);\n\t}\n\n\tonQuitMember(member) {\n\t\tconsole.log('[irc] onQuitMember ->'.yellow, 'username:', member);\n\t\tRocketChat.models.Rooms.removeUsernameFromAll(member);\n\t\tMeteor.users.update({ name: member }, { $set: { status: 'offline' }});\n\t}\n\n\tcreateUserWhenNotExist(name) {\n\t\tconst user = Meteor.users.findOne({ name });\n\t\tif (user) {\n\t\t\treturn user;\n\t\t}\n\t\tconsole.log('[irc] createNotExistUser ->'.yellow, 'userName:', name);\n\t\tMeteor.call('registerUser', {\n\t\t\temail: `${ name }@rocketchat.org`,\n\t\t\tpass: 'rocketchat',\n\t\t\tname\n\t\t});\n\t\tMeteor.users.update({ name }, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'online',\n\t\t\t\tusername: name\n\t\t\t}\n\t\t});\n\t\treturn Meteor.users.findOne({ name });\n\t}\n\n\tcreateDirectRoomWhenNotExist(source, target) {\n\t\tconsole.log('[irc] createDirectRoomWhenNotExist -> '.yellow, 'source:', source, 'target:', target);\n\t\tconst rid = [source._id, target._id].sort().join('');\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.upsert({ _id: rid}, {\n\t\t\t$set: {\n\t\t\t\tusernames: [source.username, target.username]\n\t\t\t},\n\t\t\t$setOnInsert: {\n\t\t\t\tt: 'd',\n\t\t\t\tmsgs: 0,\n\t\t\t\tts: now\n\t\t\t}\n\t\t});\n\t\tRocketChat.models.Subscriptions.upsert({ rid, $and: [{ 'u._id': target._id}]}, {\n\t\t\t$setOnInsert: {\n\t\t\t\tname: source.username,\n\t\t\t\tt: 'd',\n\t\t\t\topen: false,\n\t\t\t\talert: false,\n\t\t\t\tunread: 0,\n\t\t\t\tuserMentions: 0,\n\t\t\t\tgroupMentions: 0,\n\t\t\t\tu: { _id: target._id, username: target.username }}\n\t\t});\n\t\treturn { t: 'd', _id: rid };\n\t}\n}\n\nIrcClient.getByUid = function(uid) {\n\treturn ircClientMap[uid];\n};\n\nIrcClient.create = function(login) {\n\tif (login.user == null) {\n\t\treturn login;\n\t}\n\tif (!(login.user._id in ircClientMap)) {\n\t\tconst ircClient = new IrcClient(login);\n\t\treturn async(ircClient.connect);\n\t}\n\treturn login;\n};\n\nfunction IrcLoginer(login) {\n\tconsole.log('[irc] validateLogin -> '.yellow, login);\n\treturn IrcClient.create(login);\n}\n\n\nfunction IrcSender(message) {\n\tconst name = message.u.username;\n\tconst timestamp = message.ts.getTime();\n\tconst cacheKey = `${ name }${ timestamp }`;\n\tif (ircReceiveMessageCache.get(cacheKey)) {\n\t\treturn message;\n\t}\n\tconst room = RocketChat.models.Rooms.findOneById(message.rid, { fields: { name: 1, usernames: 1, t: 1 }});\n\tconst ircClient = IrcClient.getByUid(message.u._id);\n\tircClient.sendMessage(room, message);\n\treturn message;\n}\n\n\nfunction IrcRoomJoiner(user, room) {\n\tconst ircClient = IrcClient.getByUid(user._id);\n\tircClient.joinRoom(room);\n\treturn room;\n}\n\n\nfunction IrcRoomLeaver(user, room) {\n\tconst ircClient = IrcClient.getByUid(user._id);\n\tircClient.leaveRoom(room);\n\treturn room;\n}\n\nfunction IrcLogoutCleanUper(user) {\n\tconst ircClient = IrcClient.getByUid(user._id);\n\tircClient.disconnect();\n\treturn user;\n}\n\n//////\n// Make magic happen\n\n// Only proceed if the package has been enabled\nif (IRC_AVAILABILITY === true) {\n\tRocketChat.callbacks.add('beforeValidateLogin', IrcLoginer, RocketChat.callbacks.priority.LOW, 'irc-loginer');\n\tRocketChat.callbacks.add('beforeSaveMessage', IrcSender, RocketChat.callbacks.priority.LOW, 'irc-sender');\n\tRocketChat.callbacks.add('beforeJoinRoom', IrcRoomJoiner, RocketChat.callbacks.priority.LOW, 'irc-room-joiner');\n\tRocketChat.callbacks.add('beforeCreateChannel', IrcRoomJoiner, RocketChat.callbacks.priority.LOW, 'irc-room-joiner-create-channel');\n\tRocketChat.callbacks.add('beforeLeaveRoom', IrcRoomLeaver, RocketChat.callbacks.priority.LOW, 'irc-room-leaver');\n\tRocketChat.callbacks.add('afterLogoutCleanUp', IrcLogoutCleanUper, RocketChat.callbacks.priority.LOW, 'irc-clean-up');\n}\n"]}